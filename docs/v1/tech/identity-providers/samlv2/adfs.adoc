---
layout: doc
title: SAML v2 with ADFS
description: Configure SAML v2 for Active Directory Federation Services (ADFS)
---

:sectnumlevels: 0

////
TODO Verify screenshot now that we have 'debug' flag
////

== Configure SAML v2 for Active Directory Federation Services (ADFS)

This page will guide you in configuring SAML v2 for Active Directory Federation Services (ADFS), enabling a "Login with ADFS" button in your FusionAuth login flow.

image::samlv2-adfs-login.png[SAML v2 Login,width=1200,role=shadowed]

== Import ADFS Certificate into FusionAuth

First, import the certificate used by ADFS for signing into FusionAuth.  This certificate can be obtained from your ADFS administrator and can also be retrieved from the ADFS metadata endpoint `<ADFS FQDN>/FederationMetadata/2007-06/FederationMetadata.xml` (look for the `<X509Certificate>` tag within `<ds:Signature>`).  Microsoft relays this certificate as a base64-encoded string.

Using Keymaster in the FusionAuth admin panel, the certificate can be imported as a base64-encoded string.  Leave the  [field]#Key identifier# property blank, as this will be autogenerated from thumbprint the existing certificate.

image::samlv2-adfs-import-certificate.png[ADFS Import Certificate,width=1200,role=shadowed]

== Create a SAML v2 Identity Provider

To create an Identity Provider follow the steps documented in the link:../samlv2/overview[SAML v2 Overview] with the following specifics for configuring ADFS.

The IdP endpoint of ADFS is noted in the ADFS management console under [breadcrumb]#AD FS# icon:chevron-right[role=breadcrumb] [breadcrumb]#Service# icon:chevron-right[role=breadcrumb] [breadcrumb]#Endpoints#.  By default the URL is ```<ADFS FQDN>/adfs/ls```.

Enable the [field]#Debug# toggle to receive debug logs in the FusionAuth Event Log.

Enable the [field]#Use NameId for email# toggle.

Set the [field]#Verification key# to the ADFS certificate we imported in the previous step.

image::samlv2-adfs-add.png[ADFS Import Certificate,width=1200,role=shadowed]

== Add Relying Party Trust

=== Note the FusionAuth Issuer

View the integration details of the newly created SAML v2 Identity provider by clicking the icon:search[role=breadcrumb] search icon on the IdP card.

Copy the value noted in the [field]#Issuer# field to be used in the following step.

image::samlv2-adfs-issuer.png[ADFS Issuer,width=1200,role=shadowed]

=== Create a Relying Party Trust

////
TODO Update screenshot, the view dialog now has complete integration details and we can discuss the endpoints documented
     - Should we scale the screen shots? Or if we keep what is here - it is using a CSS shadow and needs some additional top and bottom margins
       so it doesn't overrun the text with the shadow.
TODO - AD screenshots should show a real address (not Ngrok) and Screenshots of FA should be using https://local.fusionauth.io
     - AD screenshots should perhaps be re-captured to be a bit cleaner and consistent sizing?
////

In the ADFS management console under [breadcrumb]#AD FS# icon:chevron-right[role=breadcrumb] [breadcrumb]#Trust Relationships# icon:chevron-right[role=breadcrumb] [breadcrumb]#Relying Party Trusts# icon:chevron-right[role=breadcrumb] [breadcrumb]#Add Relying Party Trust...# to start the `Add Relying Party Trust Wizard`.

In the second dialog of the wizard, input the value previously obtained [field]#Issuer# value into the `Federation metadata address (host name of URL)` field.

For all of the remaining steps in the wizard you can accept the defaults and click `Next >`.

image::samlv2-adfs-relying-party-wizard.png[ADFS Issuer,width=800,role=box-shadow]

== Add Claim Rules

In the ADFS management navigate [breadcrumb]#AD FS# icon:chevron-right[role=breadcrumb] [breadcrumb]#Trust Relationships# icon:chevron-right[role=breadcrumb] [breadcrumb]#[Relying Party Trusts# icon:chevron-right[role=breadcrumb] [breadcrumb]#[trust created in the previous step]# icon:chevron-right[role=breadcrumb] [breadcrumb]#Edit Claim Rules...# to create a new claim rule for your newly created relying party trust.

First add a claim rule to map the LDAP `E-Mail Addresses` attribute to an `E-Mail` attribute.  Add a new claim rule with the `Claim Rule Template` field set to "Send LDAP Attributes as Claims" and click `Next >`.

image::samlv2-adfs-claim-rule-email-1.png[Send LDAP attributes as claims,width=800,role=box-shadow]

Add a name for the claim rule in the `Claim rule name` field.

Set the `Attribute Store` field to "Active Directory", the `LDAP Attribute` field to "E-Mail Addresses" and the `Outgoing Claim Type` attribute to "E-Mail Address", then click `Finish`.

image::samlv2-adfs-claim-rule-email-2.png[Map E-Mail attribute,width=800,role=box-shadow]

Next add a claim rule to map the `E-Mail Address` attribute to a `Name ID` attribute.  Add a new claim rule with the `Claim Rule Template` field set to "Transform an Incoming Claim" and click `Next >`.

image::samlv2-adfs-claim-rule-nameid-1.png[Map E-Mail attribute,width=800,role=box-shadow]

Add a name for the claim rule in the `Claim rule name` field.

Set the `Incoming claim type` field to "E-Mail Address", the `Outgoing claim type` field to "Name ID", the `Outgoing name ID format` field to "Email", select the `Pass through all valid claims` radio button, and click `Finish`.

image::samlv2-adfs-claim-rule-nameid-2.png[Map E-Mail attribute,width=800,role=box-shadow]

The finalized claim rules should look similar to the following screenshot.

image::samlv2-adfs-claim-rule-complete.png[Map E-Mail attribute,width=550,role=box-shadow]

That's it, you can now use the `Login with ADFS` button on the login page to login using ADFS as an identity provider.