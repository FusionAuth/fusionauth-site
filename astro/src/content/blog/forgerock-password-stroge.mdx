---
publish_date: 2024-02-15
title: Understanding the Forgerock Password Storage Scheme
description: Understand how Forgerock stores user passwords.
authors: Mark Robustelli
image: /img/blogs/forgerock-password-storage/forgerock-password-storage.png
categories: Education
tags: passwords, migration, hashing, Forgerock, password hash
excerpt_separator: "{/* more */}"
---
import {RemoteCode} from '@fusionauth/astro-components';
import Aside from '../../components/Aside.astro';

You have been charged with migrating your authentication system from Forgerock to another platform. How do you move the users without knowing the users' passwords or making them reset their passwords in the new system?
{/* more */}

The short answer is "move the password hash". In this post you will learn what a password hash is, how Forgerock stores them and how to use this to transparently and safely migrate your users' credentials.

## What Is Password Hashing?

Password hashing might be a scary phrase. It sounds complicated and high-tech. In truth, the nitty-gritty details can be. 

But don't fret. The good news is that for the purposes of this post you can think of it in simple terms. Password hashing is taking a string of characters, applying an algorithm (or function), and coming up with a different set of characters. 

The algorithm chosen to hash the characters determines the difficulty of getting the original password from the hash. Because you want to store passwords safely, the ideal algorithm makes it simple to go from password to hash, and impossible to go from hash to password.

Thankfully, many smart people have figured out a way to hash passwords so it is easy to reproduce a hash if you know the source, but very difficult to get to the original set of characters from the hashed characters. You may have heard of some of these hashing functions such as:

 * SHA-256
 * PBKDF2
 * Bcrypt

There are two more bits about hashing that you will need to know related to this article. One is the idea of salt and the other is the idea of iterations.

<Aside type="note">
If you understand the concept of password salt and iterations, feel free to skip to the next section.
</Aside>

### Salt

You can think of salt as random characters sprinkled on the password before it is run through the algorithm. This is done so that two users using the same password will still have different hashes.

![Add salt to password.](/img/blogs/forgerock-password-storage/password-salt.jpg)

Example:

The hashing function for this example will be to use the next letter of the existing letter. The letter '**a**' will become 'b', the letter '**b**' will become 'c', and so on.

User 'john' chooses '**cat**' for his password and user 'sally' also chooses '**cat**' for her password.

The hash for both of their passwords would become: '*dbu*', ('**c**' becomes '*d*', '**a**' becomes '*b*', '**t**' becomes '*u*').

If anyone got ahold of the hashes, they would know the users shared the same password and easily see all others that use that password.

By adding salt to each of their passwords this can be avoided.

User 'john' is issued salt '*orj*' and 'sally' is issued '*nei*'.

By adding the salt to every other letter we can change their password hash.

John's salted password becomes '**c***o***a***r***t***j*' and Sally's becomes '**c***n***a***e***t***i*'.

Using the next letter algorithm on the salted passwords, the hashes become '*dpbsuk*' and '*dobfuj*', respectively.

You can now see that even though they have the same password, the stored hash will be different.

This is a very simplified example. The next letter hashing algorithm is not sophisticated and has many issues such as you can see the passwords would start with the same letter and you can find the hashed letters for 'cat' in both. The hashing functions mentioned above solve these problems and many others making the one way hash secure.

### Iterations

An iteration is just a repetition of the process. In our example above, one iteration of our hashing function with the password '**cat**' produced '*dbu*'. If you were to perform a second iteration, the hash would become '*ecv*', ('**d**' becomes '*e*', '**b**' becomes '*c*', '**u**' becomes '*v*'). You can do this as many times as necessary to fit your requirements. It is important to note the number of times this happens with a hash so that you can be sure to compare the correct iteration of the password hash to the one stored.

## How Do I Use It To Migrate Users

Secure authorization systems will not store user passwords. They will only store the hash. If they used a salted hash, they will likely store the salt as well. By moving the hash, the salt and the number of iterations to another system, you should be able to derive the same hash with the given salt if you are using the same hashing algorithm. When a user enters their password on your site, apply the salt and apply the same hashing algorithm the same number of times that was used in the old system. Then compare the hash you get with the stored hash. They will match if the same password was used. This is how you are able to migrate a user without ever needing to know the actual password. 

## How Do I Decipher Forgerock's Hash

Password hash and salt storage will vary between implementations. Hashing algorithms will vary as well and could even vary between users. By default, Forgerock uses the PBKDF2-HMAC-SHA256 encryption with their Cloud Development Kit so that will be used in this article.

<Aside type="note">
If your implementation is using a different hashing function, Forgerock has more details on their other password storage schemes [here](https://backstage.forgerock.com/knowledge/kb/article/a44757687).
</Aside>

Forgerock stores that hash in the following way: 

"&#123;PBKDF2-HMAC-SHA256&#125;"&lt;iterations&gt;":" base64(&lt;digest&gt; &lt;salt&gt;) where:

- &#123;PBKDF2-HMAC-SHA256&#125; is a literal describing the hashing function used.
- &lt;iterations&gt; is the number of times the algorithm is applied
- ":" is a literal separator
- base64(&lt;digest&gt; &lt;salt&gt;) indicates that the password hash and salt are stored together and base64 encoded

In the example:

&#123;PBKDF2-HMAC-SHA256&#125;10:8c7nLGEIXeZf45YQ92A2MD+v8olvKKl6iWXGQZoluJ/awqZnHwFvslIOx7xOZ9AV
  
  - PBKDF2-HMAC-SHA256 is the hashing function used
  - 10 is the number of iterations
  - 8c7nLGEIXeZf45YQ92A2MD+v8olvKKl6iWXGQZoluJ/awqZnHwFvslIOx7xOZ9AV is the Base64 encoded password hash and salt

So how do you decipher the password hash from the salt? The first thing you need to do is Base64 decode the string. This give you:

 ñ�￹ç,a￹]æ_ã�￹÷`60?¯ò�￹o(©z�￹e�￹A�￹%¸�￹�￹�￹¦g￹o²R￹�￹¼Ng�

 ![What the heck is that?](/img/blogs/forgerock-password-storage/what-the-heck.jpg)
 
 I know, not very human readable. From here, you need to write some code to get the values you are looking for. Below is an excerpt from the script used in FusionAuth's [Migration From Forgerock](/docs/lifecycle/migrate-users/bulk/forgerock) guide.

<RemoteCode url="https://raw.githubusercontent.com/FusionAuth/fusionauth-import-scripts/master/forgerock/import.rb" lang="ruby" tags="ForgerockPasswordHash" />

This is Ruby code, but you can implement it in the language of your choice. 

Breaking the code down, you can see that it starts by accepting the 'hashstring' as an argument. In this case, the 'hashstring' will look like our example from above, &#123;PBKDF2-HMAC-SHA256&#125;10:8c7nLGEIXeZf45YQ92A2MD+v8olvKKl6iWXGQZoluJ/awqZnHwFvslIOx7xOZ9AV. 

Next, it uses regular expressions to extract each part of the stored password information. At this point you should have the encryption scheme (PBKDF2-HMAC-SHA256) and number of iterations (10) in plain text. 

It then takes the base64(&lt;digest&gt; &lt;salt&gt;) part of the stored information, `password_salt_hash`, and decodes it from Base64. Once the decoding is done, it will then take the appropriate number of bytes of the decoded string and put it into variables, `hash_bytes` and `salt_bytes`. From there, it re-encodes those bytes back to Base64.

You now have the four parts of information (the hashing algorithm used, the password hash, the number of iterations, and the salt) you need to move the password from Forgerock to another system. Import this information into your new system and the next time the user enters their password from the old system, the hashes will match.


