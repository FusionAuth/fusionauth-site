---
title: Express.js API
description: Quickstart integration of a JavaScript Express.js API application action as a resource server with FusionAuth
navcategory: getting-started
prerequisites: Node.js version 18
section: api
technology: Express.js
language: JavaScript
icon: /img/icons/javascript.svg
faIcon: fa-node-js
color: green
cta: EmailListCTA
---
import Aside from '../../components/Aside.astro';
import Diagram from '../../diagrams/quickstarts/resource-server.astro';
import RemoteCode from '../../components/RemoteCode.astro';

In this tutorial, you are going to learn how to integrate a {frontmatter.language} {frontmatter.technology} resource server with FusionAuth. You will protect an API resource from unauthorized usage. You'll be building it for [ChangeBank](https://www.youtube.com/watch?v=CXDxNCzUspM), a global leader in converting dollars into coins.

The docker compose file and source code for a complete application are available at https://github.com/FusionAuth/fusionauth-quickstart-javascript-express-api.

## Prerequisites

For this quickstart, you'll need:

* [Node 18](https://nodejs.org/en/download) or later.
* [Docker](https://www.docker.com), which is the quickest way to start FusionAuth. (There are [other ways](/docs/v1/tech/installation-guide/)).
* [curl](https://curl.se/download.html), command line tool and library for transferring data with URLs.

## General Architecture

A client wants access to an API resource at `/resource`. However, it is denied this resource until it acquires an access token from FusionAuth.

<Diagram />

While the access token is acquired via the Login API above, this is for simplicity of illustration. The token can be, and typically is, acquired through one of the [OAuth grants](/docs/v1/tech/oauth/).

## Getting Started

In this section, you’ll get FusionAuth up and running and create a resource server which will serve the API.

### Clone The Code

First off, grab the code from the repository and change into that directory.

```
git clone https://github.com/FusionAuth/fusionauth-quickstart-javascript-express-api.git
cd fusionauth-quickstart-javascript-express-api
```

All shell commands in this guide can be entered in a terminal in this folder. On Windows, you need to replace forward slashes with backslashes in paths.

All the files you'll create in this guide already exist in the `complete-application` subfolder, if you prefer to copy them.

### Run FusionAuth Via Docker

You'll find a Docker Compose file `docker-compose.yml` and an environment variables configuration file `.env` in the root folder of the repository.

Assuming you have Docker installed on your machine, you can start FusionAuth on your machine with the following.

```
docker compose up -d
```

This will start three containers, one each for FusionAuth, Postgres, and Elasticsearch.

Here you are using a bootstrapping feature of FusionAuth, called [Kickstart](/docs/v1/tech/installation-guide/kickstart). When FusionAuth starts for the first time, it will look at the `kickstart/kickstart.json` file and configure FusionAuth to your specified state.

<Aside type="note">
If you ever want to reset the FusionAuth system, delete the volumes created by `docker compose` by executing `docker compose down -v`, then rerun `docker compose up -d`.
</Aside>

FusionAuth will be initially configured with these settings:

* Your client Id is: `e9fdb985-9173-4e01-9d73-ac2d60d1dc8e`.
* Your client secret is: `super-secret-secret-that-should-be-regenerated-for-production`
* Your example teller username is `teller@example.com` and your password is `password`. They have the role `teller`.
* Your example customer username is `customer@example.com` and your password is `password`. They have the role `customer`.
* Your admin username is `admin@example.com` and your password is `password`.
* Your fusionAuthBaseUrl is 'http://localhost:9011/'.

You can log into the [FusionAuth admin UI](http://localhost:9011/admin) and look around if you want, but with Docker/Kickstart you don't need to.

<Aside type="caution">
  The `.env` and `kickstart.json` files contain passwords. In a real application, always add these files to your `.gitignore` file and never commit secrets to version control.
</Aside>

### Create A Basic {frontmatter.technology} Application

Now you are going to create an {frontmatter.technology} API application. While this section builds a simple API, you can use the same configuration to integrate an existing API with FusionAuth.

We are going to be building an API backend for a banking application called ChangeBank. This API will have two endpoints:
- `make-change`: This endpoint will allow you to call GET with a `total` amount and receive a response indicating how many nickels and pennies are needed to make change. Valid roles are `customer` and `teller`.
- `panic`: Tellers may call this POST endpoint to call the police in case of an incident. The only valid role is `teller`.

Both endpoints will be protected such that a valid JSON web token (JWT) will be required in a cookie in order to be accessed. Additionally, the JWT must have a `roles` claim containing the appropriate role to use the endpoint.

Create the starter app called `mysite` for this API.

```shell
npx express-generator@latest mysite --no-view
cd mysite
npm install
npm audit fix --force # run this only if npm reports security vulnerabilities
npm install dotenv # to read your .env files with passwords
npm install jose # to validate JWT authenticity
```

Now create the `.env` file in your `mysite` folder and add the following to it (note that this is a different environment file to the one in the root folder used by Docker for FusionAuth).

<RemoteCode url="https://raw.githubusercontent.com/FusionAuth/fusionauth-quickstart-javascript-express-api/main/complete-application/.env"
 lang="shell" />

### Preliminary Setup

Before you configure authentication, you need to change the default file created by Express.

Add the following lines in `app.js` just above `app.use('/', indexRouter);`.

<RemoteCode url="https://raw.githubusercontent.com/FusionAuth/fusionauth-quickstart-javascript-express-api/main/complete-application/app.js"
 lang="javascript" tags="verifyToken" />

This adds an authentication check to every call made to {frontmatter.technology}.

## Authentication

The line you added above, `const verifyJWT = require('./services/verifyJWT');`, imports middleware to add authentication to the app. Let's create that file now.

First create the `services` directory under `mysite`.

```shell
mkdir services
```

In this `services` folder, add the file `verifyJWT.js`, and copy in the following code.

<RemoteCode url="https://raw.githubusercontent.com/FusionAuth/fusionauth-quickstart-javascript-express-api/main/complete-application/services/verifyJWT.js"
 lang="javascript" />

The first line, `require('dotenv/config');`, allows the file to use settings from `.env`.

The rest of the file, the function `verifyJWT`, gets the JWT access token from a cookie in the request, and uses `jose.js` to check the signature is correct for your installation of FusionAuth. If either the token is missing or not signed correctly, an error is returned. Otherwise the next function in the {frontmatter.technology} middleware stack is called.

Now you'll add one more file to check if the user has a role with permissions necessary to call an API endpoint.

In the `services` folder, add the file `hasRole.js`, and copy in the following code.

<RemoteCode url="https://raw.githubusercontent.com/FusionAuth/fusionauth-quickstart-javascript-express-api/main/complete-application/services/hasRole.js"
 lang="javascript" />

This function is given a list of roles — any of which allow the user's request. It returns a middleware function that checks if the JWT contains one of the required roles, and either returns an error or allows the next function in the middleware stack to proceed. Note that you do not need to check for the existence of a token in a cookie here, because the previous middleware function you wrote already did that.

### Create The Routes
All that's left to do is write the two endpoints that will demonstrate your authentication.

Overwrite `routes/index.js` with the following code.

<RemoteCode url="https://raw.githubusercontent.com/FusionAuth/fusionauth-quickstart-javascript-express-api/main/complete-application/routes/index.js"
 lang="javascript" />

The POST `panic` route uses your `hasRole(['teller'])` function to disallow non-tellers.

The GET `make-change` route uses `hasRole(['customer', 'teller']),` to allow either customers or tellers to make change. This route checks that the user has supplied a number for `total`, then either returns change as JSON, or an error if the total was invalid.

## Run The Application

Start the API server by running the command below in the `mysite` directory:

```
npm run start
```

### Get A Token

There are [several ways to acquire a token](/docs/v1/tech/oauth/) in FusionAuth, but for this example you will use the [Login API](/docs/v1/tech/apis/login) to keep things simple.

First let's try the requests as the `teller@example.com` user. Based on the configuration this user has the `teller` role and should be able to use both `/make-change` and `/panic`.

1. Acquire an access token for `teller@example.com` by making the following request

```shell
curl --location 'http://localhost:9011/api/login' \
--header 'Authorization: this_really_should_be_a_long_random_alphanumeric_value_but_this_still_works' \
--header 'Content-Type: application/json' \
--data-raw '{
  "loginId": "teller@example.com",
  "password": "password",
  "applicationId": "e9fdb985-9173-4e01-9d73-ac2d60d1dc8e"
}'
```

Copy the `token` from the response, which should look like this:

```json
{
    "token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6InVOYl9iQzFySHZZTnZMc285VzRkOEprZkxLWSJ9.eyJhdWQiOiJlOWZkYjk4NS05MTczLTRlMDEtOWQ3My1hYzJkNjBkMWRjOGUiLCJleHAiOjE2ODkzNTMwNTksImlhdCI6MTY4OTM1Mjk5OSwiaXNzIjoiaHR0cDovL2xvY2FsaG9zdDo5MDExIiwic3ViIjoiMDAwMDAwMDAtMDAwMC0wMDAwLTAwMDAtMTExMTExMTExMTExIiwianRpIjoiY2MzNWNiYjUtYzQzYy00OTRjLThmZjMtOGE4YWI1NTI0M2FjIiwiYXV0aGVudGljYXRpb25UeXBlIjoiUEFTU1dPUkQiLCJlbWFpbCI6InRlbGxlckBleGFtcGxlLmNvbSIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJhcHBsaWNhdGlvbklkIjoiZTlmZGI5ODUtOTE3My00ZTAxLTlkNzMtYWMyZDYwZDFkYzhlIiwicm9sZXMiOlsiY3VzdG9tZXIiLCJ0ZWxsZXIiXSwiYXV0aF90aW1lIjoxNjg5MzUyOTk5LCJ0aWQiOiJkN2QwOTUxMy1hM2Y1LTQwMWMtOTY4NS0zNGFiNmM1NTI0NTMifQ.WLzI9hSsCDn3ZoHKA9gaifkd6ASjT03JUmROGFZaezz9xfVbO3quJXEpUpI3poLozYxVcj2hrxKpNT9b7Sp16CUahev5tM0-4_FaYlmUEoMZBKo2JRSH8hg-qVDvnpeu8nL6FXxJII0IK4FNVwrQVFmAz99ZCf7m5xruQSziXPrfDYSU-3OZJ3SRuvD8bMopSiyRvZLx6YjWfBsvGSmMXeh_8vHG5fVkq5w1IkaDdugHnivtJIivHuCfl38kQBgw9rAqJLJoKRHHW0Ha7vHIcS6OCWWMDIIVspLyQNcLC16pL9Nss_5v9HMofow1OvQ9sUSMrbbkipjKq2peSjG7qA",
    "tokenExpirationInstant": 1689353059670,
    "user": {
        ...
    }
}
```

### Make The Request

Make a request to `/make-change` with a query parameter `total=5.12`. Use the `token` as the `app.at` cookie.

```shell
curl --cookie 'app.at=<your_token>' 'http://localhost:3000/make-change?total=1.02'
```

Your response should look like this:

```json
{
  "total":1.02,
  "nickels":20,
  "pennies":2
}
```

You were authorized, successfully! You can try making the request without the JWT or with a different string rather than a valid token, and see that you are denied access.

Next call the `/panic` endpoint because you are in trouble!

```shell
curl --location --request POST 'http://localhost:3000/panic' --cookie 'app.at=<your_token>'
```

This is a POST not a GET because you want all your emergency calls to be non-idempotent.

Your response should look like this:

```shell
We've called the police!
```

Nice, help is on the way!

Now let's try as `customer@example.com` who has the role `customer`. Acquire a token for `customer@example.com`.

```shell
curl --location 'http://localhost:9011/api/login' \
--header 'Authorization: this_really_should_be_a_long_random_alphanumeric_value_but_this_still_works' \
--header 'Content-Type: application/json' \
--data-raw '{
  "loginId": "customer@example.com",
  "password": "password",
  "applicationId": "e9fdb985-9173-4e01-9d73-ac2d60d1dc8e"
}'
```

Now use the token in that response to call `/make-change` with a query parameter `total=3.24`

```shell
curl --cookie 'app.at=<your_token>' 'http://localhost:3000/make-change?total=3.24'
```

Your response should look like this:

```json
{
    "total": 3.24,
    "nickels": 64,
    "pennies": 4
}
```

So far so good. Now let's try to call the `/panic` endpoint. (We're adding the `-i` flag to see the headers of the response)

```shell
curl -i --request POST 'http://localhost:3000/panic' --cookie 'app.at=<your_token>'
```

Your response should look like:

```shell
HTTP/1.1 403 Forbidden
X-Powered-By: Express
Content-Type: application/json; charset=utf-8
Content-Length: 63
ETag: W/"3f-eBPCxvxzYQmL0BG1KPuKqm5VcP4"
Date: Tue, 12 Sep 2023 09:46:52 GMT
Connection: keep-alive
Keep-Alive: timeout=5

{"error":"You do not have a role with permissions to do this."}
```

Uh oh, I guess you are not allowed to do that.

Enjoy your secured resource server!

## Next Steps

This quickstart is a great way to get a proof of concept up and running quickly, but to run your API in production, there are some things you're going to want to do.

### FusionAuth Integration

* Rather than call the Login API, you're probably going to want to use the [Authorization Code grant](/docs/v1/tech/oauth/#example-authorization-code-grant), which keeps all sensitive credentials within the bounds of FusionAuth. You can customize the [hosted login pages](/docs/v1/tech/themes/).
* You may want to generate a token using the [Client Credentials grant](/docs/v1/tech/oauth/#example-client-credentials-grant) if you are calling the API from another service.

### Security

* Customize the [token expiration times and policies](/docs/v1/tech/oauth/#configure-application-oauth-settings) in FusionAuth
* [Make sure you know how to securely consume a token](/articles/tokens/building-a-secure-jwt#consuming-a-jwt)
* Secure your API [using an API gateway](/docs/v1/tech/developer-guide/api-gateways/) rather than at the framework layer.

## Troubleshooting

* I get `Failed to connect to localhost port 9011: Couldn't connect to server` when I call the Login API.

Ensure FusionAuth is running in the Docker container.  You should be able to login as the admin user, `admin@example.com` with a password of `password` at [http://localhost:9011/admin](http://localhost:9011/admin).

* The `/panic` endpoint doesn't work when I call it.

Make sure you are making a `POST` call and using a token with the `teller` role.

* It still doesn't work

You can always pull down a complete running application and compare what's different.

```
git clone https://github.com/FusionAuth/fusionauth-quickstart-javascript-express-api.git
cd fusionauth-quickstart-javascript-express-api
docker compose up -d
cd complete-application
npm install
npm run start
```

