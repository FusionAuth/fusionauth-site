---
title: Identity Broker
description: Ship FusionAuth with your application to your customer's datacenter or private cloud.
section: get started
subcategory: use cases
navOrder: 70
---
import Aside from 'src/components/Aside.astro';
import UserLoggingInDiagram from 'src/diagrams/docs/get-started/use-cases/identity-broker/user-logging-in.astro';
import IdentityBrokerDescription from 'src/content/docs/get-started/use-cases/_identity-broker-description.mdx';

## Overview

<IdentityBrokerDescription />

## Problem 

You have an application that is embedded in your customer's computing environment. That could be a private cloud, an on-premises data center, or a remote location. This often happens for security, compliance or data gravity reasons.

Each customer has their own identity system that they want to use to control access to your application. You want to integrate with a wide variety of providers but avoid writing the integration code or support documentation.

## Solution

With the identity broker implementation, you can integrate your application with FusionAuth once and let your customers configure their identity provider. These include:

* Google Workspace
* Okta
* Microsoft Entra Id

In fact, any provider supporting OIDC, SAML, or LDAP can be used.

Your application is simpler to build and maintain and your customers can dictate the identity store.

<Aside type="tip">
This use case requires a resellers license. [Contact us](/contact) for more details.
</Aside> 

## Prerequisites

You have configured your application to [delegate authentication to FusionAuth](/docs/get-started/use-cases/auth-service) via the Authorization Code grant and the hosted login pages.

You have a license for reselling FusionAuth, obtained by [talking to our sales team](/contact). All embedded FusionAuth usage requires a license.

## Example Scenario

Suppose you have a data analytics tool that you deploy into a customer's environment. You want to:

* embed FusionAuth into your deployment mechanism
* help a customer to configure FusionAuth with their identity provider information
* allow customer's users to log in and access your applciation

FusionAuth can help you deliver this functionality.

## Actors/Components

* your user and their client application (mobile app or browser)
* your application
* the customer's identity store (Okta, Entra Id, LDAP, etc)
* FusionAuth

## Implementation Steps

You have have bundled FusionAuth into your deployment, whether as a Docker image or standalone executable.

This is a three phase implementation.

### Embed FusionAuth Into Your Application

You already have FusionAuth working for your application, but when you are building your deployment package, you'll need to include FusionAuth and a compatible database (PostgreSQL or MySQL). 

You can deploy FusionAuth as a Docker image for Kubernetes or other orchestration systems, or as a zip, DEB or RPM file if you are deploying on a VM or hardware. Either way, make sure there is a network path between your application and FusionAuth.

Make sure you [configure it correctly](/docs/reference/configuration). You'll usually want to deploy FusionAuth using the [database search engine](/docs/lifecycle/manage-users/search/search#using-the-database-search-engine) for deployment simplicity.

For initial install, you can script FusionAuth to a known state using a combination of [Kickstart](/docs/get-started/download-and-install/development/kickstart) to set up an API key and then either scripting using [an SDK](/docs/sdks) or [Terraform](/docs/operate/deploy/terraform) to configure it further. Pick the solution that is similar to what you use to configure your own application.

For initial configuration, you'll want to create:

* a local admin User
* a placeholder Identity Provider
* an Application representing your analytics application
* any branding login page customization; prefer a [simple theme](/docs/customize/look-and-feel/simple-theme-editor) for forward compatibility
* the FusionAuth license key or text
* any lambdas
* additional API keys, if needed

For subsequent upgrades, you'll want to use scripting or Terraform if there are other FusionAuth configuration changes such as adding a new application or to check the number of users to check for compliance with your license.

Share the local admin user with your customer so they have access in case their identity provider is not available or is not configured correctly.

#### Configuring The Identity Provider

This placeholder identity provider can be configured with as much information as you know. In addition, set these settings:

* `debug` to `false`
* `createRegistration` to `true`
* `enabled` to `true` for the Application

If you have gathered all needed information during an onboarding, you can configure it fully.

#### Configuring The Application

You'll want the application configuration to include the following:

* the appropriate local redirect URL or URLs for your analytics application
* `application.oauthConfiguration.requireRegistration` to `true`

By configuring these, you'll secure application access and limit it to users with an account in the customer's identity store.

### Enable Identity Providers

You want to help a customer to configure FusionAuth with their identity provider information. You can do this in one of two ways:

* give them direct access to the admin UI and the FusionAuth documentation
* add a page to your application which collects needed information and use the [Identity Provider API](/docs/apis/identity-providers/) and SDKs to configure the Identity Provider

In either case, you'll want to guide the customer through the identity provider configuration process with support and documentation.

You'll also want to specify the Id of the identity provider when you create it so that you can leverage the `idp_hint` functionality.

#### Direct Access

In this case, create one or more FusionAuth users with the `system_manager` role. This role gives access to create, update and delete identity provider configuration. Configure these users with a known password and require them to change it at first login using the `passwordChangeRequired` field.

The `system_manager` role limits access to other parts of the admin UI, which should make instructions on configuring the identity providers easier.

You can also customize the admin UI to a limited extent. You can use the [System API](/docs/apis/system) to modify these aspects by modifying the `systemConfiguration.uiConfiguration.*` properties:

* custom logo 
* color scheme

Choose this approach if you want to leverage the existing admin UI screens. You can also leverage FusionAuth docs. You can add links in your product docs to the FusionAuth documentation for common identity provider configuration, including options such as Okta or Entra Id.

#### Integrated Approach

In this case, you are going to add a configuration screen to your application capturing all the information needed for authenticating against a common protocol such as OIDC or SAML. Create an API key for use in your application, and use one of the SDKs to create, update or manage the identity provider.

This option gives you full control over the user interface and allows you to hide the admin UI from the customer. In addition to building that custom interface, this approach requires you to:

* document the values of the form fields
* update your integration when new features, such as encrypted SAML assertions, are added

### Mapping Roles

If you use RBAC, you'll need map roles between the customer's identity store and your application. Say your application has these roles:
* `admin`
* `developer`
* `business_analyst`

Different customers may have roles in their identity store that map to these roles in your application. Here's an example of different possible role names:

| Your Application   | Customer 1      | Customer 2       |
|--------------------|-----------------|------------------|
| `admin`            | `administrator` | `superadmin`     |
| `developer`        | `dev`           | `engineer`       |
| `business_analyst` | `ba`            | `data_analyst`   |

You can use a reconcile lambda for each customer to make sure the user data in FusionAuth and any tokens FusionAuth generates has the correct role. 

Here's the body of [an example OIDC reconcile lambda](/docs/extend/code/lambdas/openid-connect-response-reconcile) which maps roles from a customer data store to the application roles:

```javascript
function reconcile(user, registration, jwt, id_token, tokens) {
  registration.roles = [mapCustomerRoleToAppRole(jwt.role)];
}

function mapCustomerRoleToAppRole(customerRole) {
  const roleMap = {
    administrator: 'admin',
    dev: 'developer',
    ba: 'business_analyst',
  };

  return roleMap[customerRole] || null;
}
```

The above lambda is for installation in Customer 1's FusionAuth instance. For customer 2, you'd use a different `mapCustomerRoleToAppRole` function. You'd associate the lambda with the identity provider during the configuration process.

There may be other profile attributes such as name or title to map. Lambdas can help with these too.

### User Log In

After the customer has configured the identity provider, FusionAuth is set up as an identity broker. The next time an unauthenticated user visits your application, forward them to the identity provider by constructing the authorization URL and providing an `idp_hint`.

If the application you've configured has an Id of `85a03867-dccf-4882-adde-1a79aeec50df` and the identity provider has an Id of `82339786-3dff-42a6-aac6-1f1ceecb6c46`, the login URL might look like this (newlines added for clarity): 

```
https://yourinstance.local/oauth2/authorize?
  client_id=85a03867-dccf-4882-adde-1a79aeec50df&response_type=code&
  redirect_uri=https%3A%2F%2Fyourapp.local%2F/oauth-redirect&
  idp_hint=82339786-3dff-42a6-aac6-1f1ceecb6c46
```

Here's a diagram of the user login process.

<UserLoggingInDiagram alt="User logging in to the application." />

There may be certain sets of users that you don't want to have access to your analytics application, even if they can log in using the remote identity server. Limit those using the [login validation lambda](/docs/extend/code/lambdas/login-validation). Say you wanted to prevent anyone with the `dev` role from logging to the analytics application. You'd use a lambda body like:

```javascript
function validate(result, user, registration, context) {
  if (registration.roles && registration.roles.contains('dev') {
    result.errors.generalErrors = [{
      code: "[LoginRestricted]",
      message: "Sorry, you can't log in. Please contact the app administrator for more details."
    }];
  }
}
```

## Expected Outcome

You can deploy your application into any environment and have FusionAuth take care of the authentication integrations.

Your engineering team leverages FusionAuth tokens for identity data. They can code against the FusionAuth API or use the SDKs if any user information beyond that is needed.

Your customers can configure their own identity store and have all their users log in using that corporate user data store.

## Edge Cases

If you are using LDAP instead of OIDC or SAML, you'll use a [LDAP connector](/docs/lifecycle/migrate-users/connectors/ldap-connector) instead of an Identity Provider. Configuration of the connector will be different. The customer's user will see the FusionAuth login screen, which you can customize.

You can also add local users to your FusionAuth instance. This helps if a customer's identity store becomes unavailable or is misconfigured.

Deploying FusionAuth into an [air-gapped environment](/docs/get-started/core-concepts/licensing#advanced-scenarios) is supported.

You can support more than one remote identity data store. If, for example, you're deploying into an enterprise and there are two departments with two different identity stores, you can configure both of them. In this case, you'll need to either remove the `idp_hint` and let users choose which identity store to log in with, or update your logic which builds the initial login URL to determine who should be sent to which provider.

With this use case, you can support socil identity providers such as Facebook or LinkedIn, but these require internet access.

## Other Example Scenarios

These include:

* healthcare software deployed into a hospital network
* an IoT management system deployed in a remote geography
* a retail analytics engine which is deployed into stores
* a legal discovery platform deployed inside a client's firewall

## Additional Documentation

* [The auth facade pattern](/articles/ciam/auth-facade-pattern)
* [Unsupervised case study](/blog/unsupervised-avoids-development-maintenance-with-with-fusionauth)
* [OIDC reconcile lambda](/docs/extend/code/lambdas/openid-connect-response-reconcile)
* [SAMLv2 reconcile lambda](/docs/extend/code/lambdas/samlv2-response-reconcile)
* [Login validation lambda](/docs/extend/code/lambdas/login-validation)
* [LDAP connector](/docs/lifecycle/migrate-users/connectors/ldap-connector)
