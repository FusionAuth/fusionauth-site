---
title: Authenticate Users With SAML
description: How to authenticate users with SAML in FusionAuth.
navcategory: developer
section: lifecycle
subcategory: authenticate users
tertcategory: saml
quatercategory: examples
codeRoot: https://raw.githubusercontent.com/ritza-co/fusionauth-example-saml/refs/heads/main/completed-app
---

{/* @Tatenda to get screenshot for https://github.com/FusionAuth/fusionauth-site/pull/3684#discussion_r2103712507 */}

import Aside from 'src/components/Aside.astro';
import Breadcrumb from 'src/components/Breadcrumb.astro';
import DownloadWidget from 'src/components/download/DownloadWidget.astro';
import InlineField from 'src/components/InlineField.astro';
import InlineUIElement from 'src/components/InlineUIElement.astro';
import {RemoteCode} from '@fusionauth/astro-components';
import SimpleAuthenticationDiagram from 'src/diagrams/docs/lifecycle/examples/saml1.astro';
import FusionAuthSamlAuthenticationDiagram from 'src/diagrams/docs/lifecycle/examples/saml2.astro';
import ExternalSamlAuthenticationDiagram from 'src/diagrams/docs/lifecycle/examples/saml3.astro';

This guide demonstrates with a full code example how to authenticate users with SAML via FusionAuth. To learn more about SAML, please see the [FusionAuth SAML Overview](/docs/lifecycle/authenticate-users/saml).

Consider the following scenario:

You provide online financial services to users who log in to your website, Changebank.com. Until now, the website has managed its own user authentication with usernames and passwords, and you haven't used FusionAuth before.

You are contacted by a new corporate client, called Corpo.com, which wants all its employees to use your service. However, Corpo requires authentication to be done with SAML. Changebank will continue acting as the identity provider (often shortened to IdP) which is the party that holds the database of users. You want to add SAML authentication to your website without coding it yourself, so you are considering using FusionAuth as your gateway.

If instead Corpo had their own database of users (i.e. Corpo was the IdP) and FusionAuth would be used only as an intermediary to handle the SAML connection between Changebank and Corpo, then FusionAuth would be only a service provider (SP). Configuring FusionAuth as a SAML SP is explained in the [SAML guide to Okta](/docs/lifecycle/authenticate-users/identity-providers/enterprise/okta-samlv2), not in this guide.

<Aside type="tip">
If you use FusionAuth with corporate software, you may also want to provision users automatically when they join or leave your company. Learn [how to do this with SCIM](/docs/lifecycle/examples/manage-user-with-scim).
</Aside>

## Authentication Flow

Before configuring FusionAuth to support the example scenarios, let's look at how the SAML authentication process works. If you have used OAuth/OIDC before, the flow is almost identical. It's only the underlying implementation that differs between them and SAML.

First, consider the simple case in which your website, Changebank.com, does its own authentication, as shown below. Only two parties are involved: the user and the website.

<SimpleAuthenticationDiagram alt="Simple authentication diagram" />

Next, consider using FusionAuth as the SAML identity provider for login. Instead of letting the user log in on your site, you'll redirect them to FusionAuth to log in, where an identifying cookie will be stored in their browser, and they'll be sent back to your site. The flow below will look familiar to anyone who has used OAuth before.

<FusionAuthSamlAuthenticationDiagram alt="FusionAuth SAML authentication diagram" />

You can read more about [using FusionAuth as a SAML identity provider](/docs/lifecycle/authenticate-users/saml).

Finally, consider if Corpo were to act as the identity provider. In this case, there are four parties: the user, Changebank, FusionAuth acting as a service provider, and Corpo acting as the identity provider. This authentication flow is similar to the flow above, with one more level of redirection.

<ExternalSamlAuthenticationDiagram alt="External SAML authentication diagram" />

You can read more about [using FusionAuth as a service provider to connect to another identity provider in the documentation](/docs/lifecycle/authenticate-users/identity-providers/overview-samlv2).

In any of these cases, if the user already has authenticated with the Changebank application, they will bypass the login page and be redirected to their account page. That is, if the user has a valid session with Changebank, they won't need to log in.

## Use FusionAuth As A SAML Identity Provider

In the rest of the guide, you'll configure FusionAuth as the SAML identity provider to replace Changebank's custom authentication, where users do not have to log in with Corpo.com.

## Run FusionAuth And The Initial Website

Start by running a new instance of FusionAuth and configuring it to use SAML. You'll use [Docker](https://www.docker.com/get-started/) to run FusionAuth and [Node version 22](https://nodejs.org/en/download) to run the example application.

- Use the instructions below to download and run FusionAuth on your computer. The standard `Docker Compose` option will work fine.

<DownloadWidget kickstartEnabled={true} kickstartName={"get-started"} />

This command starts FusionAuth using Kickstart, which automatically creates an example application with example users. Using Kickstart saves you from having to configure everything yourself.

- Run the command below in a terminal to clone the [FusionAuth Example SAML Repository](https://github.com/FusionAuth/fusionauth-example-saml), or download and unzip the repository.
  ```sh
  git clone https://github.com/FusionAuth/fusionauth-example-saml
  ```

The repository contains a website in the `app` directory. This website represents the example Changebank website, for which FusionAuth is the authentication provider. The site currently uses OAuth for login, not bespoke authentication, which is slightly different from the example description but unimportant â€” the focus of this example is on changing the site to use SAML authentication.

Let's see how the website currently looks before configuring SAML.

- Open a terminal in the directory containing the repository files.
  ```sh
  cd app
  npm install
  npm run start
  ```

These commands install the Node.js packages in `package.json` and run the Express.js web server.

- Browse to http://localhost:3000.
- Log in to the Changebank website with `richard@example.com` and `password`.

![Change bank account page](/img/docs/lifecycle/examples/saml/accountIdp.png)

## Configure FusionAuth To Use SAML

Configure FusionAuth to use SAML as an identity provider for the Changebank application in the FusionAuth web interface.

- Log in to your FusionAuth web interface at http://localhost:9011/admin with the credentials `admin@example.com` and `password`.
- Browse to <Breadcrumb>Applications -> Example App -> Select -> Edit -> SAML tab</Breadcrumb>.
- Toggle the <InlineUIElement>Enabled</InlineUIElement> option on.
- Set <InlineField>Issuer</InlineField> to `passport-saml`.
- Set <InlineField>Authorized redirect URLs</InlineField> to `http://localhost:3000/saml/callback` (be sure to click the dropdown text that appears to confirm the entry).
- Toggle the <InlineUIElement>Debug enabled</InlineUIElement> option on.
- Under <Breadcrumb>Authentication response</Breadcrumb>, change <InlineUIElement>Signature location</InlineUIElement> to `Response`.
- Click <InlineUIElement>Save</InlineUIElement>.

![SAML setup](/img/docs/lifecycle/examples/saml/saml.png)

- Click <InlineUIElement>Select</InlineUIElement> then <InlineUIElement>View</InlineUIElement> for the application to see the SAML endpoints. You will need to scroll to the `SAML v2 Integration Details`section. The endpoints should look like the ones in the image below. Copy the `Metadata URL` value to a text file or to your clipboard.

![SAML settings](/img/docs/lifecycle/examples/saml/samlSettings.png)

## Configure The Website To Use SAML

FusionAuth is now ready to accept SAML logins. Next, you will add the callback URL above as a page in the existing website, configure SAML on the website, and reference FusionAuth's SSL certificate to ensure a secure connection.

The existing code in the `app` directory uses three main files:

- The `services/authentication.js` code uses Passport to manage OAuth.
- The `routes/index.js` code handles HTTP requests to HTML templates or authentication callbacks.
- The `app.js` code loads both `routes/index.js` and `services/authentication.js` into Express.js.

To add SAML to the website, you'll add the Passport strategy for SAML to `authentication.js` and add login and callback routes to `index.js`. The npm packages are already in `package.json`.

<Aside type="tip">
If you have trouble following the code changes presented below, you can copy the final example from `completed-app` to `app`, where all the work has already been done for you.

If you do this, you will need to update `cert/cert.pem` and the SAML URL in `.env`. The instructions immediately below explain how.
</Aside>

- Browse to the `Metadata URL` endpoint from the `SAML v2 Integration Details` section above, which is `http://localhost:9011/samlv2/metadata/d7d09513-a3f5-401c-9685-34ab6c552453`. Your `Metadata URL` will be different; use the value you copied above.
- Create an `app/cert/cert.pem` file. This is going to be used by the Changebank application to ensure that the SAML communication is secure and from the FusionAuth server. From the `Metadata URL` text in your browser, find the text between the tags labeled `<X509Certificate>` and paste it into the `app/cert/cert.pem` file. Add the line `-----BEGIN CERTIFICATE-----` above the text and the line `-----END CERTIFICATE-----` below it, and save the file.
- Add the `Login URL` from the SAML metadata to `app/.env`. Again, your value will look similar but the UUID will be different.
  ```
  SAML_URL="http://localhost:9011/samlv2/login/d7d09513-a3f5-401c-9685-34ab6c552453"
  ```
- Now you want to let the Changebank application interact with SAML. You'll be using `passport.js`, a common node library for authentication. The steps will be similar for any SAML library, though the terms and specific tasks might be slightly different. Add the following line to the top of the `dependencies` section of `package.json`.
  ```js
  "@node-saml/passport-saml": "^5.0.0",
  ```
- Add the lines below to the top of `app/services/authentication.js`.
  <RemoteCode
    url={frontmatter.codeRoot + "/services/authentication.js"}
    lang="js"
    tags="a" />
- In the same file, add the following line to the end of the `setupPassport` function.
  <RemoteCode
    url={frontmatter.codeRoot + "/services/authentication.js"}
    lang="js"
    tags="b" />
- At the end of the same file, add the function below.
  <RemoteCode
    url={frontmatter.codeRoot + "/services/authentication.js"}
    lang="js"
    tags="c" />
- In the middle of the `app/routes/index.js` file, replace the current OAuth login line with a SAML login and add a callback function.
  <RemoteCode
    url={frontmatter.codeRoot + "/routes/index.js"}
    lang="js"
    tags="a" />

## Log In With SAML

The FusionAuth configuration changes and Express.js code changes are complete. Now, let's test whether the login works.

- In the website terminal (in the `app` directory), push <kbd>Ctrl</kbd>+<kbd>c</kbd>, and run the Node commands again to install the new SAML package and restart the web server.
  ```sh
  npm install
  npm run start
  ```

You can now browse to http://localhost:3000 and log in exactly the same way as before, except you're now using SAML. If you see an error that your account isn't registered, it's because you logged in previously with the administration account. Try log in using an incognito browser window instead.

If you see `oauth` in the browser address bar, don't worry, FusionAuth translates SAML to OAuth calls internally before returning. To satisfy yourself that SAML is indeed being used, edit the example application again in FusionAuth, disable SAML, and save. Now when you attempt to log in you'll see the error `The AuthnRequest contained an invalid issuer [passport-saml]. That Application does not have SAML enabled`.

## Explanation Of The New Code

SAML depends on certificates, where OAuth and OIDC depend on the client secret. You need to copy the certificate from FusionAuth into the Changebank application in order for SAML to work.

In the `authentication.js` JavaScript file, you add SAML as a strategy. Passport can use multiple strategies, so you don't need to remove OAuth. Each strategy is identified by a different label, like `saml`. The `setupSaml` function sets some options to match the settings from FusionAuth. The function then instantiates the new Passport SAML strategy with two functions that handle the user profile returned from the identity provider. You can further process the user in these functions, for instance by saving the user to a database, but in this example you do nothing except say that you are done. Express.js session storage (`express-session`) is already being used to store the user profile in a cookie that is sent to the user's browser.

While SAML allows the identity provider to sign both the response to a request (`wantAuthnResponseSigned`) and assertions in the response (`wantAssertionsSigned`), some providers, like FusionAuth, are limited to signing only one or the other. Signing both is the most secure configuration, but since you're forced to choose, signing the whole response is safer than only the assertions. Choosing to sign the response is what you changed when configuring SAML in FusionAuth with the <InlineUIElement>Signature location</InlineUIElement>.

The code changes to the routes file are minimal, barely changing what is in the Passport documentation. You comment out the OAuth login route (because in this example the customer wanted to switch entirely to SAML), you add a SAML login route to direct the user to FusionAuth, and you use a callback handler to direct the logged in user to their account.

For more information on SAML in Passport, please see the [Passport-SAML](https://github.com/node-saml/passport-saml) and [Passport](https://github.com/jaredhanson/passport) documentation on GitHub.

## Clean Up

To remove all the Docker volumes, containers, images, and networks used in this guide, run the commands below in the terminal where you installed FusionAuth.

```sh
docker compose down -v
docker network prune
```
