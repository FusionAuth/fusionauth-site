---
title: Migrate From Stytch
description: How to migrate your users from Stytch to FusionAuth
section: lifecycle
subcategory: migrate users
tertcategory: bulk
prerequisites: none
importCodeRoot: https://raw.githubusercontent.com/ritza-co/fusionauth-import-scripts/master
javaCodeRoot: https://raw.githubusercontent.com/ritza-co/fusionauth-contrib/master
dateCreated: 2024-01-22
dateUpdated: none
---

import InlineUIElement from 'src/components/InlineUIElement.astro';
import InlineField from 'src/components/InlineField.astro';
import Aside from '/src/components/Aside.astro';
import {RemoteCode} from '@fusionauth/astro-components';

- [Todo](#todo)
- [Introduction](#introduction)
  - [Prerequisites](#prerequisites)
- [Create Stytch Users](#create-stytch-users)
- [Request User Passwords From Stytch](#request-user-passwords-from-stytch)
  - [Email The Request](#email-the-request)
  - [Decrypt The Reply](#decrypt-the-reply)
  - [Common Problems With Hashes](#common-problems-with-hashes)
- [Get All Users' Details And Combine With Hashes](#get-all-users-details-and-combine-with-hashes)
- [Install the Scrypt Password Hash Plugin For FusionAuth](#install-the-scrypt-password-hash-plugin-for-fusionauth)
- [Deploy the plugin](#deploy-the-plugin)
- [Save The User Details And Hash To FusionAuth](#save-the-user-details-and-hash-to-fusionauth)
- [Debug With The FusionAuth Database](#debug-with-the-fusionauth-database)
- [Authentication Types](#authentication-types)
- [References](#references)


## Todo

- [ ] review overview page and add stytch concepts and terms
- [ ] create stytch account, add users, export them and all details
- [ ] https://stytch.com/docs/guides/migrations/migrating-user-data-statically
- [ ] review other services migration pages this references
- [ ] remove unused frontmatter
- [ ] review other articles, like bradley's - https://fusionauth.io/docs/lifecycle/migrate-users/bulk/duende#add-the-aspnet-identity-v2-hashing-plugin
- [x] create hasher
- [ ] pull request for fusionauth-contrib stytch branch
- [ ] review details here - https://fusionauth.io/docs/lifecycle/migrate-users/bulk/duende#add-the-aspnet-identity-v2-hashing-plugin
- [ ] pull request for hash repo
- [ ] pull request for https://github.com/FusionAuth/fusionauth-import-scripts/.
- [ ] add an import script for users from stytch in json format? - https://github.com/FusionAuth/fusionauth-import-scripts/tree/master
- [ ] what login types does fusionauth support - magic email, passwordless, phone, google, facebook

## Introduction

This article explains how to import users from Stytch into FusionAuth. It is a low-level technical tutorial focussing on transferring password hashes, calling APIs, and preparing data. The article does not explain the high-level process of migration planning. This is explained in the [migration overview article](/docs/lifecycle/migrate-users/bulk/general.mdx). Please ensure you understand concepts like dual write, backfill, final synchronization, rolling migration, and cutover before proceeding. The [Stytch documentation on migration strategies](https://stytch.com/docs/guides/migrations/migrating-user-data-statically) is also useful reading. Also be aware of all laws regarding the protection and transfer of personal information in your country.

Finally, you need a basic understanding of password hashing and how salts work. FusionAuth has a [hashing article](/articles/security/math-of-password-hashing-algorithms-entropy) that is a good starting point.


### Prerequisites

This article is in the form of a tutorial, with data and code examples, showing you exactly how to extract and combine user credentials and information, and insert them into your FusionAuth database. To follow this tutorial, you need:
- [Node.js](https://nodejs.org/en) to run the migration scripts, and npm.
- FusionAuth. The easiest way to run it locally is to use [Docker](https://docs.docker.com/get-docker/) with the configuration file provided in this tutorial.

Stytch also has SDKs for [Go, Java, Python, and Ruby](https://stytch.com/docs/sdks) if you prefer to convert the JavaScript scripts accompanying this tutorial to another language for your migration in production.

## Create Stytch Users

You probably already have a Stytch account with users you want to export to FusionAuth. Even so, it is a good idea to create a separate test project in Stytch with only a few users. You can this to run an end-to-end migration between Stytch and FusionAuth quickly, without having to handle millions of real users, and the privacy risks of handling their data when encountering errors.

Create a new Stytch project:
- Create or sign in to your Stytch account at https://stytch.com/dashboard.
- In the header there is a workspace button at the top left, then a project button. Use the project button to create a new project you'll use for test users.
- Click <InlineUIElement>Configuration</InlineUIElement> â€” <InlineUIElement>API Keys</InlineUIElement> in the sidebar.
- Note the project Id and secret.

Create three example users:
- Download this tutorial's scripts repository from https://github.com/fusionauth/fusionauth-import-scripts and unzip it, or if you have Git run the code below.
  ```bash
  git clone https://github.com/fusionauth/fusionauth-import-scripts.git
  ```
- In the file `fusionauth-import-scripts/stytch/js/1_makeStytchUsers.mjs`, change the project Id and secret to match your project.
- In a terminal run the code below to create three new users in Stytch using their JavaScript API.
  ```bash
  cd fusionauth-import-scripts/stytch/js
  npm update
  node 1_makeStytchUsers.mjs
  ```
- In the Stytch dashboard, check that the users now exist.
- If any errors occur and you need to delete the users, uncomment the lines with `client.users.delete`, set the user Ids, and rerun the script.

The `1_makeStytchUsers.mjs` uses the Stytch JavaScript SDK to create users with three different hashing algorithms. However, the line `client.passwords.authenticate` provides the cleartext password to Stytch, which Stytch uses to rehash the user password using the Scrypt hashing algorithm. Thus, at the end of this script, all your users' passwords will be hashed with Scrypt in the Stytch database.

Even though you can create passwords for Stytch users with different hashing algorithms ([bcrypt, scrypt, argon2, MD-5, SHA-1, or PBKDF2](https://stytch.com/docs/api/password-migrate)), Scrypt is Stytch's preferred algorithm. Whenever a user logs in, Stytch will verify their password hash using the algorithm it is currently stored with, and then rehash their password using Scrypt and discard the old hash. Password rehashing is a common technique used to upgrade security as hashing algorithms evolve over time.

Once you have completed this tutorial and understand how to import hashes into FusionAuth, you might want to go back and comment out the authentic line in `1_makeStytchUsers.mjs` to test other hashing algorithms. Note that this is necessary only in the rare case that you previously imported users into Stytch from another system, and some of those users have not yet logged in again.

## Request User Passwords From Stytch

You cannot download your users' password hashes from Stytch using their API. To get them, email support@stytch.com from the email address you used to sign up with Stytch. Ask support to send your users' hashes to you.

### Email The Request

Stytch will encrypt the hashes with your public key. Attach this key in a `.pem` file to the email you send Stytch.

To create a private and public key pair, use the commands below in a terminal.

```shell
openssl genpkey -algorithm RSA -out private_key.pem &&
openssl rsa -pubout -in private_key.pem -out public_key.pem
```

Email Stytch only `public_key.pem`. Keep `private_key.pem` secret and secure.

An example of what these keys look like is in the directory `fusionauth-import-scripts/stytch/exampleData/1_emailRequest`. You can use the keys to request test users from Stytch, but do **not** use these keys for real users, as they are publicly available on GitHub.

(If you don't want to bother sending Stytch an email, you can use the example response files for the rest of this tutorial. The two files Stytch emailed are in `exampleData/2_emailResponse`.)

### Decrypt The Reply

Stytch will reply with two files: an encrypted password hash file (`stytch-project-<hashes>.enc`), and the key with which to decrypt it (`key.bin.enc`).

Decrypt the password file with the commands below.

```shell
openssl pkeyutl -decrypt -inkey private_key.pem -in key.bin.enc -out key.bin &&
openssl enc -d -aes-256-cbc -in stytch-project-test-36510638-652a-4d3d-9a94-f0a7106582fc-hashes-2021-01-11.enc -out stytch_password_hashes.csv -pass file:./key.bin
```

Now you have all your user hashes in the file `stytch_password_hashes.csv`. An example decrypted hash file is in `exampleData/3_responseDecryption`.

Below is the file content for three users, in `exampleData/3_responseDecryption/stytch_password_hashes.csv`.

< RemoteCode
    url={frontmatter.importCodeRoot + "/stytch/exampleData/3_responseDecryption/stytch_password_hashes.csv"}
    lang="csv"
/>

The file header describes the parameters you need to use when running the Scrypt hashing algorithm to convert user passwords to match the hashes in this file.

Below the header are the column names, and then one row per user. In the example data, all hashes were made using Scrypt.

### Common Problems With Hashes

Not all hash algorithms use separate salts. For instance, Bcrypt will create a salt automatically when hashing a password, and store the hash and salt concatenated in one string. You may have to deal with peculiarities of different algorithms like this if you previously migrated users into Stytch from an authentication provider that did not use Scrypt.

Even when using Scrypt with the given parameters, you need to carefully check that how you hash passwords has the same result as Stytch. Hashes and salts are arrays of bytes (numbers) and therefore cannot be displayed directly as text. They are instead mapped to text using a conversion process called Base64. However, there are [different ways](https://en.wikipedia.org/wiki/Base64#Variants_summary_table) of doing this mapping. Since you can see the hashes from Stytch use `-` and `_`, they must be using RFC 4648 (the URL-safe standard). This can cause miscommunications with other hash libraries, which use `+` and `-`.

For instance, we can use this snippet of JavaScript Node.js code below in `js/2_checkHash.mjs` to create a hash for the last user in the example file above.

< RemoteCode
    url={frontmatter.importCodeRoot + "/stytch/js/2_checkHash.mjs"}
    lang="js"
/>

Note that our hash algorithm looks correct, but the hashes differ by one character, `+`, in `8dg6AaIWPfcLTQU7lb4H-CI49dHeqaBXfFE1ogb2qRQ=` and `8dg6AaIWPfcLTQU7lb4H+CI49dHeqaBXfFE1ogb2qRQ=`.

To have the hashes match correctly, you need to replace the `+` and `/` characters in your hash:

```js
const keyBase64 = derivedKey.toString('base64').replace(/\+/g, '-').replace(/\//g, '_');
```

JavaScript and FusionAuth use the `+` and `/` symbols. Stytch and the FusionAuth Java Stytch plugin use `-` and `_`. If you encounter an error when verifying hashes, try first converting the hash and salt to use the other character set.

## Get All Users' Details And Combine With Hashes

Stytch emails you only the user hash and Id. You have to use the Stytch API to retrieve all user details from Stytch, then combine those with the hash from the email, and save the user to FusionAuth.

Firstly, open your hash file from Stytch in a text editor and remove all the header lines so only one user per row remains. Save this file into `stytch/js/hash.csv`. The file should look like `exampleData/4_hashFilePreparation/hash.csv` now:

< RemoteCode
    url={frontmatter.importCodeRoot + "/stytch/exampleData/4_hashFilePreparation/hash.csv"}
    lang="csv"
/>

Check the fourth column to ensure that only Scrypt users are included. The first four columns are most important: `id`, `hash`, `salt`, and `hash_method`.

The `3_getUserDetails.mjs` script loops through each user in the `hash.csv` file, uses the API to get the user details from Stytch, and saves them to `js/users.json`.

- Open `3_getUserDetails.mjs` and set your project Id and secret.
- Run the code below in a terminal in the `fusionauth-import-scripts/stytch/js` directory.
  ```bash
  npm update
  node 3_getUserDetails.mjs
  ```

Open `js/users.json`. It should look like the sample in `exampleData/5_userDetailAndHashPreparation/users.json`.

< RemoteCode
    url={frontmatter.importCodeRoot + "/stytch/exampleData/5_userDetailAndHashPreparation/user.json"}
    lang="json"
/>

Note that in Stytch a user can have multiple emails and phone numbers. FusionAuth allows for only one. You will store the extras in the user data JSON field when migrating the user, along with any other Stytch fields FusionAuth does not support.

The last lines of the object show the hash and salt that the script added from the hash file to the user details from the API.

## Install the Scrypt Password Hash Plugin For FusionAuth

The Scrypt hashing algorithm is not [natively supported by FusionAuth](/docs/reference/password-hashes). However, FusionAuth allows [custom plugins](/docs/extend/code/password-hashes/custom-password-hashing). There is a Scrypt plugin accompanying this article [in this GitHub repository](https://github.com/FusionAuth/fusionauth-contrib/tree/master/Password%20Hashing%20Plugins).

Note that this repository has multiple plugin projects. You need to build and install only the hashing project.

- Download and unzip the repository, or use Git in a terminal with the code below.
  ```bash
  git clone https://github.com/fusionauth/fusionauth-contrib.git
  ```

Open the file `fusionauth-contrib/Password Hashing Plugins/src/main/java/com/mycompany/fusionauth/plugins/ExampleStytchScryptPasswordEncryptor.java`. It is shown below.

< RemoteCode
    url={frontmatter.javaCodeRoot + "/Password Hashing Plugins/src/main/java/com/mycompany/fusionauth/plugins/ExampleStytchScryptPasswordEncryptor.java"}
    lang="java"
/>

This program takes a password and salt and returns a hash. It accepts and returns the `+` form of Base64, but changes it to `-` to work with Java internally. The `factor` parameter is ignored. Scrypt instead has multiple parameters that are set at the top of the file. If any of these differ from the ones you received in your encrypted CSV file header, you need to change them in the Java file.

There are two other files linked to this Scrypt plugin that you shouldn't need to alter:
- `fusionauth-contrib/Password Hashing Plugins/src/main/java/com/mycompany/fusionauth/plugins/ExampleStytchScryptPasswordEncryptorTest.java`, which holds unit tests for the hasher.
- `fusionauth-contrib/Password Hashing Plugins/src/main/java/com/mycompany/fusionauth/plugins/guice/MyExampleFusionAuthPluginModule.java`, which makes the hasher file known to FusionAuth.


- Open the file `fusionauth-contrib/Password Hashing Plugins/src/test/java/com/mycompany/fusionauth/plugins/ExampleArgon2idPasswordEncryptorTest.java` and comment out all the tests. They did not work at the time of writing this tutorial and will break your compilation.
- Open a terminal and run the code below to build a Docker container for Java, with the repository shared as a volume into the container.
  ```bash
  cd fusionauth-contrib/.devcontainer
  docker build -t javaimage .
  cd ..
  docker run -it --name javabox -v .:/workspace javaimage
  ```
- Inside the Docker container terminal that is now running, run the code below.
  ```bash
  cd "/workspace/Password Hashing Plugins"
  mvn clean install
  exit
  ```

## Deploy the plugin

- Copy `fusionauth-example-password-encryptor-0.1.0.jar` to your FusionAuth `plugins` directory and restart FusionAuth.
    - If using FusionAuth in Docker, where the container is called `fa` this command will be:
    ```bash
    docker exec fa mkdir /usr/local/fusionauth/plugins &&
    docker cp "Password Hashing Plugins/target/fusionauth-example-password-encryptor-0.1.0.jar" fa:/usr/local/fusionauth/plugins/fusionauth-example-password-encryptor-0.1.0.jar
    ```

## Save The User Details And Hash To FusionAuth

You now have the users file `export.json` and an installed Scrypt plugin. To import the users into FusionAuth you need to install the FusionAuth SDK for Node.js, then run the script below.

Add the following code into a file called `import.mjs`.

TODO
faUser.registrations = Array<UserRegistration>;
faUser.tenantId = UUID;

In a terminal, run the code below.

```bash
npm install @fusionauth/typescript-client stream-json
node import.mjs
```

## Debug With The FusionAuth Database

users
identites
DBeaver

## Authentication Types

passwords, passwordless, others?

## References
- [x] https://fusionauth.io/docs/reference/password-hashes
- [x] https://fusionauth.io/docs/extend/code/password-hashes/custom-password-hashing
- [ ] https://fusionauth.io/docs/lifecycle/migrate-users/bulk/duende#add-the-aspnet-identity-v2-hashing-plugin
- [ ] https://fusionauth.io/docs/lifecycle/migrate-users/bulk/auth0
- [ ] https://fusionauth.io/docs/lifecycle/migrate-users/bulk/general