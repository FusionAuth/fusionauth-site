---
title: Migrate From Stytch
description: How to migrate your users from Stytch to FusionAuth
section: lifecycle
subcategory: migrate users
tertcategory: bulk
prerequisites: none
url: https://github.com/ritza-co/fusionauth_migrate_stytch
codeRoot: https://raw.githubusercontent.com/ritza-co/fusionauth_migrate_stytch/main
dateCreated: 2024-01-10
dateUpdated: none
---

import InlineUIElement from 'src/components/InlineUIElement.astro';
import InlineField from 'src/components/InlineField.astro';
import Aside from '/src/components/Aside.astro';
import {RemoteCode} from '@fusionauth/astro-components';

- [Todo](#todo)
- [Introduction](#introduction)
  - [Prerequisites](#prerequisites)
- [Request User Passwords From Stytch](#request-user-passwords-from-stytch)
  - [Email The Request](#email-the-request)
  - [Decrypt The Reply](#decrypt-the-reply)
  - [Common Problems With Hashes](#common-problems-with-hashes)
  - [Create Your Own User Manually To Test Hashing](#create-your-own-user-manually-to-test-hashing)
- [Example User Details From Stytch](#example-user-details-from-stytch)
- [A Script To Get All Users' Details And Combine With Hashes](#a-script-to-get-all-users-details-and-combine-with-hashes)
- [Install the Scrypt Password Hash Plugin For FusionAuth](#install-the-scrypt-password-hash-plugin-for-fusionauth)
- [Save The User Details And Hash To FusionAuth](#save-the-user-details-and-hash-to-fusionauth)
- [Debug With The FusionAuth Database](#debug-with-the-fusionauth-database)
- [Authentication Types](#authentication-types)
- [References](#references)


## Todo

- [ ] review overview page and add stytch concepts and terms
- [ ] create stytch account, add users, export them and all details
- [ ] https://stytch.com/docs/guides/migrations/migrating-user-data-statically
- [ ] review other services migration pages this references
- [ ] remove unused frontmatter
- [ ] review other articles, like bradley's - https://fusionauth.io/docs/lifecycle/migrate-users/bulk/duende#add-the-aspnet-identity-v2-hashing-plugin
- [x] create hasher
- [ ] pull request for fusionauth-contrib stytch branch
- [ ] review details here - https://fusionauth.io/docs/lifecycle/migrate-users/bulk/duende#add-the-aspnet-identity-v2-hashing-plugin
- [ ] pull request for hash repo
- [ ] pull request for https://github.com/FusionAuth/fusionauth-import-scripts/.
- [ ] add an import script for users from stytch in json format? - https://github.com/FusionAuth/fusionauth-import-scripts/tree/master
- [ ] what login types does fusionauth support - magic email, passwordless, phone, google, facebook

## Introduction

This article explains how to import users from Stytch into FusionAuth. It is a low-level technical tutorial focussing on transferring password hashes, calling APIs, and preparing data. The article does not explain the high-level process of migration planning. This is explained in the [migration overview article](/docs/lifecycle/migrate-users/bulk/general.mdx). Please ensure you understand concepts like dual write, backfill, final synchronization, rolling migration, and cutover before proceeding. The [Stytch documentation on migration strategies](https://stytch.com/docs/guides/migrations/migrating-user-data-statically) is also useful reading.

### Prerequisites

This article is in the form of a tutorial, with data and code examples, showing you exactly how to extract and combine user credentials and information, and insert them into your FusionAuth database. To follow this tutorial, you need
- [Node.js](https://nodejs.org/en) installed to run the migration scripts.
- FusionAuth installed and running. The easiest way is to use [Docker](https://docs.docker.com/get-docker/) with the configuration file provided in this tutorial.
- A basic understanding of password hashing and how salts work. FusionAuth has a [short hashing article](/articles/security/math-of-password-hashing-algorithms-entropy) that is a good starting point.

## Request User Passwords From Stytch

You cannot download your users' password hashes from Stytch using their API. To get them, email support@stytch.com from the email address you used to sign up with Stytch. Ask support to send your users' hashes to you.

### Email The Request

Stytch will encrypt the hashes with your public key. Attach this key in a `.pem` file to the email you send Stytch.

To create a private and public key pair, use the commands below in a terminal.

```shell
openssl genpkey -algorithm RSA -out private_key.pem &&
openssl rsa -pubout -in private_key.pem -out public_key.pem
```

Email Stytch only `public_key.pem`. Keep `private_key.pem` secret and secure.

### Decrypt The Reply

Stytch will reply with two files: an encrypted password hash file (`something-hashes.enc`), and the key with which to decrypt it (`key.bin.enc`).

Decrypt the password file with the commands below.

```shell
openssl pkeyutl -decrypt -inkey private_key.pem -in key.bin.enc -out key.bin &&
openssl enc -d -aes-256-cbc -in something-hashes.enc -out stytch_password_hashes.csv -pass file:./key.bin
```

Now you have all your user hashes in the file `stytch_password_hashes.csv`.

Below is an example of the file content for three users.

```csv
scrypt hash parameters,,,,
scryptCostParameter,1 << 15,,,
scryptRParameter,8,,,
scryptPParameter,1,,,
scryptKeyLengthParamenter,32,,,
,,,,
id,hash,salt,hash_method,project_id

user-test-178d8ee5-c458-4f48-a482-8fefa30a1a87,uiOC_BwbKta9R9QL6Ss6KTDpCcULh9_zhObl5j4398M=,BbV-sGQqUIX1NwE6uqtSITv4fa1iMw==,scrypt,project-test-36510638-652a-4d3d-9a94-f0a7106582fc

user-test-799ea981-b2bb-417f-afe8-4ab6e79fcd2a,A6VzdsTsTHPqafORIb0GkGD6qFxdncqwA15YXRsVgvs=,XPapDAm6xdV5UhMpyPrSpy8FbfCDtA==,scrypt,project-test-36510638-652a-4d3d-9a94-f0a7106582fc

user-test-c1be12e4-fc61-4e7a-8831-0fc14cb87b65,8dg6AaIWPfcLTQU7lb4H-CI49dHeqaBXfFE1ogb2qRQ=,zKia-0BdIFKCzWbzXbj3qrhBnbiWNg==,scrypt,project-test-36510638-652a-4d3d-9a94-f0a7106582fc
```

The file header describes the parameters you need to use when running the Scrypt hashing algorithm to convert user passwords to match the hashes in this file.

Below the header are the column names, and then one row per user.

Even though you can create passwords for Stytch users with different hashing algorithms ([bcrypt, scrypt, argon2, MD-5, SHA-1, or PBKDF2](https://stytch.com/docs/api/password-migrate)), Scrypt is Stytch's preferred algorithm. Whenever a user logs in, Stytch will verify their password hash using the algorithm it is currently stored with, and then rehash their password using Scrypt and discard the old hash. Password rehashing is a common technique used to upgrade security as hashing algorithms evolve over time.

This means that the passwords you receive in the CSV file will almost all be in Scrypt format. However, there might be some users who haven't logged in in a long time, and their password hash uses a different algorithm.

### Common Problems With Hashes

Not all hash algorithms use separate salts. For instance, Bcrypt will create a salt automatically when hashing a password, and store the hash and salt concatenated in one string. You may have to deal with peculiarities of different algorithms like this if you previously migrated users into Stytch from an authentication provider that did not use Scrypt.

Even when using Scrypt with the given parameters, you need to carefully check that how you hash passwords has the same result as Stytch. Hashes and salts are arrays of bytes (numbers) and therefore cannot be displayed directly as text. They are instead mapped to text using a conversion process called Base64. However, there are [different ways](https://en.wikipedia.org/wiki/Base64#Variants_summary_table) of doing this mapping. Since you can see the hashes from Stytch use `-` and `_`, they must be using RFC 4648 (URL- and filename-safe standard). This can cause miscommunications with other hash libraries.

For instance, we can use this snippet of JavaScript Node.js code below to create a hash for the last user in the example file above. (Stytch also has SDKs for [Go, Java, Python, and Ruby](https://stytch.com/docs/sdks) if you prefer to write your own scripts.)

```js
import * as crypto from 'crypto';

const password = 'averylongandunguessablepasswordwithlotsofrandominfooofisjoafasnr;,n2';
const salt = 'zKia-0BdIFKCzWbzXbj3qrhBnbiWNg==';
const hash = '8dg6AaIWPfcLTQU7lb4H-CI49dHeqaBXfFE1ogb2qRQ=';

const cost = 1 << 15;
const blockSize = 8;
const parallelization = 1;
const keyLength = 32;

crypto.scrypt(password, salt, keyLength, { N: cost, r: blockSize, p: parallelization, maxmem: 1024 * 1024 * 1024*50 }, (err, derivedKey) => {
  if (err) throw err;
  const keyBase64 = derivedKey.toString('base64');
  console.log('Hash:', keyBase64); // 8dg6AaIWPfcLTQU7lb4H+CI49dHeqaBXfFE1ogb2qRQ=
  console.log('Matches provided hash:', keyBase64 === hash);
});
```

Note that our hash algorithm looks correct, but the hashes differ by one character, `+`, in `8dg6AaIWPfcLTQU7lb4H-CI49dHeqaBXfFE1ogb2qRQ=` and `8dg6AaIWPfcLTQU7lb4H+CI49dHeqaBXfFE1ogb2qRQ=`.

To have the hashes match correctly, you need to replace the `+` and `/` characters in your hash:

```js
const keyBase64 = derivedKey.toString('base64').replace(/\+/g, '-').replace(/\//g, '_');
```

FusionAuth uses the `+` and `/` symbols, differing from Stytch's `-` and `_`.

### Create Your Own User Manually To Test Hashing

If you find after migration that your users cannot log in to FusionAuth, you'll need to debug why their password hashes are no longer matching. It's useful to have a known username and password to test this.

The easiest way is to create a user with the Stytch API, so that the user is included in your Stytch password export file.

Below is JavaScript code to create a user.

```js
// npm install bcryptjs stytch;

import * as stytch from "stytch";
import * as bcrypt from 'bcryptjs';

const client = new stytch.Client({
  project_id: "project-test-36510638-652a-4d3d-9a94-f0a7106582fc",
  secret: "secret-test-something=",
});

await createUser({ email: "user4@example.com", phone_number: '+272223331444',  first_name: 'A', last_name: 'Example', password: "averylongandunguessablepasswordwithlotsofrandominfooofisjoafasnr;,n1"});

async function createUser(p) {
  await client.users.create({ email: p.email, phone_number: p.phone_number,  name:{first_name: p.first_name, last_name: p.last_name}});
  const hash = await bcrypt.default.hash(p.password, 0);
  await client.passwords.migrate({
    email: p.email,
    hash: hash,
    hash_type: "bcrypt"
  });
  console.log(`Hash: ${hash}`);
  const user = await client.passwords.authenticate({ email: p.email, password: p.password });
  console.log(user);
}
```

Get your `project_id` and `secret` from the [Stytch web interface](https://stytch.com/dashboard/api-keys).

You create the user's password hash with Bcrypt in this example and save that in Stytch. But you authenticate the user afterwards (which is similar to logging in). Stytch uses the plaintext password you send in the authentication to rehash the user's password using Scrypt. Thus the hash you receive for this user in the emailed file from Stytch will also be in Scrypt, not Bcrypt.

## Example User Details From Stytch

Stytch emails you only the user hash and Id. You have to use the Stytch API to retrieve all user details from Stytch, then combine those with the hash from the email, and save the user to FusionAuth.

Below is a Node.js script to get user details from Stytch.

```js
import * as stytch from "stytch";

const client = new stytch.Client({
    project_id: "project-test-REPLACE",
    secret: "secret-test-REPLACE",
});

let u = await client.users.get({ user_id: "user-test-REPLACE" });
console.log(u);
```

The reply will look similar to the code below.

```json
{
  "biometric_registrations": [],
  "created_at": "2024-01-11T09:54:59Z",
  "crypto_wallets": [],
  "emails": [
    {
      "email": "user1@example.com",
      "email_id": "email-test-8af9b269-8f2f-44a6-8322-6f2f276cba5d",
      "verified": false
    }
  ],
  "name": {
    "first_name": "A",
    "last_name": "Example",
    "middle_name": ""
  },
  "password": {
    "password_id": "password-test-80e44428-9182-4635-8a08-9c4c5ccf6c72",
    "requires_reset": false
  },
  "phone_numbers": [
    {
      "phone_id": "phone-number-test-b4c5c640-3f30-46bc-8bdf-5379ad21367b",
      "phone_number": "+272223334444",
      "verified": false
    }
  ],
  "providers": [],
  "request_id": "request-id-test-1aee71b3-094d-4f90-a1be-086004c695fc",
  "status": "active",
  "status_code": 200,
  "totps": [],
  "trusted_metadata": {},
  "untrusted_metadata": {},
  "user_id": "user-test-178d8ee5-c458-4f48-a482-8fefa30a1a87",
  "webauthn_registrations": []
}
```

Note that in Stytch a user can have multiple emails and phone numbers. FusionAuth allows for only one. You will store the extras in the user data JSON field when migrating the user, along with any other Stytch fields FusionAuth does not support.

## A Script To Get All Users' Details And Combine With Hashes

Let's create a script that loops through every user in the Stytch hash file, gets their details from the API, then combines the details and hash into a JSON file ready for FusionAuth to import.

Firstly, open your hash file from Stytch in a text editor and remove all the header lines so only one user per row remains. The file should look like this now:

```csv
user-test-178d8ee5-c458-4f48-a482-8fefa30a1a87,uiOC_BwbKta9R9QL6Ss6KTDpCcULh9_zhObl5j4398M=,BbV-sGQqUIX1NwE6uqtSITv4fa1iMw==,scrypt,project-test-36510638-652a-4d3d-9a94-f0a7106582fc
user-test-799ea981-b2bb-417f-afe8-4ab6e79fcd2a,A6VzdsTsTHPqafORIb0GkGD6qFxdncqwA15YXRsVgvs=,XPapDAm6xdV5UhMpyPrSpy8FbfCDtA==,scrypt,project-test-36510638-652a-4d3d-9a94-f0a7106582fc
user-test-c1be12e4-fc61-4e7a-8831-0fc14cb87b65,8dg6AaIWPfcLTQU7lb4H-CI49dHeqaBXfFE1ogb2qRQ=,zKia-0BdIFKCzWbzXbj3qrhBnbiWNg==,scrypt,project-test-36510638-652a-4d3d-9a94-f0a7106582fc
```

Check the fourth column to ensure that only Scrypt users are included. In the unlikely case that you have multiple hash algorithms in Stytch, you will need to modify the export and import scripts in this tutorial.

You care about the first four columns: `id`, `hash`, `salt`, and `hash_method`. If you name this file `hash.csv`, you can use the following Node.js code to create the data ready for import to FusionAuth. Put this code into a file called `export.mjs`.

```js
// npm install csv-parser stytch

import * as stytch from "stytch";
import * as fs from "fs";
import csv from "csv-parser";

processCSV();

async function processCSV() {
  const client = new stytch.Client({
    project_id: "project-test-36510638-652a-4d3d-9a94-f0a7106582fc",
    secret: "secret-test-Ww5WZPWzBGJdW44BOCq3K6VypSyjC8iO4dE=",
  });
  const table = fs.createReadStream('hash.csv')
                  .pipe(csv({ headers: false }));
  const users = [];
  for await (const row of table) {
    try {
      const user = await client.users.get({ user_id: row[0] });
      user.hash = row[1];
      user.salt = row[2];
      user.hashAlgorithm = row[3];
      users.push(user);
    }
    catch (error) {
      console.error(`Error fetching user details for ID ${row[0]}: ${error.message}`);
    }
  }
  fs.writeFileSync('export.json', JSON.stringify(users, null, 2));
}
```

Run it with the code below.

```bash
npm install csv-parser stytch
node export.mjs
```

It creates the file `export.json`.

## Install the Scrypt Password Hash Plugin For FusionAuth

The hashes in your prepared JSON file probably all use Scrypt, and will be imported into FusionAuth using this algorithm.

The Scrypt hashing algorithm is not [natively supported by FusionAuth](/docs/reference/password-hashes). However, FusionAuth allows [custom plugins](/docs/extend/code/password-hashes/custom-password-hashing). There is a Scrypt plugin accompanying this article [in this GitHub repository](https://github.com/FusionAuth/fusionauth-contrib/tree/master/Password%20Hashing%20Plugins).

Note that this repository has multiple plugin projects. You need to build and install only the hashing project. To do so, please follow the instructions in the project's [readme file](https://github.com/FusionAuth/fusionauth-contrib/blob/master/Password%20Hashing%20Plugins/README.md). In summary, you need to:
- Clone and build the project, either in local Java or with Docker.
- Copy the `fusionauth-example-password-encryptor-0.1.0.jar` file to your FusionAuth plugins `directory` and restart FusionAuth.

## Save The User Details And Hash To FusionAuth

You now have the users file `export.json` and an installed Scrypt plugin. To import the users into FusionAuth you need to install the FusionAuth SDK for Node.js, then run the script below.

Add the following code into a file called `import.mjs`.

TODO
faUser.registrations = Array<UserRegistration>;
faUser.tenantId = UUID;

```js
// npm install @fusionauth/typescript-client stream-json

import {FusionAuthClient} from '@fusionauth/typescript-client';
import parser from 'stream-json';
import StreamArray from 'stream-json/streamers/StreamArray.js';
import Chain from 'stream-chain';
import * as fs from "fs";
import util from 'util'

const apiKey = '33052c8a-c283-4e96-9d2a-eb1215c69f8f-not-for-prod';
const fusionauthUrl = 'http://localhost:9011';
const fa = new FusionAuthClient(apiKey, fusionauthUrl);

processUsers();

async function processUsers() {
  const stytchUsers = new Chain([fs.createReadStream('export.json'), parser(), new StreamArray(),]);
  for await (const { value: stytchUser } of stytchUsers) {
    const faUser = getFaUserFromStytchUser(stytchUser);
    await importUser(faUser, stytchUser);
  }
}

function getFaUserFromStytchUser(stytchUser) {
  const faUser = {};

  // SecureIdentity fields ------
  // faUser.breachedPasswordLastCheckedInstant = number;
  // faUser.breachedPasswordStatus = BreachedPasswordStatus;
  // faUser.connectorId = UUID;
  if (stytchUser.hashAlgorithm == "scrypt")
    faUser.encryptionScheme = 'example-salted-stytch-scrypt';
  else
    throw new Error("Handle hash algorithms other than Scrypt by searching for this error message and adding a new encryptionScheme.");
  faUser.factor = 1; // unused by scrypt, but required by FusionAuth
  faUser.id = getNullOrUUIDFromUserId(stytchUser.user_id);
  // faUser.lastLoginInstant = number;
  faUser.password = Buffer.from(stytchUser.hash, 'base64').toString('base64'); // fusionAuth doesn't like - and _ in Base64, only / and +
  faUser.passwordChangeRequired = stytchUser.password?.requires_reset;
  if (faUser.passwordChangeRequired)
    faUser.passwordChangeReason = "Requested by Stytch on import";
  // faUser.passwordLastUpdateInstant = number;
  faUser.salt = Buffer.from(stytchUser.salt, 'base64').toString('base64'); // fusionAuth doesn't like - and _ in Base64, only / and +
  faUser.uniqueUsername = stytchUser.user_id;
  faUser.username = stytchUser.user_id;
  // faUser.usernameStatus = ContentStatus;
  faUser.verified = false;
  if (stytchUser.emails && stytchUser.emails.some(e => e.verified === true)) {
    faUser.verified = true;
    faUser.email = stytchUser.emails.find(e => e.verified).email;
  }
  else if (stytchUser.emails && stytchUser.emails.length > 0)
    faUser.email = stytchUser.emails[0].email;
  // faUser.verifiedInstant = number;

  // User fields ------
  faUser.active = (stytchUser.status == "active");
  // faUser.birthDate = string;
  // faUser.cleanSpeakId = UUID;
  // faUser.expiry = number;
  if (stytchUser.name?.first_name)
    faUser.firstName = stytchUser.name?.first_name;
  faUser.fullName = [stytchUser.name?.first_name, stytchUser.name?.middle_name, stytchUser.name?.last_name]
    .filter(name => name !== null && name !== undefined && name !== '')
    .join(' ');
  // faUser.imageUrl = string;
  // faUser.insertInstant = number;
  if (stytchUser.name?.last_name)
    faUser.lastName = stytchUser.name?.last_name;
  // faUser.lastUpdateInstant = number;
  // faUser.memberships = Array<GroupMember>;
  if (stytchUser.name?.middle_name)
    faUser.middleName = stytchUser.name?.middle_name;
  // faUser.mobilePhone = string;
  if (stytchUser.phone_numbers?.length > 0)
    faUser.mobilePhone = stytchUser.phone_numbers[0].phone_number;
  // faUser.parentEmail = string;
  // faUser.preferredLanguages = Array<string>;
  // faUser.registrations = Array<UserRegistration>;
  // faUser.tenantId = UUID;
  // faUser.timezone = string;
  // faUser.twoFactor = UserTwoFactorConfiguration;
  faUser.data = {}
  if (stytchUser.biometric_registrations?.length > 0)
    faUser.data.stytch_biometric_registrations = stytchUser.biometric_registrations;
  faUser.data.stytch_created_at = stytchUser.created_at;
  if (stytchUser.crypto_wallets?.length > 0)
    faUser.data.stytch_crypto_wallets = stytchUser.crypto_wallets;
  if (stytchUser.emails?.length > 1)
    faUser.data.stytch_emails = stytchUser.emails.filter(e => e.email != faUser.email);
  if (stytchUser.phone_numbers?.length > 1)
    faUser.data.stytch_phone_numbers = stytchUser.phone_numbers.filter(e => e.phone_number != faUser.mobilePhone);
  if (stytchUser.providers?.length > 0)
    faUser.data.stytch_providers = stytchUser.providers;
  if (stytchUser.trusted_metadata && Object.keys(stytchUser.trusted_metadata).length > 0)
    faUser.data.stytch_trusted_metadata = stytchUser.trusted_metadata;
    if (stytchUser.untrusted_metadata && Object.keys(stytchUser.untrusted_metadata).length > 0)
    faUser.data.stytch_untrusted_metadata = stytchUser.untrusted_metadata;
  faUser.data.stytch_user_id = stytchUser.user_id;
  if (stytchUser.webauthn_registrations?.length > 0)
    faUser.data.stytch_webauthn_registrations = stytchUser.webauthn_registrations;
  faUser.data.stytch_export_request_id = stytchUser.request_id;

  return faUser;
}

async function importUser(faUser, stytchUser) {
  const importRequest = { users: [faUser], validateDbConstraints: true };
  try {
    const result = await fa.importUsers(importRequest);
    if (result.wasSuccessful())
      console.log(`User ${stytchUser.user_id} imported successfully`);
    else
      console.error(`Error importing user ${stytchUser.user_id}`);
  }
  catch (e) {
    console.error(`Error importing user ${stytchUser.user_id}`);
    console.error(util.inspect(e, { showHidden: false, depth: null, colors: true }));
  }
}

function getNullOrUUIDFromUserId(id) {
  const uuidRegex = /[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/i; // "user_id": "user-test-178d8ee5-c458-4f48-a482-8fefa30a1a87",
  const match = id.match(uuidRegex);
  if (match)
    return match[0];
  return null;
}
```

`apiKey`

In a terminal, run the code below.

```bash
npm install @fusionauth/typescript-client stream-json
node import.mjs
```

## Debug With The FusionAuth Database

users
identites
DBeaver

## Authentication Types

passwords, passwordless, others?

## References
- [x] https://fusionauth.io/docs/reference/password-hashes
- [x] https://fusionauth.io/docs/extend/code/password-hashes/custom-password-hashing
- [ ] https://fusionauth.io/docs/lifecycle/migrate-users/bulk/duende#add-the-aspnet-identity-v2-hashing-plugin
- [ ] https://fusionauth.io/docs/lifecycle/migrate-users/bulk/auth0
- [ ] https://fusionauth.io/docs/lifecycle/migrate-users/bulk/general