---
title: Migrate From Stytch
description: How to migrate your users from Stytch to FusionAuth
section: lifecycle
subcategory: migrate users
tertcategory: bulk
prerequisites: none
url: https://github.com/ritza-co/fusionauth_migrate_stytch
codeRoot: https://raw.githubusercontent.com/ritza-co/fusionauth_migrate_stytch/main
dateCreated: 2024-01-10
dateUpdated: none
---

import InlineUIElement from 'src/components/InlineUIElement.astro';
import InlineField from 'src/components/InlineField.astro';
import Aside from '/src/components/Aside.astro';
import {RemoteCode} from '@fusionauth/astro-components';

- [Todo](#todo)
- [Introduction](#introduction)
- [Request User Passwords From Stytch](#request-user-passwords-from-stytch)
  - [Email The Request](#email-the-request)
  - [Decrypt The Reply](#decrypt-the-reply)
  - [Common Problems With Hashes](#common-problems-with-hashes)
    - [Create Your Own User Manually To Test Hashing](#create-your-own-user-manually-to-test-hashing)
- [Extract User Details From Stytch](#extract-user-details-from-stytch)
- [Authentication Types](#authentication-types)


## Todo

- review overview page and add stytch concepts and terms
- create stytch account, add users, export them and all details
- https://stytch.com/docs/guides/migrations/migrating-user-data-statically
- review other services migration pages this references
- remove unused frontmatter

## Introduction

Review the overview article (link). Ensure you understand password hashing and salts (link). Mentions words below:

- Setup Dual Write: Modify the application to write to both the old system and Stytch.
- Perform Backfill: Export data from the old system and import it into Stytch.
- Final Sync: After backfill, ensure all data is up-to-date on both sides. Password hashes are final step.
- Cutover: Once confident in the data integrity and operation of Stytch, you can fully cutover to using it as the sole authentication system.

Alternatively, redirect new users to FusionAuth and you don't need to do dual write.
Rolling migration:
- keep all usernames in local database
- have a flag to indicate if they are new
- more difficult if your code has provider-specific code to interact with Stytch or FusionAuth. In this case, you need to extract an interface (contract) for what the code is doing, and write a second class that fulfils the contract. Your app can then call the same functions in either class, choosing whether to use new or old based on the user flag.

security risks of migration?
what login types does fusionauth support - magic email, passwordless, phone, google, facebook

## Request User Passwords From Stytch

You cannot download your users' password hashes from Stytch using their API. To get them, email support@stytch.com from the email address you used to sign up with Stytch. Ask support to send your users' hashes to you.

### Email The Request

Stytch will encrypt the hashes with your public key. Attach this key in a `.pem` file to the email you send Stytch.

To create a private and public key pair, use the commands below in a terminal.

```shell
openssl genpkey -algorithm RSA -out private_key.pem &&
openssl rsa -pubout -in private_key.pem -out public_key.pem
```

Email Stytch only `public_key.pem`. Keep `private_key.pem` secret and secure.

### Decrypt The Reply

Stytch will reply with two files: an encrypted password hash file (`something-hashes.enc`), and the key with which to decrypt it (`key.bin.enc`).

Decrypt the password file with the commands below.

```shell
openssl pkeyutl -decrypt -inkey private_key.pem -in key.bin.enc -out key.bin &&
openssl enc -d -aes-256-cbc -in something-hashes.enc -out stytch_password_hashes.csv -pass file:./key.bin
```

Now you have all your user hashes in the file `stytch_password_hashes.csv`.

Below is an example of the file content for three users.

```csv
scrypt hash parameters,,,,
scryptCostParameter,1 << 15,,,
scryptRParameter,8,,,
scryptPParameter,1,,,
scryptKeyLengthParamenter,32,,,
,,,,
id,hash,salt,hash_method,project_id

user-test-178d8ee5-c458-4f48-a482-8fefa30a1a87,uiOC_BwbKta9R9QL6Ss6KTDpCcULh9_zhObl5j4398M=,BbV-sGQqUIX1NwE6uqtSITv4fa1iMw==,scrypt,project-test-36510638-652a-4d3d-9a94-f0a7106582fc

user-test-799ea981-b2bb-417f-afe8-4ab6e79fcd2a,A6VzdsTsTHPqafORIb0GkGD6qFxdncqwA15YXRsVgvs=,XPapDAm6xdV5UhMpyPrSpy8FbfCDtA==,scrypt,project-test-36510638-652a-4d3d-9a94-f0a7106582fc

user-test-c1be12e4-fc61-4e7a-8831-0fc14cb87b65,8dg6AaIWPfcLTQU7lb4H-CI49dHeqaBXfFE1ogb2qRQ=,zKia-0BdIFKCzWbzXbj3qrhBnbiWNg==,scrypt,project-test-36510638-652a-4d3d-9a94-f0a7106582fc
```

The file header describes the parameters you need to use when running the Scrypt hashing algorithm to convert user passwords to match the hashes in this file.

Below the header are the column names, and then one row per user.

Even though you can create passwords for Stytch users with different hashing algorithms ([bcrypt, scrypt, argon2, MD-5, SHA-1, or PBKDF2](https://stytch.com/docs/api/password-migrate)), Scrypt is Stytch's preferred algorithm. Whenever a user logs in, Stytch will verify their password hash using the algorithm it is currently stored with, and then rehash their password using Scrypt and discard the old hash. Password rehashing is a common technique used to upgrade security as hashing algorithms evolve over time.

This means that the passwords you receive in the CSV file will almost all be in Scrypt format. However, there might be some users who haven't logged in in a long time, and their password hash uses a different algorithm.

### Common Problems With Hashes

Not all hash algorithms use separate salts. For instance, Bcrypt will create a salt automatically when hashing a password, and store the hash and salt concatenated in one string. You may have to deal with peculiarities of different algorithms like this if you previously migrated users into Stytch from an authentication provider that did not use Scrypt.

Even when using Scrypt with the given parameters, you need to carefully check that how you hash passwords has the same result as Stytch.

For instance, we can use this snippet of JavaScript below to create a hash for the last user in the example file above.

```js
import * as crypto from 'crypto';

const password = 'averylongandunguessablepasswordwithlotsofrandominfooofisjoafasnr;,n2';
const salt = 'zKia-0BdIFKCzWbzXbj3qrhBnbiWNg==';
const hash = '8dg6AaIWPfcLTQU7lb4H-CI49dHeqaBXfFE1ogb2qRQ=';

const cost = 1 << 15; // scryptCostParameter
const blockSize = 8; // scryptRParameter
const parallelization = 1; // scryptPParameter
const keyLength = 32; // scryptKeyLengthParamenter

crypto.scrypt(password, salt, keyLength, { N: cost, r: blockSize, p: parallelization, maxmem: 1024 * 1024 * 1024*50 }, (err, derivedKey) => {
    if (err) throw err;
    const keyBase64 = derivedKey.toString('base64');
    console.log('Computed hash:', keyBase64); //   8dg6AaIWPfcLTQU7lb4H+CI49dHeqaBXfFE1ogb2qRQ=
    console.log('Matches provided hash:', keyBase64 === hash);
});
```

Note that our hash algorithm looks correct, but the hashes differ by one character, `+`, in `8dg6AaIWPfcLTQU7lb4H-CI49dHeqaBXfFE1ogb2qRQ=` and `8dg6AaIWPfcLTQU7lb4H+CI49dHeqaBXfFE1ogb2qRQ=`.

This is because Stych uses alternative characters in Base64 encoding to make them safe in URLs. To have the hashes match correctly, you need to replace the `+` and `-` characters in your hash:

```js
const keyBase64 = derivedKey.toString('base64').replace(/\+/g, '-').replace(/\//g, '_');
```

#### Create Your Own User Manually To Test Hashing

If you find after migration that your users cannot log in to FusionAuth, you'll need to test why their password hashes are no longer matching. It's useful to have a known username, password, and hash to test this.

The easiest way to do this is manually create a user with the Stytch API, so that the user is included in your Stytch password export file.

Below is JavaScript code to do this.

```js
// npm install bcryptjs stytch;

import * as stytch from "stytch";
import * as bcrypt from 'bcryptjs';
import * as crypto from 'crypto';

const client = new stytch.Client({
    project_id: "project-test-36510638-652a-4d3d-9a94-f0a7106582fc",
    secret: "secret-test-m89L26ZKZgDm_Ox_IukmvE-pAID9_zPBROI=",
});

await validatePasswordsFromScrypt();
setTimeout(() => {
    console.log('This should not print if scrypt callbacks worked as expected.');
}, 10000);

// await client.users.delete({user_id: 'user-test-5368c4bc-22fd-437f-bb52-37524bbc3960'});
// await client.users.delete({user_id: 'user-test-c4a17eaa-49d8-4d52-91cb-2846a6e4c39b'});
// await client.users.delete({user_id: 'user-test-2143531a-c551-4628-92b8-9ba9d591b12c'});
// process.exit();

await createUser({ email: "user1@example.com", phone_number: '+272223334444',  first_name: 'A', last_name: 'Example', password: "averylongandunguessablepasswordwithlotsofrandominfooofisjoafasnr;,n1", algorithm: 'bcrypt'});
await createUser({ email: "user2@example.com", phone_number: '+272223334445',  first_name: 'B', last_name: 'Example', password: "averylongandunguessablepasswordwithlotsofrandominfooofisjoafasnr;,n2", algorithm: 'md_5'});
await createUser({ email: "user3@example.com", phone_number: '+272223334446',  first_name: 'C', last_name: 'Example', password: "averylongandunguessablepasswordwithlotsofrandominfooofisjoafasnr;,n3", algorithm: 'sha_1'});

async function createUser(p) {
    await client.users.create({ email: p.email, phone_number: p.phone_number,  name:{first_name: p.first_name, last_name: p.last_name}});

    if (p.algorithm == 'bcrypt') {
        const hash = await bcrypt.default.hash(p.password, 0);
        await client.passwords.migrate({
            email: p.email,
            hash: hash,
            hash_type: "bcrypt"
        });
        console.log(`Hash: ${hash}`);
    }
    if (p.algorithm == 'sha_1') {
        const { salt, hash } = hashPasswordSHA1(p.password);
        await client.passwords.migrate({
            email: p.email,
            "hash": hash,
            hash_type: "sha_1",
            sha_1_config: {prepend_salt: salt}
        });
        console.log(`Salt: ${salt}`);
        console.log(`Hash: ${hash}`);
    }
    if (p.algorithm == 'md_5') {
        const { salt, hash } = hashPasswordMd5(p.password);
        await client.passwords.migrate({
            email: p.email,
            "hash": hash,
            hash_type: "md_5",
            md_5_config: {prepend_salt: salt}
        });
        console.log(`Salt: ${salt}`);
        console.log(`Hash: ${hash}`);
    }
    console.log(`Email: ${p.email}`);
    const a = await client.passwords.authenticate({ email: p.email, password: p.password });
    // console.log(a);
    // const user = await client.users.get({user_id:'user-test-6a8fce8e-468f-43fa-989b-4e47ad8642cd'});
}

function hashPasswordMd5(password) {
    const salt = crypto.randomBytes(16).toString('hex');
    const hash = crypto.createHash('md5').update(salt + password).digest('hex');
    return { salt, hash };
}

function hashPasswordSHA1(password) {
    const salt = crypto.randomBytes(16).toString('hex');
    const hash = crypto.createHash('sha1').update(salt + password).digest('hex');
    return { salt, hash };
}

function validatePasswordsFromScrypt() {


    crypto.scrypt('GfG', 'ffdgsg', 32, (err, derivedKey) => {
        if (err) throw err;
        console.log("The derived key1 is :", derivedKey);
    });
    crypto.scrypt('GeeksforGeeks', 'tfytdx', 128,
        { N: 512 }, (err, derivedKey) => {
            if (err) throw err;
            console.log("The derived key2 is :", derivedKey);
            console.log();
        });
    return;


    const password = 'averylongandunguessablepasswordwithlotsofrandominfooofisjoafasnr;,n1';
    //const salt = Buffer.from('zKia-0BdIFKCzWbzXbj3qrhBnbiWNg==', 'base64');
    const salt = 'zKia-0BdIFKCzWbzXbj3qrhBnbiWNg==';
    const hash = '8dg6AaIWPfcLTQU7lb4H-CI49dHeqaBXfFE1ogb2qRQ=';

    const cost = 1 << 15; // scryptCostParameter
    const blockSize = 8; // scryptRParameter
    const parallelization = 1; // scryptPParameter
    const keyLength = 32; // scryptKeyLengthParamenter

    console.log('go');
    crypto.scrypt(password, salt, keyLength,  (err, derivedKey) => {
    // crypto.scrypt(password, salt, keyLength, { N: cost, r: blockSize, p: parallelization }, (err, derivedKey) => {
        console.log('start');
        if (err) console.log(err);
        if (err) throw err;
        const keyBase64 = derivedKey.toString('base64');
        console.log('Computed hash:', keyBase64);
        console.log('Matches provided hash:', keyBase64 === hash);
    });
}

// Hash: $2a$10$HWAQozc2WLIIVzaR930mLOMjhyA/Dcyg5Qs75v15ZIs4pRGhoRCQu
// Email: user1@example.com

// Salt: 85d5db9129d342deed702f303cb8dbb9
// Hash: 61c826f97988f58c591c2dcddb6e7ff7
// Email: user2@example.com

// Salt: c5dbbbf3134133fa7d226ed5c3c41a7f
// Hash: 96b65533c005370f9f221fb2d961078e44c569fa
// Email: user3@example.com

// from chatgpt:
// openssl genpkey -algorithm RSA -out private_key.pem && openssl rsa -pubout -in private_key.pem -out public_key.pem

// from stytch:
// openssl pkeyutl -decrypt -inkey private_key.pem -in key.bin.enc -out key.bin;
// openssl enc -d -aes-256-cbc -in stytch-project-test-36510638-652a-4d3d-9a94-f0a7106582fc-hashes-2021-01-11.enc -out stytch_password_hashes.csv -pass file:./key.bin
```

## Extract User Details From Stytch

## Authentication Types

passwords, passwordless, others?