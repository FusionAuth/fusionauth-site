---
title: Modeling Hierarchies
description: Using the FusionAuth Entity Management feature to model hierarchical organizations and users that belong to organizations.
navcategory: developer
section: extend
subcategory: examples
---

import Aside from 'src/components/Aside.astro';
import Breadcrumb from 'src/components/Breadcrumb.astro';
import CompanyDiagram from 'src/diagrams/docs/extend/examples/modeling-hierarchies/company.astro'
import HierarchyDiagram from 'src/diagrams/docs/extend/examples/modeling-hierarchies/hierarchy.astro'
import InlineField from 'src/components/InlineField.astro';
import InlineUIElement from 'src/components/InlineUIElement.astro';
import PremiumPlanBlurb from 'src/content/docs/_shared/_premium-plan-blurb.astro';
import TypesDiagram from 'src/diagrams/docs/extend/examples/modeling-hierarchies/types.astro'

This guide discusses ways of modeling hierarchical organizations and entities, with users and permissions, and provides an example script you can use in your own website. Entities are not available in the free version of FusionAuth.

<PremiumPlanBlurb />

## Understand FusionAuth Types and Their Relationships

Before continuing, please read the [review of FusionAuth types](/docs/get-started/core-concepts/types-and-relationships) and how they relate. You need to understand these types well to adjust the hierarchical system design in this guide to suit your situation.

To avoid confusion with FusionAuth applications in this guide, the service you provide your users will be called your "website", as opposed to an application, app, or service.

## An Example Company Hierarchy with Permissions

None of the FusionAuth types are hierarchical. In other words, no types can be nested in any other types. Groups can't be members of groups, applications can't contain other applications, and entities don't have sub-entities.

This is a problem when trying to model organizations that are hierarchical, especially when trying to decide when a user who has permissions to one level of the hierarchy should have permissions to an entity somewhere in the hierarchy.

Let's take an example. Assume that you want to use FusionAuth to authorize users in your corporation, Change Corp, to have access to certain documents. Your corporation has two sub-companies: Change Bank and Change Insurance. Each company has many departments, like marketing, sales, finance, operations, and management. Documents belong to a single department in an organization. Companies, departments, and documents have read and write permissions.

Permissions propagate downwards. So an employee with write permissions to the marketing department in Change Insurance will have write permissions to all its documents. And an employee with read permissions to Change Corp has read permissions to every document in every department of both sub-companies. But you might have an auditor who you add as a user in FusionAuth that has only read access to a specific document in a specific department. This will not give her permissions to any other documents anywhere higher in the organizational hierarchy.

Below is a diagram of the company structure to model.

![Company diagram](/img/docs/extend/examples/modeling-hierarchy/mermaid2.webp)

<Aside type="note">
You can probably see some challenges already:
- How do you handle documents that everyone in the corporation needs to read, such as a corporate HR manual, which is managed by the HR department of the top-level corporation? Because permissions don't propagate upwards, you have to individually give read permissions to everyone, instead of relying on the hierarchy to do it automatically.
- What happens when permissions conflict? The operations department might have a passwords document that should have read access only by members of that department, but anyone with read access to the sub-company will have access to the passwords.

There are solutions to these problems, such as including "Deny access" permissions and a "Common" department for shared documents, and you need to pick what works for your organization. These challenges won't be discussed in this guide, as you can use the techniques shown here to implement your own solution.
</Aside>

## How to Model Hierarchy in FusionAuth with Entities and Grants

The best way to model a hierarchy in FusionAuth is with Entities. 

For the example above, you should create entity types Company and Department with permissions Read, Write, and IsMember. Read and write are used to show permissions, but IsMember is used to show hierarchy. 

Then create an entity called Change Bank of type Company and entity of Department called Operations. Create an entity grant for Operations to Change Bank with IsMember set to true to show that this Operations entity belongs to the Change Bank entity. Note that it will not be possible to tell departments called Operations in different companies apart by their name alone. You will need to examine each department's entity grant to see which company it belongs to. 

Finally, you'll create an entity grant for user Alice to entity Change Bank with no permissions, and an entity grant for Alice to Operations with permissions Read and Write. Below is a diagram of this example, which is similar to the earlier types diagram, but includes a department hierarchy now. Permissions are shown in separate blocks now too.

![Hierarchy diagram](/img/docs/extend/examples/modeling-hierarchy/mermaid3.webp)

For simplicity's sake, this diagram does not include the Change Corp entity of entity type Corporation. There are two blocks: one for Change Insurance and one for Change Bank. Ignore the Change Insurance block and concentrate on Change Bank to see how Alice is connected to her department, which is connected to the company. This diagram also shows a document attached to the Operations department. The document itself needs read and write permissions, for when you want to enable individual access, and is linked to the Operations department via an entity grant with the IsMember permission, in the same way departments are linked to companies.

Finally, note that you should use a matching UUID for every document in your document management system and in FusionAuth, to handle situations where document names and versions change.

## Example Permissions Calculation Script

This section demonstrates how to create all the entities for the example company hierarchy, and how to write a script to determine a user's permissions to any document in the hierarchy.

### Install FusionAuth

If you haven't already installed FusionAuth, you should follow the instructions on our [Download](/download) page or you can follow the process in our [Getting Started](/docs/get-started/start-here/step-1) guide.

If you already have FusionAuth running locally, you are welcome to use that instance. However, the rest of this guide assumes you have a user with the email `richard@example.com` and an admin user with the email `admin@example.com`. You might need to translate those users depending on your setup.

### Create Hierarchy Entities

In this section, you'll create the entities and permissions in FusionAuth to represent a company hierarchy with documents.

- Browse to <Breadcrumb>Entity Management -> Entity Types</Breadcrumb>.
- Click the <InlineUIElement>+ Add</InlineUIElement> button.
- Name the entity type `Company`.
- Add the permissions `Read`, `Write`, and `IsMember` and save the entity type.
- Add another entity type called `Department` with the same permission names and save it.
- Add a final entity type called `Document` with only `Read` and `Write` permissions. Nothing can be a member of a document, so it doesn't need an `IsMember` permission.

![Entity Types in FusionAuth](/img/docs/extend/examples/modeling-hierarchy/entityTypes.png)

Next you'll populate FusionAuth with some entities of these types:

- Browse to <Breadcrumb>Entity Management -> Entities</Breadcrumb>.
- Add a new entity.
  - For <InlineField>Name</InlineField> enter `Change Bank`.
  - For <InlineField>Entity type</InlineField> choose `Company`.
  - You don't need to give the entity an Id since FusionAuth alone will manage companies and users. Only documents need to share Ids between FusionAuth and your website.
  - Save.
- Add another entity of type Company and call it `Change Insurance`.
- Add another entity of type Department and call it `Change Insurance Operations`.
- Add another entity of type Department and call it `Change Bank Operations`.
- Add another entity of type Department and call it `Change Bank Finance`.
- Add another entity of type Document and call it `Passwords`.
  - Give this entity the Id `e52925cb-1072-421f-9f64-a64aacd8a7cb`.
- Add another entity of type Document and call it `Statements`.
  - Give this entity the Id `832bf368-6adc-4ae0-b838-41feeb01ac47`.

![Entities in FusionAuth](/img/docs/extend/examples/modeling-hierarchy/entities.png)

Finally, you need to connect the entities in a hierarchy using permissions as a link.

- In the <InlineUIElement>Select</InlineUIElement> menu for the `Change Bank Operations` department entity, click <InlineUIElement>Manage</InlineUIElement>.
- Click <InlineUIElement>+ Add</InlineUIElement> to add an entity grant.
- In the search box, enter `Change Bank`, and select it from the dropdown list.
- Enable the <InlineUIElement>IsMember</InlineUIElement> permission.
- Save.
- Return to <Breadcrumb>Entity Management -> Entities</Breadcrumb>.
- Add the `Change Bank Finance` department entity to the `Change Bank` company in the same way as above.
- Add the `Change Insurance Operations` department entity to the `Change Insurance` company in the same way as above.
- Change Bank now has two departments and `Change Insurance` has one.
- Manage the `Passwords` document, and give it an entity grant to the `Change Bank Operations` department with permission IsMember.
- Manage the `Statements` document, and give it an entity grant to the `Change Bank Finance` department with permission IsMember.

<Aside type="caution">
Notice here that when you search for `Operations`, the search dropdown list provides you only the names `Change Bank Operations` and `Change Insurance Operations`, with no Ids or hierarchical links displayed. So if you had instead called both departments just `Operations`, without indicating the company they belonged to in their name, you wouldn't know which department to choose when trying to add the document to the department. Though it would be more elegant to call the entity by the same name as the real department, just `Operations`, you need to work with the limitations of FusionAuth here to create a makeshift hierarchy. Alternatively, you could create all entities programmatically using the API and entity Ids. That would allow you to use any names you wanted.
</Aside>

### Grant Entity Permissions to a User

You haven't set any read or write permissions yet, because those are linked only to users, or flow implicitly downwards through the company hierarchy set by `IsMember`. So let's add a user to the Operations department.

- Browse to <Breadcrumb>Users</Breadcrumb>.
- From the <InlineUIElement>Select</InlineUIElement> menu for user `Richard`, choose <InlineUIElement>Manage</InlineUIElement>.
- In the <InlineUIElement>Entity grants</InlineUIElement> tab, click <InlineUIElement>+ Add</InlineUIElement>.
- Search for and add `Change Bank Operations`.
- Enable all three permissions for the user and save.

![User with entity grant in FusionAuth](/img/docs/extend/examples/modeling-hierarchy/user.png)

FusionAuth now represents your corporate hierarchy and you can start work on the website.

### Calculate all the User Permissions

<Aside type="note" title="Prequisites">
  You will need Node 22.x or newer to run this example. Use the [Node installation guide](https://nodejs.org/en/download) to install Node if you haven't already
</Aside>

In this section, you'll write a small application that retrieves the direct and indirect (through the company hierarchy) permissions a user has to all documents in FusionAuth. All you need is the user's email address or Id. Though this is a simple script, you can use exactly the same code after the user has logged in to your website with FusionAuth. (To learn how to make a simple Node.js website that uses FusionAuth, read the [quickstart](/docs/quickstarts/quickstart-javascript-express-web).)

For this script, you'll use TypeScript. It's easy to make errors when working with a tree structure, like these parent and child entities. TypeScript's strong typing will prevent errors, and enable you to see exactly which properties are available on each object.

Start by creating a directory for our application called `app`. Then change into this directory and set up a Node project like this:

```shell
mkdir app
cd app
npm init --yes
npm install @fusionauth/typescript-client
npm install typescript
```

This example is also using ESM and Typescript modules, so you'll need to create a file named `tsconfig.json` and add this to it:

```json
{
  "compilerOptions": {
    "allowImportingTsExtensions": true,
    "erasableSyntaxOnly": true,
    "noEmit": true,
    "module": "NodeNext",
    "rewriteRelativeImportExtensions": true,
    "target": "ESNext",
    "verbatimModuleSyntax": true
  }
}
```

And finally, open the `package.json` file and add this attribute to the top level:

```json
"type": "module",
```

This will ensure that Typescript and Node correctly execute the code below.

Next, create a file called `getPermissions.mts` and copy the code below into it.

This code uses the FusionAuth Typescript client library to retrieve all of the entity information for our documents. Here's the code:

```ts
// #1 - Import the FusionAuth client and initialize it
import {type Entity, type EntityGrant, FusionAuthClient} from '@fusionauth/typescript-client';
const client = new FusionAuthClient('<YOUR-API-KEY>', 'http://localhost:9011');

// #2 - Create a Permission type we can use for displaying the result to the console
type Permission = {
  entityId: string;
  entityName: string;
  permissions: Set<string>;
};

// #3 - Determine all the permissions for a user
async function getUserPermissions(emailAddress: string): Promise<void> {
  // #4 - get user, entities, and grants from fusionauth
  const user = (await client.retrieveUserByEmail(emailAddress)).response.user;
  const userGrants = (await client.searchEntityGrants({search: {userId: user.id}})).response.grants;
  const entities = (await client.searchEntities({search: {queryString: "*"}})).response.entities

  // #5 - get all grants for all the entities
  const entityGrants: EntityGrant[] = [];
  for (const entity of entities) {
    const grants = (await client.searchEntityGrants({search: {entityId: entity.id}})).response.grants;
    entityGrants.push(...grants);
  }

  // #6 - determine all the permissions to documents
  const permissionsToDocuments: Permission[] = [];
  for (const document of entities.filter(e => e.type.name == 'Document')) {
    // Add an empty permission to start
    permissionsToDocuments.push({ entityId: document.id, entityName: document.name, permissions: new Set() });

    // Loop through all the entities in the hierarchy, starting from the document and traversing to its ancestors
    const entitiesWithPermissionsToDocument : Entity[] = [];
    let currentEntity: Entity | null = document;
    while (currentEntity != null) {
      entitiesWithPermissionsToDocument.push(currentEntity);
      currentEntity = getEntityParent(currentEntity, entities, entityGrants);
    }

    // If the user has access to any of the documents directly, or the document's ancestors, add it to the list
    for (const entityWithPermissionsToDocument of entitiesWithPermissionsToDocument) {
      userGrants.find(grant => grant.entity.id === entityWithPermissionsToDocument.id)
          ?.permissions
          .map(p => permissionsToDocuments.at(-1)?.permissions.add(p));
    }
  }

  // #7 - Output the permissions
  console.log('All documents and permissions to them for ' + emailAddress + '\n');
  console.dir(permissionsToDocuments, { depth: null });
}

// #8 - Traverse up the hierarchy to find additional permissions
function getEntityParent(entity: Entity, entities: Entity[], entityGrants: EntityGrant[]): Entity | null {
  for (const entityGrant of entityGrants) {
    if (entityGrant.recipientEntityId == entity.id && entityGrant.permissions.includes('IsMember')) {
      for (const parentEntity of entities) {
        if (parentEntity.id == entityGrant.entity.id) {
          return parentEntity;
        }
      }
    }
  }

  return null;
}

// #9 - Call the main function for a user
await getUserPermissions('richard@example.com');
```

Let's walk through what this script is doing in each step.

1. Here we are importing the FusionAuth client library for Typescript and initializing it. You'll need to supply a valid API key and we recommend not hardcoding API keys in code for production applications
2. Create a simple type that we can use to track permissions the user has to entities in the hierarchy. This will be displayed at the end
3. The main function that determines the permissions
4. Fetch the user, entity grants the user has, and all of the entities. In a real-world application, we don't recommend fetching all of the entities. We also recommend adding lots of null and error checks to ensure that the user exists an they have entity grants with permissions
5. Retrieve all of the entity grants for all of the entities. Again, this is not recommended in production applications since you could have thousands or even millions of entities and this code could crash the server
6. This is the tricky part of the code. It loops over all of the documents by finding the entities with the type of `Document`. Then it creates an empty `Permission` object as a placeholder. From there, it determines if the user has any entity grants with permissions to that entity. If they don't, it checks the parent of the entity using the `IsMember` permission which connects one entity to another entity.
7. After all of the permissions have been determined, they are output to the console
8. This function is a traversal of the hierarchy. It loops of all of the entity grants and determines if the current entity is connected to another entity using the `IsMember` permission
9. This calls the main function with the email address for one of our users. If you don't have a user with the email `richard@example.com`, you'll have to change this line of code

If you want to learn more about the obejcts used in the example above, you can view out API docs for [users](/docs/apis/users), [entities](/docs/apis/entities/entities), and [grants](/docs/apis/entities/grants).

Let's run this code and see what it outputs. In the console, run this command:

```sh
node --experimental-strip-types getPermissions.mts
```

The result should look something like this:

```text
All documents and permissions to them for richard@example.com

[
  {
    entityId: "e52925cb-1072-421f-9f64-a64aacd8a7cb",
    entityName: "Passwords",
    permissions: Set(3) { "IsMember", "Read", "Write" }
  },
  {
    entityId: "832bf368-6adc-4ae0-b838-41feeb01ac47",
    entityName: "Statements",
    permissions: Set(0) {}
  }
]
```

You can see the user has permissions to the passwords document because he is a member of the Operations department where the document is a member.

On the flip side, the user has no permissions to the financial statements.

Let's change the user's permissions in the FusionAuth admin UI. Navigate to the User and click on his Entity Grants. Here, let's give him `Write` permission to the `Change Bank` entity. Since the `Change Bank` is the parent of the `Change Bank Finance` entity, which is the parent of the `Statements` entity, this will grant Richard permission to that document.

Let's run the script again and see the new output. It should look something like this:

```text
All documents and permissions to them for richard@example.com

[
  {
    entityId: "e52925cb-1072-421f-9f64-a64aacd8a7cb",
    entityName: "Passwords",
    permissions: Set(3) { "IsMember", "Read", "Write" }
  },
  {
    entityId: "832bf368-6adc-4ae0-b838-41feeb01ac47",
    entityName: "Statements",
    permissions: Set(1) { "Write" }
  }
]
```

## Alternative Methods to Model Hierarchy in FusionAuth

The code above demonstrates modeling hierarchies using entities, but there are other ways to model the example company structure in FusionAuth.

Once approach is to use custom data on the User object. In this option, you store every user's company and department as properties in their JSON `user.data` field. This has to be done through the FusionAuth API, and cannot be maintained in the FusionAuth web interface. You will need to write your own UI app for your staff to work with FusionAuth. With this approach, you technically don't need to use Entity or any other objects in FusionAuth outside of the User object. Below is example JSON data for Alice:

```json
{
  "permissions": {
    "Change Bank": [],
    "Change Bank Operations": ["read", "write"],
    "Change Bank Human Resources manual": ["read"]
  }
}
```

You can also use ids rather than strings for the keys inside this JSON object.