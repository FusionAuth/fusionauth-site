---
title: Device Limiting
description: Learn how to limit the number of devices a user can log in to concurrently.
navcategory: developer
section: extend
subcategory: examples
codeRootSimple: https://raw.githubusercontent.com/FusionAuth/fusionauth-device-limit-guide-simple/main
codeRootFriendly: https://raw.githubusercontent.com/FusionAuth/fusionauth-device-limit-guide-friendly/main
---
import Aside from 'src/components/Aside.astro';
import InlineField from 'src/components/InlineField.astro';
import InlineUIElement from 'src/components/InlineUIElement.astro';
import {RemoteCode, RemoteValue} from '@fusionauth/astro-components';

This guide will help you limit concurrent logins on user devices with FusionAuth. Many apps limit the number of devices a user can log in to concurrently. 

## Why Limit Device Logins?

There are multiple reasons why you might be interested in limiting concurrent user logins. Here are a few examples.

* For security reasons, to ensure that a user's account isn't compromised. For example, if you create a banking app, it would be unlikely that a user would need to log in from multiple devices at the same time. However, for an email application, this would not be the case.

* To prevent account sharing, especially for paid consumer content services. This is common on media streaming services, for example.

* To enforce a licensing agreement for enterprise software. This is common for software that is licensed per user, such as a CRM or project management tool, and the per user cost is significant.

You can also see requests from FusionAuth customers looking to implement device limiting schemes on our GitHub issues page: 

* [Limit a user to a single session](https://github.com/FusionAuth/fusionauth-issues/issues/1363).

* [Limit the number of different devices an account can login from](https://github.com/FusionAuth/fusionauth-issues/issues/1156).

This guide provides a way to address these requirements and user requests. While FusionAuth does not directly support limiting device logins, you can implement a solution using FusionAuth APIs and custom logic in your application.

FusionAuth only captures limited information about each device as part of the session information. Devices are not tracked separately, and a user may have multiple sessions on the same device (e.g. on different browsers or in private browsing mode). So a device is really anything where a user logs in (Chrome and Firefox on the same computer are two 'devices').

## Approaches To Device Limiting

This guide will cover two approaches to limiting concurrent logins. Both approaches rely on the [JWT Retrieve Refresh Tokens API](/docs/apis/jwt#retrieve-refresh-tokens) to retrieve the number of active refresh tokens for a user as a proxy for active logins.

 * **Simpler implementation:** The user will simply be informed that they are logged in to too many devices and will be asked to log out of one of them manually, and then try logging in again. By logging out of one of the sessions, the refresh token for that session will be revoked by FusionAuth.

 * **More user-friendly implementation:** The list of current logins will be displayed and the user will be able to select which session to end. The application will then call the FusionAuth API to end the session, by [revoking the refresh token](/docs/apis/jwt#revoke-refresh-tokens) for the chosen session.

 For the second option to work, the user JWTs issued by FusionAuth must be configured to relatively short lifespans to prevent the user from staying logged in on the additional devices long after the corresponding refresh token has been revoked. 

## The ChangeBank Application

To make things a bit more concrete, let's use an example from the [FusionAuth QuickStart Guides](/docs/quickstarts/quickstart-javascript-express-web). The [ChangeBank](https://www.youtube.com/watch?v=CXDxNCzUspM) application is a simple banking application that allows users to convert dollars into coins.

This guide will show two ways to extend the [express based](https://expressjs.com) [ChangeBank application](/docs/quickstarts/quickstart-javascript-express-web) to limit concurrent logins.

Full implementations of both device limiting methods in the ChangeBank application are available on GitHub at:
-  [Simple Guide Full Application](https://github.com/FusionAuth/fusionauth-device-limit-guide-simple)
-  [User Friendly Guide Full Application](https://github.com/FusionAuth/fusionauth-device-limit-guide-friendly)


## Login Requirements

Since the crux of the solution relies on the number of active refresh tokens for a user, you will need to ensure that your FusionAuth application is set up to issue refresh tokens, and that your client application requests them when logging in. 

To ensure that your FusionAuth application is set up to issue refresh tokens, navigate to <strong>Applications -> Edit -> JWT Configuration</strong>. Ensure that <InlineField>Issue Refresh Tokens</InlineField> is checked.

To ensure that your client application requests refresh tokens when logging in, [ensure that the `offline_access` scope](/docs/lifecycle/authenticate-users/oauth/) is included in the `scope` parameter of the `/oauth2/authorize` request. If you are constructing the request manually, it should look something like this:

```javascript
res.redirect(302, `${fusionAuthURL}/oauth2/authorize?client_id=${clientId}&response_type=code&scope=offline_access&redirect_uri=http://localhost:${port}/oauth-redirect&state=${userSessionCookie?.stateValue}&code_challenge=${userSessionCookie?.challenge}&code_challenge_method=S256`)
```
If you are using Passport.js, you can include the `offline_access` scope in the `scope` key of the options object passed to the `authenticate` method. It should look something like this:

```javascript
passport.authenticate('oauth2', { scope: ['offline_access'] })
```
For other libraries and languages, consult the documentation to see how to include the `offline_access` scope in the authorization request to FusionAuth.

## Using the Refresh Token API

Both solutions depend on calling the FusionAuth API to retrieve the active [refresh tokens](/docs/apis/jwt) for a user, using the [JWT Retrieve Refresh Tokens API](/docs/apis/jwt#retrieve-refresh-tokens). This API requires an [API key](/docs/apis/api-keys). You will use it with the GET and DELETE permissions for the `/api/jwt/refresh` API route in this guide.

To create this key, navigate to <strong>Settings -> API Keys</strong> and click the <InlineUIElement>+</InlineUIElement> button to add a key. Give the key a name, and enable the GET and DELETE permissions for `/api/jwt/refresh`. Click <InlineUIElement>Save API Key</InlineUIElement>.

Once you have the key, you will be able to use it to call the API to retrieve the active refresh tokens for a user. Note that refresh tokens for all applications will be returned, so you will need to filter the tokens by the `applicationId` to get the number of active sessions for a specific application. Also note that refresh tokens without an `applicationId` may also be present. These tokens are used for the "Remember me" feature on FusionAuth itself, and should be ignored when counting the number of active sessions for a user.

Thereafter, the number of filtered active refresh tokens for the particular application can be used as a proxy for the number of active logins for the user. Calling the API using Node and filtering the results looks something like this:

<RemoteCode url={frontmatter.codeRootSimple + "/complete-application/src/index.ts"} tags="active-session-count" lang="typescript"/>

The variable `clientId` stores the FusionAuth application ID for the application you are limiting logins for. The `userId` is the ID of the user you are checking the active sessions for.

## Simpler Scheme

This scheme uses the FusionAuth [`user.login.success`](/docs/extend/events-and-webhooks/events/user-login-success) webhook. This webhook is fired after a user provides valid credentials, but before a session is created and the user logged in. Returning a `2xx` response from this webhook will allow the login to proceed. Returning a `4xx` response will prevent the login from proceeding. Since a FusionAuth webhook is enabled at the tenant level, you will also need to check the application the the user is attempting to log in to when implementing this solution. The `applicationId` is provided in the webhook payload, along with the `userId`, among other information.

This scheme uses the Refresh Token API explained above to retrieve the number of active sessions for a user. If the user is logged in on too many devices, the login will be prevented by returning a `403` response from the webhook. They will then need to log out of one of their other devices before they can attempt to log in again.

To let the user know that the reason the login failed was because they were logged in to too many devices, the default message for a failed webhook needs to be overridden with a custom message. Note that this message will be displayed for any failed login due to any webhook error, not just for failed logins due to too many concurrent logins. Therefore this solution is not ideal if your application uses other webhooks. 

### Create A Webhook In FusionAuth

To add the webhook to FusionAuth, navigate to <strong>Settings -> Webhooks</strong> in the sidebar. Click the <InlineUIElement>+</InlineUIElement> button to add a webhook. Give the webhook a name, and select the <InlineField>user.login.success </InlineField> event. Set the URL to `http://{YOUR_APPLICATION_URL}/user-login-success`. Click <InlineUIElement>Save Webhook</InlineUIElement> when you are done.

<Aside type="note">
In production you should [add security to the webhook](/docs/extend/events-and-webhooks/#security) in the form of Basic Auth and a certificate by navigating to the <strong>Security</strong> tab. This ensures that the webhook can only be called by FusionAuth.
</Aside>

### Listen To The Webhook

In the application, you will need to listen for the `user.login.success` event and check the number of active sessions for the user. Here is an example of how to do this in an Express application, like the ChangeBank application.

<RemoteCode url={frontmatter.codeRootSimple + "/complete-application/src/index.ts"} tags="device-limiting" lang="typescript"/>

As described in the [documentation](/docs/extend/events-and-webhooks/events/user-login-success), the event data sent by FusionAuth as JSON in the body of the webhook includes the `applicationId` and `userId` among other information. The `applicationId` is used to check that the login event is for the application you are limiting logins for. The `userId` is used to retrieve the active refresh tokens for the user.

Try running your application with the webhook connected and logging in with the same user on more than 2 devices. You can simulate multiple devices by logging in with multiple browsers and with private tabs. You should see the following message when trying to log in for the third time:

```
One or more webhooks returned an invalid response or were unreachable. Based on your transaction configuration, your action cannot be completed.
```

This message is very generic, and does not tell the user that the reason they cannot log in is because they are logged in on too many devices. To fix this, override the default message with a custom message. You can do this by customizing the <InlineField>WebhookTransactionException</InlineField> message in your FusionAuth theme templates. 

To do this, navigate to <strong>Customizations -> Themes</strong>. Click the <InlineUIElement>Edit</InlineUIElement> button next to the "ChangeBank Theme". Under <InlineField>Templates</InlineField>, click <InlineUIElement>Messages</InlineUIElement>. Click the <InlineUIElement>Edit</InlineUIElement> button next to the <InlineField>Default</InlineField> Locale. Search for `[WebhookTransactionException]` (approx. line 606), and change the message to read something more explanatory such as "You are already logged in on other devices. Please log out of one of your other devices and try again". Click <InlineUIElement>Submit</InlineUIElement> , and then save the theme as well.

Logging in again with the same user on more than 2 devices should now display the new message.

## The User Friendly Implementation

The previous implementation has the advantage of code simplicity, but it does have a few problems. 

* The first is inconvenience - the user has to manually log out of one of their devices before they can log in again. 

* The second is that the user is not informed of which devices they are logged in on. They will have to try remember which of their devices they are logged in on. If they don't have physical access to one of their devices, they will be unable to log in. 

* The third is that the message used to inform the user that they are logged in on too many devices is the same generic message used for all webhook errors. Therefore adding other webhooks to your application will result in the same error message being displayed, regardless of the type of webhook failing. 

This second implementation provides a more user friendly way of handling device limits. It saves the user the trouble of having to manually log out of one of their devices. Instead, the user will be presented with a list of their current logins, and will be able to select which sessions to end. The application will then call the FusionAuth API to end the session, by [revoking the refresh token](/docs/apis/jwt#revoke-refresh-tokens) for the chosen sessions.

To achieve this, the application will always allow a login to proceed, and once logged in will call the FusionAuth API to retrieve the other sessions to check if the device limit has been reached. Before allowing the user to access the rest of the app, a page will display the user's current logins, and allow them to select which session to end.

To implement this solution, you will need to: 

* Set the lifespan of the ordinary user JWT to a relatively short time to prevent staying logged in even after the corresponding refresh token has been revoked. 

* Create a middleware function to call the FusionAuth API to retrieve the number of active sessions for a user for each request.

* Create a page to display the user's current logins and allow them to select which session to end. The middleware above will redirect the user to this page if they are logged in on too many devices.

* Create a route to handle the user's selection and call the FusionAuth API to revoke the refresh token for the selected session.


### Setting The JWT Lifespan

To set the JWT lifespan navigate to <strong>Applications</strong> in the sidebar of FusionAuth. Select the <InlineUIElement>Edit</InlineUIElement> button next to the application you are limiting logins for. Under the <strong>JWT</strong> tab, set the <InlineField>JWT duration</InlineField> to a relatively short time, such as 300 seconds (5 minutes). Click <InlineUIElement>Save Application</InlineUIElement> when you are done.

### Create A Middleware Security Function

For any route that you would normally check for authentication, you will need to add an additional middleware function to check the number of active sessions for the authenticated user. The middleware should check for the number of active sessions using the refresh token API as described earlier. If the user is logged in on too many devices, the middleware should redirect the user to a page to display the user's current logins and allow them to select which session to end.

The middleware function should look similar to this:

<RemoteCode url={frontmatter.codeRootFriendly + "/complete-application/src/index.ts"} tags="get-active-devicelist" lang="typescript"/>

Notice that in the `getActiveDeviceList` function, the current session's refresh token is removed from the list of active sessions. This is because it would not make sense to allow the user to end the current session to continue using the application. The userID is also retrieved from the existing authentication cookie. For this reason, the device limit middleware must always be placed after the user authentication and token validation middleware for any secured route. 

The `getActiveDeviceList` function returns a list of view models containing all the session information for the user. This list of view models will also be used to display the user's current logins and allow them to select which session to end.

The middleware function `checkDeviceLimit` can be used on restricted routes, such as the `make-change` and `account` routes in the ChangeBank app, like this:

<RemoteCode url={frontmatter.codeRootFriendly + "/complete-application/src/index.ts"} tags="make-change-check-devicelimit" lang="typescript"/>

### Create A Page To Display The User's Current Logins

The middleware above redirects to a route called `/device-limit`. This route should return a web page to display the user's current logins and allow them to select which session to end. To pass the list of active sessions with their details, you will need to use a template engine such as Handlebars to simplify the HTML generation. You can add handlebars to the ChangeBank application using NPM: 

```bash
npm install handlebars
```
Then you can add it to the express app like this:

<RemoteCode url={frontmatter.codeRootFriendly + "/complete-application/src/index.ts"} tags="views-hbs" lang="typescript"/>

 You will require a `GET` route to render the `device-limit` page. The route should look something like this:

<RemoteCode url={frontmatter.codeRootFriendly + "/complete-application/src/index.ts"} tags="device-limiting-maxcount" lang="typescript"/>

The handlebars template page should look like this:

<RemoteCode url={frontmatter.codeRootFriendly + "/complete-application/templates/device-limit.hbs"} lang="html"/>

### Revoking A Chosen Session

The web page posts back the selected token IDs to the backend. You will need a route that accepts these token IDs, as well as revokes the selected tokens using the 'DELETE' method on the FusionAUth Refresh Token API. 

<RemoteCode url={frontmatter.codeRootFriendly + "/complete-application/src/index.ts"} tags="device-limiting-validatetoken" lang="typescript"/>

## Example Applications

You can download, review and run full applications for both the simple and user friendly device limiting implementations from the FusionAuth GitHub: 

 * [Simple (Webhook) implementation](https://github.com/FusionAuth/fusionauth-device-limit-guide-simple). 

 * [User Friendly implementation](https://github.com/FusionAuth/fusionauth-device-limit-guide-friendly). 
