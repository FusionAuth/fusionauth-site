---
title: Splunk Setup
description: Learn how to set up Splunk to work with FusionAuth.
navcategory: admin
section: operate
subcategory: secure and monitor
---
import Aside from 'src/components/Aside.astro';
import InlineField from 'src/components/InlineField.astro';
import PrometheusJvmGauges from 'src/content/docs/_shared/_prometheus-jvm-gauges.mdx';

- [TODO](#todo)
- [Introduction](#introduction)
- [FusionAuth Metrics](#fusionauth-metrics)
  - [Audit Log](#audit-log)
  - [The Event Log](#the-event-log)
  - [Login Records](#login-records)
  - [Logs](#logs)
- [Splunk Setup](#splunk-setup)
- [Import Data To Splunk With The API](#import-data-to-splunk-with-the-api)
- [Import Data To Splunk With Logs](#import-data-to-splunk-with-logs)
- [Import Data To Splunk With OpenTelemetry And Java](#import-data-to-splunk-with-opentelemetry-and-java)
- [Import Data To Splunk With The OpenTelemetry Linux Collector](#import-data-to-splunk-with-the-opentelemetry-linux-collector)
- [Further Reading](#further-reading)


## TODO

- brief - https://docs.google.com/document/d/1g5O1V4aHyHgqwJTt5lbPnz9rYRTJqRkYf3z2-KhcHiw/edit
- create splunk account
- connect fusionauth docker to splunk
- read monitor docs and connect every single link - api, log files
  - What Fusionauth data makes sense in a Splunk context? Only metrics or also logs etc?
  - How does Fusionauth feed data to Splunk? Pull, Push? Both options?
  - https://dev.splunk.com/enterprise/docs/developapps/manageknowledge/custominputs/
- Create a basic Dashboard and show the Fusionauth metrics from fusionauth.ritza.co on Splunk
- Document everything
- https://docs.splunk.com/observability/en/gdi/opentelemetry/collector-linux/collector-configuration-tutorial/collector-config-tutorial-start.html
- https://community.splunk.com/t5/Getting-Data-In/Cannot-create-token-or-find-realm/m-p/689536#M114771

## Introduction

> [Splunk Observability Cloud is a Software as a Service (SaaS) solution for infrastructure monitoring (Splunk IM), application performance monitoring (Splunk APM), real user monitoring (Splunk RUM), and synthetic monitoring (Splunk Synthetic Monitoring). Splunk Observability Cloud also provides a direct integration with logs ingested in Splunk Cloud Platform and Splunk Enterprise through Log Observer Connect.](https://docs.splunk.com/observability/en/get-started/service-description.html)

Splunk has two sets of docmentation, the [primary](https://docs.splunk.com/observability/en/) and the [developer](https://dev.splunk.com/observability/docs).

## FusionAuth Metrics

https://fusionauth.io/docs/operate/secure-and-monitor/monitor#metrics
- [Application events](https://fusionauth.io/docs/extend/events-and-webhooks/events/)
- [Metrics](https://fusionauth.io/docs/apis/system#retrieve-system-status)
- OpenTelemetry data

### Audit Log

The Audit Log contains changes to database tables. To see it, browse to <strong>System -> Audit Log</strong>. Below is an entry example:

```
Id:	47
Created:	5/16/2024 12:43 PM SAST
User:	workaddress/fa@simplelogin.com
Reason:	FusionAuth User Interface
Message:	Updated the tenant with Id [d7d09513-a3f5-401c-9685-34ab6c552453] and name [Default]
Old value: JSON
New value: JSON
```

### The Event Log

The Event Log contains errors. To see it, browse to <strong>System -> Event Log</strong>. Below is an entry example:

```
Id:	40
Created:	5/16/2024 12:43 PM SAST
Type:	Debug

Email debug information

5/16/2024 10:43:58 AM Z DEBUG: getProvider() returning jakarta.mail.Provider[TRANSPORT,smtp,org.eclipse.angus.mail.smtp.SMTPTransport,Oracle]
DEBUG SMTP: need username and password for authentication
DEBUG SMTP: protocolConnect returning false, host=smtp.sendgrid.net, user=apikey, password=<null>
DEBUG SMTP: useEhlo true, useAuth true
DEBUG SMTP: trying to connect to host "smtp.sendgrid.net", port 587, isSSL false
...
```

```
Id:	20
Created:	4/24/2024 02:04 PM SAST
Type:	Error

Webhook [https://webhook.site/60a036f9-a2a2-4646-bf58-c60778eea20d] returned response code [404] when sending [AuditLogCreate] event with Id [d13865c7-f706-4896-a322-d3f7cc63441a].
 Response:
null
```

### Login Records

<strong>System -> Login Records</strong> lists all user logins to FusionAuth.

User | User Id | Application | Application Id | Time | Location | IP address
---|---|---|---|---|---|---
workaddress/fa@simplelogin.com | 00000000-0000-0000-0000-000000000001 | FusionAuth | 3c219e58-ed0e-4b18-ad48-f4f92793ae32 | 6/4/2024 11:17 AM SAST | â€“ | 172.20.0.1

### Logs

<strong>System -> Logs</strong> show nothing if you are running Docker. Instead, the logs are written to the terminal.

## Splunk Setup

- Sign up for Splunk at https://www.splunk.com/en_us/download/splunk-cloud.html with an email address at a custom domain.
- Splunk will email you a link to another site with a username and password. Note that this is **not** the correct site. Splunk divides its products into completely separate dashboards.
- Register for the Observability Cloud trial at https://www.splunk.com/en_us/download/o11y-cloud-free-trial.html.
- Verify your email address with the link in the email they send you. This should also log you in to the Observability dashboard.
- In the future, you can log in to the dashboard at https://login.signalfx.com.

Documentation for Splunk Observability is at https://docs.splunk.com/observability/en/get-started/welcome.html.

Pricing is at https://www.splunk.com/en_us/products/pricing/observability.html. Infrastructure monitoring, Log observer connect, and Synthetic uptime monitoring are included in the Splunk Infrastructure monthly fee. Each Splunk product has a separate 14 day trial.

<img src='https://docs.splunk.com/observability/en/_images/o11y-cloud-structure1.png' />

- Click <strong>Apps -> Discover Splunk Observability Cloud</strong>
- Click <InlineField>Connect Accounts</InlineField>

## Import Data To Splunk With The API

Using the Splunk API to import metrics is documented [here](https://docs.splunk.com/observability/en/gdi/other-ingestion-methods/rest-APIs-for-datapoints.html#rest-api-ingest).

[To authenticate API requests that send data to Splunk Observability Cloud, you must use an organization access token, not a user API access token.](https://docs.splunk.com/observability/en/admin/authentication/authentication-tokens/api-access-tokens.html)

- Log in to your Observability account at https://login.signalfx.com.
- Click the logo at the top left to expand the menu labels.
- Click <strong>Settings -> View Profile -> Organizations</strong>
  - Note your realm and endpoints, for instance `us1`, `https://api.us1.signalfx.com`, `https://ingest.us1.signalfx.com`
- Get an [access token](https://docs.splunk.com/observability/en/admin/authentication/authentication-tokens/org-tokens.html#admin-org-tokens) (also called organization token).
  - Click <strong>Settings -> Access Tokens</strong>
  - Expand the `Default` access token
  - Click <InlineField>Show Token</InlineField> and note the token

Test that you can import data with the terminal command below.
  - Replace `<ORG_TOKEN>` with your token and `<REALM>` with your realm.

```sh
curl --request POST \
  --header "Content-Type: application/json" \
  --header "X-SF-TOKEN: <ORG_TOKEN>" \
  --data \
  '{
      "gauge": [
          {
              "metric": "memory.free",
              "dimensions": { "host": "server1" },
              "value": 42
          }
      ]
  }' \
  https://ingest.<REALM>.signalfx.com/v2/datapoint
```

The response should be `"OK"`.

- Return to the Observability dashboard home.
- Browse to <strong>Metric Finder</strong>.
- Enter `memory` in the text box and click <InlineField>Search metrics</InlineField>
- Click <InlineField>memory.free</InlineField>
- You should see the data point created by the command above on the chart. If you can't, try switching to the Column chart view, or run the command again with a different value.

TODO map FusionAuth outputs to Splunk metric types:
https://docs.splunk.com/observability/en/metrics-and-metadata/metric-types.html#metric-types

## Import Data To Splunk With Logs



## Import Data To Splunk With OpenTelemetry And Java

https://docs.splunk.com/observability/en/gdi/get-data-in/application/java/get-started.html#get-started-java
https://docs.splunk.com/observability/en/gdi/opentelemetry/opentelemetry.html#otel-intro

## Import Data To Splunk With The OpenTelemetry Linux Collector

Running FusionAuth and Postgresql in Docker looks like the diagram below.

```mermaid
graph LR
  subgraph I[Your server]
    direction LR
    subgraph G[Docker]
      H[(Postgresql)]
    end
    subgraph C[Docker]
      direction BT
      A(FusionAuth)
    end
  end
  C --> G
  style I fill:#0000
```

(You might also run ElasticSearch in another Docker container, but it's unnecessary.)

You can also start FusionAuth inside Docker with [OpenTelemetry for Java](https://github.com/open-telemetry/opentelemetry-java-instrumentation). OpenTelemetry (or Otel) sends the metrics it reads to a collector. The OpenTelemetry collector runs in a separate Docker container, and in turn sends the metrics to Splunk for recording. This follows the Docker principle of one process per container.

This architecture is shown in the diagram below.

```mermaid
graph LR
  subgraph I[Your server]
    direction LR
    subgraph G[Docker]
      H[(Postgresql)]
    end
    subgraph C[Docker]
      direction BT
      D(OpenTelemetry for Java) --> A(FusionAuth)
    end
    subgraph E[Docker]
      B(Splunk OpenTelemetry collector)
    end
  end
  C --> G
  C --> B
  E --> F(Splunk web server)
  style I fill:#0000
```

Splunk's [OpenTelementry Linux collector tutorial](https://docs.splunk.com/observability/en/gdi/opentelemetry/collector-linux/collector-configuration-tutorial/about-collector-config-tutorial.html#about-collector-configuration-tutorial) is designed for a physical machine running systemd. Docker containers don't use systemd as they are designed to host a single process only.

Instead, you'll use the OpenTelemetry collector inside the Docker image Splunk has prepared.

Modify the `docker-compose-yaml` file from the FusionAuth [five-minute guide](/docs/quickstarts/5-minute-setup-guide) to have the content below. You are now including the [Splunk OpenTelemetry](https://docs.splunk.com/observability/en/gdi/opentelemetry/collector-linux/install-linux-manual.html#linux-docker) container in your compose file.

```docker-compose
todo copy from file
```

Run `docker compose up` to start all three containers and open a new terminal. In it, enter the commands below to attach to the [FusionAuth container](https://github.com/FusionAuth/fusionauth-containers/blob/master/docker/fusionauth/fusionauth-app/Dockerfile) and restart FusionAuth with OpenTelemetry running and configured to send data to the collector container. Attach to the container as the `root` user (the default user is `fusionauth`). Replace `fa` with your container name.

```sh
docker exec -it -u root fa bash

# todo stop fusionauth
curl https://github.com/open-telemetry/opentelemetry-java-instrumentation/releases/latest/download/opentelemetry-javaagent.jar

export FUSIONAUTH_APP_ADDITIONAL_JAVA_ARGS="-javaagent:$OT_PATH/opentelemetry-javaagent.jar"
export OTEL_EXPORTER_OTLP_ENDPOINT=https://api.honeycomb.io
export OTEL_EXPORTER_OTLP_HEADERS=x-honeycomb-team=$HONEYCOMB_API_KEY
export OTEL_TRACES_EXPORTER=otlp
export OTEL_SERVICE_NAME=fusionauth-test
export OTEL_TRACES_SAMPLER=traceidratio
export OTEL_TRACES_SAMPLER_ARG=0.5
export OTEL_RESOURCE_ATTRIBUTES=SampleRate=2
export OTEL_INSTRUMENTATION_HTTP_CAPTURE_HEADERS_CLIENT_REQUEST=X-FusionAuth-TenantId

java -javaagent:path/to/opentelemetry-javaagent.jar \
     -Dotel.resource.attributes=service.name=your-service-name \
     -Dotel.traces.exporter=zipkin \
     -jar myapp.jar
```

By default, the OpenTelemetry Java agent sends data to the OpenTelemetry collector at http://localhost:4317. You [changed this](https://opentelemetry.io/docs/zero-code/java/agent/configuration/) to send data to the otel container, at http://otel:4317.


todo remove old fa container commands below
```sh
mkdir -p /var/lib/apt/lists/partial
chmod 755 /var/lib/apt/lists/partial
apt update
apt install -y ca-certificates
apt install -y systemctl
apt install -y curl
apt install -y software-properties-common
apt install -y lsb-release
apt install -y systemd
apt install -y dialog

export SPLUNK_REALM="us1" # replace with your realm
export SPLUNK_ACCESS_TOKEN="abSE5G5ZAJ8K34h5a-qXwg" # replace with your access token
export SPLUNK_MEMORY_TOTAL_MIB="512"

curl -sSL https://dl.signalfx.com/splunk-otel-collector.sh > /tmp/splunk-otel-collector.sh;
sh /tmp/splunk-otel-collector.sh --realm $SPLUNK_REALM --memory $SPLUNK_MEMORY_TOTAL_MIB -- $SPLUNK_ACCESS_TOKEN
# The Splunk OpenTelemetry Collector for Linux has been successfully installed.
```


- https://docs.splunk.com/observability/en/gdi/get-data-in/compute/linux.html#get-started-linux

## Further Reading

- https://opentelemetry.io/docs/what-is-opentelemetry/
- https://github.com/open-telemetry/opentelemetry-java-instrumentation
- https://github.com/FusionAuth/fusionauth-containers/blob/master/docker/fusionauth/fusionauth-app/Dockerfile

<strong></strong>
<InlineField></InlineField>