---
title: Advanced Threat Detection
description: Learn about FusionAuth Advanced Threat Detection, which gives you a variety of tools to secure your application.
navcategory: premium
section: operate
subcategory: secure and monitor
---
import Aside from 'src/components/Aside.astro';
import Breadcrumb from 'src/components/Breadcrumb.astro';
import EnterpriseEditionBlurb from 'src/content/docs/_shared/_enterprise-edition-blurb.astro';
import InlineField from 'src/components/InlineField.astro';
import WebhookList from 'src/content/docs/extend/events-and-webhooks/events/_list-advanced-threat-detection-webhooks.mdx';
import {YouTube} from '@astro-community/astro-embed-youtube';

## TODO
cd ~/code/fusionauth-site/astro && npm install && npm run dev;  # run new astro docs. localhost:3000

- rate limiting
  - diagrams around rate limiting
- webhooks/emails
  - talk about the differences between using a webhook and a security email.
  - example of email/webhook sent on location aware event
  - talk about what you could do with the webhook events, include an example: if the forgot password flow has been started 4 times without success, lock the account for a day.

<EnterpriseEditionBlurb />

## Overview

<Aside type="version">
Available since 1.30.0
</Aside>

Flagging and responding to suspicious behavior is a part of any cybersecurity product.
Advanced Threat Detection is a feature that brings best-practice functionality to help you deal with bizarre, possibly malicious behavior around logins, registrations, user creation, and user updates.

<Aside type="note">
Advanced Threat Detection can be enabled when the user creates a license or updates an existing license.

This feature also requires increased RAM on the servers running the FusionAuth application, as documented in the [System Requirements](/docs/get-started/download-and-install/system-requirements#compute-ram).
</Aside>

Advanced Threat Detection features include:
- Rate limiting (too many failed logins or forgot passwords)
- CAPTCHA to prevent automated login
- Location and IP restriction
- Administrator notifications through emails and webhooks

Each feature is configurable on a tenant by tenant basis. You can do so via [the Tenant API](/docs/apis/tenants) or by navigating to <Breadcrumb>Tenants -> My Tenant -> Security</Breadcrumb>.

Here's a brief video covering some aspects of Advanced Threat Detection:

<YouTube id="pjGxOXamVfk" />

## Enable Advanced Threat Detection

When you enter a licence key into FusionAuth in the web interface at `/admin/reactor`, FusionAuth should contact the licencing server and enable Advanced Threat Detection. If you wait a minute and then refresh the page, <InlineField>Threat Detection</InlineField> should say `Active`.

If the field does not update, please contact FusionAuth support.

## Customizable Rate Limiting

- what the experience is with custom rate limiting (for the end user)
- best practices around rate limiting
- diagrams around rate limiting

A rate limit is the maximum number of times a user may perform an action in a set duration. You can set the following limits for each tenant:

- Failed login
- Forgot password
- Send or resend email verification
- Passwordless/magic link login
- Send or resend registration verification
- Send two-factor code

<img src="/img/docs/operate/secure-and-monitor/rate-limit-settings.png" alt="The rate limiting configuration screen." width="1200" />

You can enable or disable each of these and control the number of allowed attempts within a window before an action will be rate limited. When an action is rate limited, it will not succeed.

Rate limiting applies whether you are accessing FusionAuth through the web interface or in the terminal using the APIs.

If you need to lock an account after a number of failed logins, consider [user account locking](/docs/lifecycle/authenticate-users/setting-up-user-account-lockout). Using the account lockout feature rather than rate limiting offers additional flexibility in the duration. FusionAuth can also send emails or webhooks when it locks a user's account.

### Usability Considerations

In security, it is good practice to give as little information to potential attackers as possible. This is why a website will tell you vaguely on failed login that the username or password is incorrect, rather than admitting that the user is not registered. Similarly, with rate limiting in FusionAuth, the user (or potential attacker) is not notified that rate limiting restrictions have been triggered.

For example, when exceeding the number of incorrect login attempts, any further *correct* login attempts within the duration will still fail — but the user won't be told why. Below is an example.

<img src="/img/docs/operate/secure-and-monitor/user_login_failed.png" alt="How rate limiting appears to the user." width="1200" />

This can be extremely confusing to users, who may waste their time resetting their password with the Forgot Password flow, or waste your time making support requests.

To improve the user experience, you can provide additional information in the messages shown on the various login pages and in email templates warning users about rate limits.

For example, you can browse to `Customizations` -> `Themes`. Edit any of the available tenants, such as the default FusionAuth. In the <InlineField>Messages</InlineField> tab you can change messages shown to users. You could change the following message to the message below it.
```sh
[InvalidLogin]=Invalid login credentials.
```

```
[InvalidLogin]=Invalid login credentials. If you are certain your password is
               correct, please wait 60 seconds and retry.
```

To balance security with usability, you need to decide how much information to reveal to users based on the usage patterns of your system and its security risks.

You can also use CSS and JavaScript to provide more information to users. For more information, please see the [theming documentation](/docs/customize/look-and-feel/).

### Best Practices

There are three main concerns for rate limiting, from most to least important:
- Denial of service attacks on your authentication system. These can leave your entire application unusable.
- User email spam. This annoys users and reduces your email server's reputation. Two-factor SMS spam can incur significant cost to a company too.
- Brute forcing login passwords. Login attempts are slow, and it's unlikely for attackers to guess any but the simplest of passwords.

For these reasons, you should enable rate limiting on all six functions in your tenant security tab. But they do not have to be very strict to prevent spam. The default limits (five attempts with a minute lock-out) are sufficient to prevent most attacks, when combined with FusionAuth's other security features.

Some systems provide adaptive rate limiting — where limits change dynamically based on the load of the system. FusionAuth does not provide this, so you need to adjust your rates manually if you see an increase in attacks on your application.

## CAPTCHA

CAPTCHA stands for Completely Automated Public Turing test to tell Computers and Humans Apart, and can provide additional security. If you enable CAPTCHA, FusionAuth will use it on the login and registration pages.

FusionAuth supports:
- Google reCAPTCHA version 2 (puzzle or one-click)
- Google reCAPTCHA version 3 (invisible with threat score from 0 to 1)
- hCaptcha and hCaptcha Enterprise

FusionAuth does not support Google reCAPTCHA Enterprise. Enterprise is similar to version 3, but with machine learning for your site.

reCAPTCHA version 3 requires no work from your users and is more pleasant for them than version 2. But version 2 is still useful if you want to be certain that the user has passed a test of humanity, rather than have a mere probability they are human. The other danger with version 3 is that a user might be mistaken as non-human and will have no way to remedy this. Version 2's ease of use makes it better to start with than version 3, unless your users report errors.

hCaptcha is similar to reCAPTCHA, except offered by a company that is not Google. You need to do your own research to decide which to use, but here are a few of the alleged differences claimed on the Internet:
- hCaptcha keeps less private user information than reCAPTCHA and has a strict privacy policy. reCAPTCHA violates GDPR and is not suitable for European sites.
- hCaptcha works in every country, whereas China blocks Google.
- hCaptcha is free for one million verifications per month. hCaptcha Pro costs $99 per month for 100 000 verifications and includes invisible CAPTCHA, theming, and analytics.
- reCAPTCHA is free for ten thousand verifications per month. It then charges $8 per month for up to 100 000 verifications, then $1 per 1 000 more.

At the beginning of 2024, hCaptcha seems to be the better choice for number of countries supported, privacy, and price (depending on your number of users).

<Aside type="note">
"reCAPTCHA scores run from 0.0 (bot) to 1.0 (person). hCaptcha Enterprise scores are risk scores, and thus they run from 0.0 (no risk) to 1.0 (confirmed threat)." - [hCaptcha documentation](https://docs.hcaptcha.com/switch/)
</Aside>

### How To Set Up reCAPTCHA

First create a CAPTCHA site on Google:
- Browse to https://www.google.com/recaptcha/admin/create
- Click <InlineField>Switch to create a classic key</InlineField> to ensure that you are not creating an Enterprise key.
- Enter your domain name, or `localhost` if you are testing locally.
- Choose version 2 or 3 as you prefer.

The form should look like the image below.

<img src="/img/docs/operate/secure-and-monitor/create_captcha.png" alt="Create a CAPTCHA in Google" width="1200" />

<Aside type="note">
When you want to delete a CAPTCHA site, browse to the Google administrative console at https://www.google.com/recaptcha/admin, select a site, click settings, and click the tiny delete icon at the top right of the page.
</Aside>

<Aside type="danger">
Be careful when enabling reCAPTCHA that your keys in FusionAuth are correct and your domain name in Google is correct. If you make a mistake you will not be able to log in with your administrator account to make changes because CAPTCHA will fail. You will have to remove CAPTCHA manually by connecting to the FusionAuth database and altering tables. Test on a copy of your live site first.
</Aside>

In the FusionAuth web interface, edit a tenant, and under the heading <InlineField>Captcha Settings</InlineField>, enable <InlineField>Enabled</InlineField>. Enter your chosen reCAPTCHA version and your keys from Google. Leave the threat score at half and adjust it later if necessary. Save the tenant.

If you log out and in again you'll be given a CAPTCHA puzzle for version 2, or be shown nothing if using version 3.

Below is what the user will see when logging in with version 2.

<img src="/img/docs/operate/secure-and-monitor/captcha_login1.png" alt="Login with reCAPTCHA" width="1200" />

<img src="/img/docs/operate/secure-and-monitor/captcha_login2.png" alt="Login with reCAPTCHA" width="1200" />

### How To Set Up hCaptcha

Browse to https://dashboard.hcaptcha.com/signup and create an hCaptcha account. hCaptcha will create a site and secret key for you. Unlike reCAPTCHA, hCaptcha will not work on your localhost. Browse to https://dashboard.hcaptcha.com and click on your site to edit its settings. If you are testing on your localhost, enter any URL for the domain, such as `example.com`. Save.

In your machine's `/etc/hosts` file, add the line below redirecting your localhost to the hCaptcha domain and save.

```txt
127.0.0.1       example.com
```

For your operating system, see the instructions at https://docs.hcaptcha.com/#local-development.

Now browse to FusionAuth at http://example.com:9011/admin. Edit a tenant, and under the heading <InlineField>Captcha Settings</InlineField>, enable <InlineField>Enabled</InlineField>. Choose hCaptcha and enter your keys from the site. Leave the threat score at half and adjust it later if necessary. Save the tenant.

If you log out and in again you'll be given a CAPTCHA puzzle.

Below is what the user will see when logging in with.

<img src="/img/docs/operate/secure-and-monitor/hcaptcha_login1.png" alt="Login with hCaptcha" width="1200" />

<img src="/img/docs/operate/secure-and-monitor/hcaptcha_login2.png" alt="Login with hCaptcha" width="1200" />

## Location Aware Security

FusionAuth has location information for requests and uses it in a variety of ways to secure user accounts.
These are all configurable and controllable by developers integrating FusionAuth into their applications.

Some location aware features are:
- Inside every Forgot Password email sent to a user, the geographic location of where the password reset request was made is displayed. The recipient can determine if the location of the requester seems suspicious.
- Flag suspicious login events and notify the user of a new login with the approximate location. A webhook is also sent.
- Calculates "impossible travel" to see if a user could realistically log in at different locations around the globe in a reasonable time frame.
- When a login request occurs from an unexpected IP address, a user receives an email to notify them of a new login with an approximate location of the IP address.

## IP Access Control Lists

You may want to restrict an application or API key to a certain IP address or range of IP addresses. With Advanced Threat Detection, you can do this. Create an IP address access control list (IP ACL) in the web interface at <InlineField>Settings</InlineField>-><InlineField>IP Access Control</InlineField>:

<img src="/img/docs/operate/secure-and-monitor/ip-acl-list.png" alt="The IP access control list configuration screen." width="1200" />

<Aside type="danger">
Be careful when enabling an ACL for the default tenant or FusionAuth application. If you make a mistake you will not be able to log in with your administrator account to make changes because your IP address is restricted. You will have to remove the ACL by connecting to the FusionAuth database and altering tables.
</Aside>

Then apply the ACL to an application by browsing to <InlineField>Applications</InlineField>, editing one, and choosing the ACL on the <InlineField>Security</InlineField> tab under <InlineField>Access control lists settings</InlineField>. This will prevent a user from being able to even access an application login page if they are not in the IP address range. If you have internal applications, or applications to which access should otherwise be limited, this feature can help secure them.

You can restrict a Tenant instead of an Application in the same way — edit the <InlineField>Security</InlineField> tab of a Tenant. The ACL restriction will then be applied to every Application and user belonging to that Tenant.

<img src="/img/docs/operate/secure-and-monitor/ip-acl-application.png" alt="Applying an IP ACL to an application." width="1200" />

In addition to restricting users to an IP range, you can also restrict API keys. This is useful if you are managing your FusionAuth configuration via a CI/CD system. You can create an API key to modify configurations, but limit that key to the IP address range of your CI/CD system, increasing security and lowering the risk of the API key being used incorrectly.

You also might want only administrators in your company to make API calls to your application, and restrict an API key to IP addresses in your building. Edit API key security by browsing to <InlineField>Settings</InlineField>-><InlineField>API Keys</InlineField> and editing a key.

<img src="/img/docs/operate/secure-and-monitor/ip-acl-api-key.png" alt="Applying an IP ACL to an API key." width="1200" />

A final use of IP address restriction is the case of denial of service attacks. If an adversary is making thousands of calls a minute to your application, performance will degrade. If you detect an IP address spamming your application, block it in FusionAuth or in your network gateway.

### Usability Considerations

In general, restricting IP addresses for users will be more harmful than beneficial. The use of personal VPNs has risen greatly in the last few years, due to people avoiding national firewalls, digital sanctions against countries, governments spying on citizens, and corporate data collection and privacy violations. The IP address your application sees for a user might not indicate their actual country if they use a VPN. It's becoming more common for IP addresses of users to change frequently. Employees work from home, remotely, or use dynamic IP addresses from their Internet service provider instead of static ones. VPNs also reduce the reliability of impossible travel calculations. Finally, if you see suspicious behavior from an IP address that is a VPN gateway, you should not ban that address and lock out all other users of that VPN.

In addition to IP address restriction to being unpleasant for users, you cannot completely trust the reported IP addresses of clients. As an IP request passes through the internet through various proxy servers, they record the path of addresses in the `X-Forwarded-For` HTTP header. If any proxy lies or is misconfigured then FusionAuth might grant access to an IP address of a client that should not be trusted.

Be careful when setting an ACL that you are not causing unnecessary difficulty for users of your system. You could instead use another solution, like CAPTCHA or rate limiting.

## Registration Email Domain Blocking

If you enable self-service registration, users can provide any email address they like. But you may have email domains that have elevated privileges, like your `company.com` domain. There may be email addresses for which you want to block registration, like consumer `gmail.com` addresses if your application is aimed at business users.

In either of these cases, you can block one or more domains from the registration process using Advanced Threat Detection.

<img src="/img/docs/operate/secure-and-monitor/block-domains.png" alt="Blocking consumer facing domains from registering." width="1200" />

## Webhooks And Emails

You can configure FusionAuth to send emails and webhooks when certain security events occur. The difference between the two is that emails are sent to the end user of your application for a security event associated with their account, and webhooks can be sent to any external system for a wide variety of security events.

A webhook is an outbound HTTP request or requests bearing a message to an endpoint. A webhook is used to inform an external system of some event in FusionAuth. The webhook/API terminology can be confusing. Note that most web applications, including FusionAuth, call a trigger to send data a "Webhook", but when they receive data they call it an "API". So if you're looking for a destination for a FusionAuth webhook in an external system, you won't find it under the webhook documentation; you'll find it under [API documentation](/docs/apis/webhooks). This is why webhooks are sometimes known as "reverse APIs". However, some companies, like Slack in their documentation, also call incoming requests "incoming webhooks".

## Security Emails

Emails can be sent to the user when an event involving their account occurs. You can add your [own email templates](/docs/customize/email-and-messages/). There is a sample ["Threat Detected" email template](/docs/customize/email-and-messages/templates-replacement-variables#threat-detected) that documents available variables. Security related emails may be localized, like any other email template.

If you need help setting up email in FusionAuth for the first time, please see the [guide to SMTP](/docs/customize/email-and-messages/configure-email).

Here are the security events for which you can send emails:

- Email update — someone changed a user's email address. This mail is sent to the new and old addresses.
- Forgot password — someone starts the "Forgot password" workflow for a user.
- Login Id duplicate on create — someone tried to create another user with this user's email address.
- Login Id duplicate on update — someone tried to change their email address to this user's email address.
- Login with new device — someone logged in with a device not previously used.
- Suspicious login — the login has been flagged by FusionAuth as suspicious.
- Password reset success — a successful "Forgot password" flow for the user has completed.
- Password update — a user's password has been updated.
- Passwordless login — someone requests a login link sent to the user's email address.
- Setup password — a new account has been created for the user, and they are asked to set a password.
- Two-factor method added — a two-factor authentication method was added to the user's account.
- Two-factor method removed — a two-factor authentication method was removed from the user's account.

You can set these up by navigating to <strong>Tenant -> Your Tenant -> Email -> Template Settings</strong>.

<img src="/img/docs/operate/secure-and-monitor/security-emails-list.png" alt="List of email templates." width="1200" />

The easiest way to test security emails is to trigger the "Login with new device" email by logging in to FusionAuth from a private browser window. Below is how the "Threat Detected" email template linked above looks to the user.

{/* Tatenda - to setup email, user mailersend.com, use their sample domain as your from address, like @trial-o65qngkvmrwlwr12.mlsender.net, and change the default admin@example.com email address in the database with DBeaver to your personal address */}

<img src="/img/docs/operate/secure-and-monitor/security_email.png" alt="What getting a security email looks like" width="1200" />

## Webhooks

Webhooks can be sent to any IP address. There are a number of security related events that your Security Information and Event Management (SIEM) or other analytics systems may want to process, such as when MFA has been disabled for a user or when a user has requested a password reset.

Here's the full list of Advanced Threat Detection webhooks:

<WebhookList/>

