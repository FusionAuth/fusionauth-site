---
title: Advanced Threat Detection
description: Learn about FusionAuth Advanced Threat Detection, which gives you a variety of tools to secure your application.
navcategory: premium
section: operate
subcategory: secure and monitor
---
import Aside from 'src/components/Aside.astro';
import EnterpriseEditionBlurb from 'src/content/docs/_shared/_enterprise-edition-blurb.astro';
import InlineField from 'src/components/InlineField.astro';
import RateLimitDiagram from 'src/diagrams/docs/operate/secure-and-monitor/_rate-limit.astro';
import WebhookList from 'src/content/docs/extend/events-and-webhooks/events/_list-advanced-threat-detection-webhooks.mdx';
import {YouTube} from '@astro-community/astro-embed-youtube';

<EnterpriseEditionBlurb />

## Overview

<Aside type="version">
Available since 1.30.0
</Aside>

Flagging and responding to suspicious behavior is a part of any cybersecurity product.
Advanced Threat Detection is a feature that brings best-practice functionality to help you deal with bizarre, possibly malicious behavior around logins, registrations, user creation, and user updates.

<Aside type="note">
Advanced Threat Detection can be enabled when the user creates a license or updates an existing license.

This feature also requires increased RAM on the servers running the FusionAuth application, as documented in the [System Requirements](/docs/get-started/download-and-install/system-requirements#compute-ram).
</Aside>

Advanced Threat Detection features include:
- Rate limiting (too many failed login attempts).
- CAPTCHA to prevent automated logins.
- Location and IP restriction.
- Administrator notifications through emails and webhooks.

Each feature is configurable on a tenant by tenant basis. You can do so via [the Tenant API](/docs/apis/tenants) or by browsing to **Tenants -> My Tenant -> Security**.

Here's a brief video covering some aspects of Advanced Threat Detection:

<YouTube id="pjGxOXamVfk" />

## Enable Advanced Threat Detection

When you enter a licence key into FusionAuth in the admin UI at `/admin/reactor`, FusionAuth should contact the licencing server and enable Advanced Threat Detection. If you wait a minute and then refresh the page, <InlineField>Threat Detection</InlineField> should say `Active`.

If the field does not update, please contact FusionAuth support.

## Customizable Rate Limiting

A rate limit is the maximum number of times a user may perform an action in a set duration. You can set the following limits for each tenant:

- Failed login.
- Forgot password.
- Send or resend email verification.
- Passwordless/magic link login.
- Send or resend registration verification.
- Send two-factor code.

<img src="/img/docs/operate/secure-and-monitor/rate-limit-settings.png" alt="The rate limiting configuration screen." width="1200" />

You can enable or disable each of these and control the number of allowed attempts within a window before an action will be rate limited.

Let's consider failed logins as an example. Assume you limit failed logins to five per sixty seconds. Once anyone tries to log in with an email address and wrong password five times within a minute, that email address will be locked. From the time of the fifth login until one minute passes, no logins will succeed, even with the correct password. (Note that this means an attacker can lock another user out of their account by triggering failed login attempts using their email address.)

Further login attempts during the lockout duration, with or without the correct password, will not extend the duration of the lockout. Once a minute has elapsed, a user can log in again with the correct password. The lockout duration effectively clears failed login attempts because it is the same length as the sliding window of duration in which to check for failed logins. In other words, once the lockout period has passed, the user has up to five new attempts to enter the correct password. Entering an incorrect password won't trigger another lockout period immediately, even if the user had been trying unsuccessfully to log in during the lockout period.

Rate limiting applies whether you are accessing FusionAuth through the admin UI or in the terminal using the APIs.

An example of how rate limiting is applied for login is represented in the diagram below.

<RateLimitDiagram />

If you need to lock an account after a number of failed logins, consider [user account locking](/docs/lifecycle/authenticate-users/setting-up-user-account-lockout). Using the account lockout feature rather than rate limiting offers additional flexibility in the duration. FusionAuth can also send emails or webhooks when it locks a user's account.

### Usability Considerations

In security, it is good practice to give as little information to potential attackers as possible. This is why a website will tell you vaguely on failed login that the username or password is incorrect, rather than admitting that the user is not registered. Similarly, with rate limiting in FusionAuth, the user (or potential attacker) is not notified that rate limiting restrictions have been triggered.

For example, when exceeding the number of incorrect login attempts, any further *correct* login attempts within the duration will still fail — but the user won't be told why. Below is an example.

<img src="/img/docs/operate/secure-and-monitor/user_login_failed.png" alt="How rate limiting appears to the user." width="1200" />

This can be extremely confusing to users, who may waste their time resetting their password with the Forgot Password flow, or waste your time making support requests. Note also that an attacker can use rate limiting to completely lock a user out of their account by automating failed login attempts with the victim's email address. FusionAuth does not distinguish between IP addresses of the caller when applying rate limiting.

To improve the user experience, you can provide additional information in the messages shown on the various login pages and in email templates warning users about rate limits.

For example, you can browse to **Customizations -> Themes**. Edit any of the available Themes, such as the default FusionAuth theme. In the <InlineField>Messages</InlineField> tab you can change messages shown to users. You could change the following message.

```
[InvalidLogin]=Invalid login credentials.
```

To include a bit more information in the message as below.

```
[InvalidLogin]=Invalid login credentials. If you are certain your password is
               correct, please wait 60 seconds and retry.
```

To balance security with usability, you need to decide how much information to reveal to users based on the usage patterns of your system and its security risks.

You can also use CSS and JavaScript to customise your theme and provide more information to users. For more information, please see the [theme customisation documentation](/docs/customize/look-and-feel/).

### Best Practices

There are three main concerns for rate limiting, from most to least important:
- Denial of service attacks on your authentication system. These can leave your entire application unusable.
- User email spam. This annoys users and reduces your email server's reputation. Two-factor SMS spam can incur significant cost to a company too.
- Brute forcing login passwords. Login attempts are slow, and it's unlikely for attackers to guess any but the simplest of passwords.

For these reasons, you should enable rate limiting on all six functions in your tenant security tab. But they do not have to be very strict to prevent spam. The default limits (five attempts with a minute lock-out) are sufficient to prevent most attacks, when combined with FusionAuth's other security features.

Some systems provide adaptive rate limiting — where limits change dynamically based on the load of the system. FusionAuth does not provide this, so you need to adjust your rates manually if you see an increase in attacks on your application.

Note that even if you enable rate limiting, FusionAuth will still receive every request sent to it. An overload of requests will cause a denial of service attack. You need to prevent this attack at the network layer of your system, not in FusionAuth itself.

## CAPTCHA

CAPTCHA stands for Completely Automated Public Turing test to tell Computers and Humans Apart, and can provide additional security. If you enable CAPTCHA, FusionAuth will use it on the login and registration pages.

FusionAuth supports:
- Google reCAPTCHA version 2 (puzzle or one-click).
- Google reCAPTCHA version 3 (invisible with threat score from 0 to 1).
- hCaptcha and hCaptcha Enterprise.

FusionAuth does not support Google reCAPTCHA Enterprise. Enterprise is similar to version 3, but with machine learning for your site.

reCAPTCHA version 3 requires no work from your users and is more pleasant for them than version 2. But version 2 is still useful if you want to be certain that the user has passed a test of humanity, rather than have a mere probability they are human. The other danger with version 3 is that a user might be mistaken as non-human and will have no way to remedy this. Version 2's ease of use makes it better to start with than version 3, unless your users report errors.

hCaptcha is similar to reCAPTCHA, except offered by a company that is not Google. You need to do your own research to decide which to use, but here are a few of the alleged differences claimed on the Internet:
- hCaptcha keeps less private user information than reCAPTCHA and has a strict privacy policy. reCAPTCHA violates GDPR and is not suitable for European sites.
- hCaptcha works in every country, whereas China blocks Google.
- hCaptcha is free for one million verifications per month. hCaptcha Pro costs $99 per month for 100 000 verifications and includes invisible CAPTCHA, theming, and analytics.
- reCAPTCHA is free for ten thousand verifications per month. It then charges $8 per month for up to 100 000 verifications, then $1 per 1 000 more.

At the beginning of 2024, hCaptcha seems to be the better choice for a number of countries supported, privacy, and price (depending on your number of users).

<Aside type="note">
"reCAPTCHA scores run from 0.0 (bot) to 1.0 (person). hCaptcha Enterprise scores are risk scores, and thus they run from 0.0 (no risk) to 1.0 (confirmed threat)." - [hCaptcha documentation](https://docs.hcaptcha.com/switch/)
</Aside>

### How To Set Up reCAPTCHA

First create a CAPTCHA site on Google:
- Browse to https://www.google.com/recaptcha/admin/create.
- Click <InlineField>Switch to create a classic key</InlineField> to ensure that you are not creating an Enterprise key.
- Enter your domain name, or `localhost` if you are testing locally.
- Choose version 2 or 3 as you prefer.

The form should look like the image below.

<img src="/img/docs/operate/secure-and-monitor/create_captcha.png" alt="Create a CAPTCHA in Google" width="1200" />

<Aside type="note">
When you want to delete a CAPTCHA site, browse to the Google administrative console at https://www.google.com/recaptcha/admin, select a site, click settings, and click the tiny delete icon at the top right of the page.
</Aside>

<Aside type="danger">
Be careful when enabling reCAPTCHA that your keys in FusionAuth are correct and your domain name in Google is correct. If you make a mistake you will not be able to log in with your administrator account to make changes because CAPTCHA will fail. You will have to remove CAPTCHA manually by connecting to the FusionAuth database and altering tables. Test on a copy of your live site first.
</Aside>

In the FusionAuth admin UI, edit a tenant, and on the **Security** tab go to <InlineField>Captcha Settings</InlineField>, toggle <InlineField>Enabled</InlineField>. Enter your chosen reCAPTCHA version and your keys from Google. Leave the threat score at half and adjust it later if necessary. Save the tenant.

<img src="/img/docs/operate/secure-and-monitor/enter_captcha_details.png" alt="Enter CAPTCHA details in FusionAuth" width="1200" />

If you log out and go to the login screen you'll be given a CAPTCHA puzzle for version 2, or be shown nothing if using version 3.

Below is what the user will see when logging in with version 2.

<img src="/img/docs/operate/secure-and-monitor/captcha_login1.png" alt="Login with reCAPTCHA" width="1200" />

<img src="/img/docs/operate/secure-and-monitor/captcha_login2.png" alt="Login with reCAPTCHA" width="1200" />

### How To Set Up hCaptcha

Browse to https://dashboard.hcaptcha.com/signup and create an hCaptcha account. Generate a secret key and proceed to add a site. Unlike reCAPTCHA, hCaptcha will not work with localhost. Browse to https://dashboard.hcaptcha.com and click on your site to edit its settings. If you are testing on your localhost, enter a URL for a domain, such as `check.example.com`. Save the site.

<img src="/img/docs/operate/secure-and-monitor/hcaptcha_create_site.png" alt="hCaptcha create new site" width="1200" />

In your machine's `/etc/hosts` file, add an entry line below redirecting your localhost to the hCaptcha domain and save.

```
127.0.0.1   check.example.com
```

For your operating system, see the instructions at https://docs.hcaptcha.com/#local-development.

Now browse to FusionAuth at http://check.example.com:9011/admin. Edit a tenant, and under the <InlineField>Captcha Settings</InlineField>, toggle <InlineField>Enabled</InlineField>. Choose hCaptcha and enter your keys from the site. Leave the threat score at half and adjust it later if necessary. Save the tenant.

If you log out and go to the login screen you'll be given a CAPTCHA puzzle.

Below is what the user will see when logging in.

<img src="/img/docs/operate/secure-and-monitor/hcaptcha_login1.png" alt="Login with hCaptcha" width="1200" />

<img src="/img/docs/operate/secure-and-monitor/hcaptcha_login2.png" alt="Login with hCaptcha" width="1200" />

## Location Aware Security

FusionAuth collects location information for requests and uses it in a variety of ways to secure user accounts.
These are all configurable and controllable by developers integrating FusionAuth into their applications.

Some location aware features are:
- Inside every Forgot Password email sent to a user, the geographic location of where the password reset request was made is displayed. The recipient can determine if the location of the requester seems suspicious.
- Flag suspicious login events and notify the user of a new login with the approximate location. A webhook is also sent.
- Calculates "impossible travel" to see if a user could realistically log in at different locations around the globe in a reasonable time frame.
- When a login request occurs from an unexpected IP address, a user receives an email to notify them of a new login with an approximate location of the IP address.

## IP Access Control Lists

You may want to restrict an application or API key to a certain IP address or range of IP addresses. With Advanced Threat Detection, you can do this. Create an IP address access control list (IP ACL) in the FusionAuth admin UI at **Settings -> IP Access Control**:

<img src="/img/docs/operate/secure-and-monitor/ip-acl-list.png" alt="The IP access control list configuration screen." width="1200" />

<Aside type="danger">
Be careful when enabling an ACL for the default tenant or a FusionAuth application. If you make a mistake you will not be able to log in with your administrator account to make changes because your IP address is restricted. You will have to remove the ACL by connecting to the FusionAuth database and altering tables.
</Aside>

Then apply the ACL to an application by browsing to <InlineField>Applications</InlineField>, editing one, and choosing the ACL on the <InlineField>Security</InlineField> tab under <InlineField>Access control lists settings</InlineField>. This will prevent a user from being able to even access an application login page if they are not in the IP address range. If you have internal applications, or applications to which access should otherwise be limited, this feature can help secure them.

You can restrict access on a Tenant instead of an Application in the same way — edit the <InlineField>Security</InlineField> tab of a Tenant. The ACL restriction will then be applied to every Application and user belonging to that Tenant.

<img src="/img/docs/operate/secure-and-monitor/ip-acl-application.png" alt="Applying an IP ACL to an application." width="1200" />

In addition to restricting users to an IP range, you can also restrict API keys. This is useful if you are managing your FusionAuth configuration via a CI/CD system. You can create an API key to modify configurations, but limit that key to the IP address range of your CI/CD system, increasing security and lowering the risk of the API key being used incorrectly.

You also might want only administrators in your company to make API calls to your application, and restrict an API key to IP addresses in your building. Edit API key security by browsing to <InlineField>Settings</InlineField>-><InlineField>API Keys</InlineField> and editing a key.

<img src="/img/docs/operate/secure-and-monitor/ip-acl-api-key.png" alt="Applying an IP ACL to an API key." width="1200" />

A final use of IP address restriction is the case of denial of service attacks. If an adversary is making thousands of calls a minute to your application, performance will degrade. If you detect an IP address spamming your application, block it in FusionAuth or in your network gateway.

### Usability Considerations

In general, restricting IP addresses for users will be more harmful than beneficial. The use of personal VPNs has risen greatly in the last few years, due to people avoiding national firewalls, digital sanctions against countries, governments spying on citizens, and corporate data collection and privacy violations. The IP address your application sees for a user might not indicate their actual country if they use a VPN. It's becoming more common for IP addresses of users to change frequently. Employees work from home, remotely, or use dynamic IP addresses from their Internet service provider instead of static ones. VPNs also reduce the reliability of impossible travel calculations. Finally, if you see suspicious behavior from an IP address that is a VPN gateway, you should not ban that address and lock out all other users of that VPN.

In addition to IP address restriction to being unpleasant for users, you cannot completely trust the reported IP addresses of clients. As an IP request passes through the internet through various proxy servers, they record the path of addresses in the `X-Forwarded-For` HTTP header. If any proxy lies or is misconfigured then FusionAuth might grant access to an IP address of a client that should not be trusted.

Be careful when setting an ACL that you are not causing unnecessary difficulty for users of your system. You could instead use another solution, like CAPTCHA or rate limiting.

## Registration Email Domain Blocking

If you enable self-service registration, users can provide any email address they like. But you may have email domains that have elevated privileges, like your `company.com` domain. There may be email addresses for which you want to block registration, like consumer `gmail.com` addresses if your application is aimed at business users.

In either of these cases, you can block one or more domains from the registration process using Advanced Threat Detection.

<img src="/img/docs/operate/secure-and-monitor/block-domains.png" alt="Blocking consumer facing domains from registering." width="1200" />

## Webhooks And Emails

You can configure FusionAuth to send emails and webhooks when certain security events occur. The difference between the two is that emails are sent to the end user of your application for a security event associated with their account, and webhooks can be sent to any external system for a wide variety of security events.

Emails can be configured separately for tenants and applications. Webhooks can be configured for all tenants (global webhooks) or configured separately per tenant. Unlike emails, webhooks cannot be configured per application.

### Emails

Emails can be sent to the user when an event involving their account occurs. You can add your [own email templates](/docs/customize/email-and-messages/). There is a sample ["Threat Detected" email template](/docs/customize/email-and-messages/templates-replacement-variables#threat-detected) that documents available variables. Security related emails may be localized, like any other email template.

If you need help setting up email in FusionAuth for the first time, please see the [guide to SMTP](/docs/customize/email-and-messages/configure-email).

Here are the security events for which you can send emails:

- Email update — someone changed a user's email address. This mail is sent to the new and old addresses.
- Forgot password — someone starts the "Forgot password" workflow for a user.
- Login Id duplicate on create — someone tried to create another user with this user's email address.
- Login Id duplicate on update — someone tried to change their email address to this user's email address.
- Login with new device — someone logged in with a device not previously used.
- Suspicious login — the login has been flagged by FusionAuth as suspicious.
- Password reset success — a successful "Forgot password" flow for the user has completed.
- Password update — a user's password has been updated.
- Passwordless login — someone requests a login link sent to the user's email address.
- Setup password — a new account has been created for the user, and they are asked to set a password.
- Two-factor method added — a two-factor authentication method was added to the user's account.
- Two-factor method removed — a two-factor authentication method was removed from the user's account.

You can configure emails for Tenants by browsing to **Tenant -> Your Tenant -> Email -> Template Settings** or for Applications by browsing to **Applications -> Your Application -> Email -> Templates**.

<img src="/img/docs/operate/secure-and-monitor/security-emails-list.png" alt="List of email templates." width="1200" />

The easiest way to test security emails is to trigger the "Login with new device" email by logging in to FusionAuth from a private browser window. Below is how the "Threat Detected" email template looks to the user.

<img src="/img/docs/operate/secure-and-monitor/security_email.png" alt="What getting a security email looks like" width="1200" />

### Webhooks

A webhook is an outbound HTTP request bearing a message to an endpoint. A webhook is used to inform an external system of some event in FusionAuth. The webhook/API terminology can be confusing. Note that most web applications, including FusionAuth, call a trigger to send data a "webhook", but when receiving data the term "API" is used. So if you're looking for a destination for a FusionAuth webhook in an external system, you won't find it under the webhook documentation; you'll find it under [API documentation](/docs/apis/webhooks). This is why webhooks are sometimes known as "reverse APIs". However, some companies, like Slack in their documentation, also call incoming requests "incoming webhooks".

Webhooks can be sent to any IP address. There are a number of security related events that your Security Information and Event Management (SIEM) or other analytics systems may want to process, such as when MFA has been disabled for a user or when a user has requested a password reset.

Here's the full list of Advanced Threat Detection webhooks:

<WebhookList/>

For a comprehensive explanation of using webhooks in FusionAuth, please read [the guide](/docs/extend/events-and-webhooks). If you want to send webhooks programmatically, you can do so using the [FusionAuth API](/docs/apis/webhooks).

If you want to see an example webhook, the easiest way is to browse to https://public.requestbin.com/r and paste the random link they give you, such as `https://enxy8i2pfzcy9.x.pipedream.net`, into the <InlineField>URL</InlineField> of a new webhook you create on the **Settings -> Webhooks** page.

Then in your tenant's webhooks tab, enable <InlineField>user.login.new-device</InlineField>. Open a new incognito browser window and log in to FusionAuth.

You will see JSON like the following arriving in the logs of `requestbin.com`.


```json
{
  "event": {
    "applicationId": "3c219e58-ed0e-4b18-ad48-f4f92793ae32",
    "authenticationType": "PASSWORD",
    "connectorId": "e3306678-a53a-4964-9040-1c96f36dda72",
    "createInstant": 1713179501580,
    "id": "30caed6b-829f-47a3-8733-ab62a9c2e76b",
    "info": {
      "deviceName": "Linux Chrome",
      "deviceType": "BROWSER",
      "ipAddress": "127.0.0.1",
      "userAgent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36"
    },
    "ipAddress": "127.0.0.1",
    "tenantId": "d7d09513-a3f5-401c-9685-34ab6c552453",
    "type": "user.login.new-device",
    "user": {
      "active": true,
      "birthDate": "1985-11-23",
      "connectorId": "e3306678-a53a-4964-9040-1c96f36dda72",
      "data": {},
      "email": "richard@example.com",
      "firstName": "Fred",
      "id": "00000000-0000-0000-0000-111111111111",
      "insertInstant": 1712746261562,
      "lastLoginInstant": 1713179501579,
      "lastName": "Flintstone",
      "lastUpdateInstant": 1712746261562,
      "memberships": [],
      "passwordChangeRequired": false,
      "passwordLastUpdateInstant": 1712746261581,
      "preferredLanguages": [],
      "registrations": [
        {
          "applicationId": "e9fdb985-9173-4e01-9d73-ac2d60d1dc8e",
          "data": {
            "favoriteColor": "turquoise"
          },
          "id": "03ec163e-b4d6-43ba-84f1-963318011e1b",
          "insertInstant": 1712746261587,
          "lastLoginInstant": 1712746261587,
          "lastUpdateInstant": 1712746261587,
          "preferredLanguages": [],
          "roles": [],
          "tokens": {},
          "usernameStatus": "ACTIVE",
          "verified": true,
          "verifiedInstant": 1712746261587
        }
      ],
      "tenantId": "d7d09513-a3f5-401c-9685-34ab6c552453",
      "twoFactor": {
        "methods": [],
        "recoveryCodes": []
      },
      "usernameStatus": "ACTIVE",
      "verified": true,
      "verifiedInstant": 1712746261562
    }
  }
}
```

To receive a webhook for a location-aware event, use the `user.login.suspicious` event for your tenant.

Using webhooks in combination with API calls to FusionAuth, you can write a simple web server script to perform a variety of security tasks. For instance, if the script received the event `user.password.breach` it could call FusionAuth to change the user's password to a random UUID. This would force the user to complete the "Forgot password" workflow and choose a safer password.