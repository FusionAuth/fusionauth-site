---
title: Monitor With OpenTelemetry
description: Learn how to monitor FusionAuth with OpenTelemetry.
navcategory: admin
section: operate
subcategory: monitor
---
import Aside from 'src/components/Aside.astro';
import DownloadWidget from 'src/components/download/DownloadWidget.astro';
import {RemoteCode} from '@fusionauth/astro-components';
import WhatIsOpenTelemetry from 'src/components/docs/operate/secure-and-monitor/whatIsOpentelemetry.mdx';
import Diagram1 from 'src/components/docs/operate/secure-and-monitor/opentelemetryDiagram1.astro';
import Diagram2 from 'src/components/docs/operate/secure-and-monitor/opentelemetryDiagram2.astro';
export const dockerComposeExtraDownloads = [
  {source: "https://raw.githubusercontent.com/FusionAuth/fusionauth-containers/main/docker/fusionauth/opentelemetry-collector-config.yml", destination: "opentelemetry-collector-config.yml"},
  {source: "https://raw.githubusercontent.com/FusionAuth/fusionauth-containers/main/docker/fusionauth/prometheus-opentelementry-config.yml", destination: "prometheus-config.yml"}
];

## Overview

<WhatIsOpenTelemetry></WhatIsOpenTelemetry>

Please read the [FusionAuth monitoring overview](/docs/operate/secure-and-monitor/monitor) before proceeding. The overview explains the FusionAuth metrics, the activities that comprise a complete monitoring workflow, and the tools that complement OpenTelemetry, such as Prometheus and Elastic (which have their own FusionAuth guides). Review the [alternative monitoring services](/docs/operate/secure-and-monitor/monitor#overview-of-popular-monitoring-tools) in the overview to ensure that OpenTelemetry is the right tool for your needs.

## Architecture for using OpenTelemetry with FusionAuth

Running FusionAuth and PostgreSQL in Docker usually looks like the diagram below (you might also run OpenSearch in another Docker container).

<Diagram1></Diagram1>

This diagram shows three components that could fail and need monitoring: the PostgreSQL database, FusionAuth, and your app's backend. In this guide, you'll focus on monitoring FusionAuth.

The tool you'll use to monitor FusionAuth is the OpenTelemetry Collector. It consists of two types of components:

* A **receiver**, which monitors a container or application and either directly produces metrics or receives metrics from another tool
* An **exporter**, which exposes these metrics to other tools

The Collector can also process the values it receives before exporting them.

Since FusionAuth is not instrumented with OpenTelemetry directly, there are three ways you can use OpenTelemetry to export FusionAuth metrics:

* Run an OpenTelemetry exporter inside the FusionAuth Docker container to monitor the Java Virtual Machine (JVM) in which FusionAuth runs
  * We don't recommend this approach for two reasons:
    * First, you have to alter the provided Docker image to include the Java agent and to create a new image every time FusionAuth releases an update
    * Second, the metrics the JVM provides also don't provide much useful information about FusionAuth itself
* Run an OpenTelemetry exporter in its own Docker container on your host
  * This will allow you to know whether FusionAuth is up and receive basic container health metrics, like CPU and RAM use
  * Since FusionAuth provides a Prometheus monitoring endpoint, you won't need admin permissions in order to monitor FusionAuth in a Docker container
* Write a custom script to request metrics from the FusionAuth API and forward them to an OpenTelemetry collector
  * This will allow you to monitor specific FusionAuth metrics, like application errors and user login rates

We'll set up the last two options below.

If you are not using a monitoring service already, you will need to install Prometheus to view the OpenTelemetry metrics. That installation is explained briefly in this guide, but please work through the [Prometheus monitoring guide](/docs/operate/secure-and-monitor/prometheus) too. OpenTelemetry also monitors more than Prometheus â€” OpenTelemetry can trace an entire web request across services, instead of recording only a metric at a point in time.

One main thing to be aware of is that most FusionAuth users probably won't need to use OpenTelemetry. Rather, Prometheus alone should be enough to monitor FusionAuth. The primary advantage running an OpenTelemetry collector provides is that it allows you to write a script that requests custom metrics (like user login counts) from the FusionAuth API and sends them through the OpenTelemetry collector to Prometheus. This allows you to get more information from FusionAuth than you can get from Prometheus alone.

<Aside type="note">
If you're wondering how Prometheus can poll the OpenTelemetry Collector for metrics if the Collector doesn't store metrics, it's because the Collector keeps recently received metrics in RAM. However, the Collector does not store them for long or persist metrics to disk.
</Aside>

In the following sections, you will run:

- The OpenTelemetry Collector in Docker to poll the FusionAuth Prometheus endpoint
- A bash script in another container to poll the FusionAuth API to get data about user logins
- Prometheus in a final container to receive both the OpenTelemetry metrics

<Diagram2></Diagram2>

This guide focuses on OpenTelemetry, not Prometheus and Grafana, and so uses the OpenTelemetry Collector. However, as of 2024, Grafana has released their own free and open-source version of an OpenTelemetry collector, called [Alloy](https://grafana.com/oss/alloy-opentelemetry-collector), that supports all Prometheus and OpenTelemetry protocols. It is component-based and has features that the OpenTelemetry Collector does not. You may prefer to use Alloy instead of OpenTelemetry Collector in your project.

![Grafana Alloy](/img/docs/operate/secure-and-monitor/opentelemetry/alloy.png)

## Run OpenTelemetry and Prometheus in Docker to Monitor FusionAuth

Our standard Docker Compose configuration file includes OpenTelemetry and Prometheus as optional services. It is simple to enable these services using [Docker Compose profiles](https://docs.docker.com/compose/how-tos/profiles/).

Even if you have already installed FusionAuth using Docker Compose, you'll need to follow these instructions in order to pull down the correct OpenTelemetry and Prometheus configuration files. If you skip this step, you'll need to download and manually configure these files. Here are the installation instructions:

<DownloadWidget dockerComposeArgs="--profile opentelemetry --profile prometheus up" dockerComposeExtraDownloads={dockerComposeExtraDownloads} includeDocker={true} includeDockerVanilla={false} includeFastPath={false} kickstartEnabled={true} kickstartName="get-started"/>

<Aside type="note">
  The commands you just ran configured FusionAuth using [Kickstart](/docs/get-started/download-and-install/development/kickstart) in order to have an API key configured for OpenTelemetry to use. You can always configure OpenTelemetry and Prometheus by hand if you profer. If you want to manually configure these services, you'll need to edit the `opentelemetry-collector-config.yml` and `prometheus-config.yml` files. Configuring those files is out of scope of this document, but you can consult the [OpenTelemetry](https://opentelemetry.io/docs/collector/configuration/) and [Prometheus](https://prometheus.io/docs/prometheus/latest/configuration/configuration/) docs to learn more.
</Aside>

The Collector is configured to pull metrics from the apps it monitors (`receivers`) and allow other apps (`exporters`) to pull metrics from it. Let's look at how this is configured. Open the file `opentelemetry-collector-config.yml`. It should look something like this:

<RemoteCode lang="yaml" url="https://raw.githubusercontent.com/FusionAuth/fusionauth-containers/develop/docker/fusionauth/opentelemetry-collector-config.yml"/>

Notice that the `receivers` section contains a scrapper that pulls in data from FusionAuth's Prometheus endpoint every 15 seconds. This uses the Docker Compose name of `fusionauth` to pull from that service running inside the Docker Compose network (making the full URL `http://fusionauth:9011/api/prometheus/metrics`).

At the end of this section, you'll see that this `receiver` is using basic authentication to call the Prometheus endpoint using the API key that was created by [Kickstart](/docs/get-started/download-and-install/development/kickstart).

One other item to call out in this configuration file is that the `pipeline` definition at the bottom includes the ability for `receivers` to handle `otlp` (OpenTelemetry Protocol). This is important when we write a custom script below to send additional details to OpenTelemetry.

Next, let's look at how Prometheus is configured. Open the file `prometheus-config.yml`. It should look something like this:

<RemoteCode lang="yaml" url="https://raw.githubusercontent.com/FusionAuth/fusionauth-containers/develop/docker/fusionauth/prometheus-opentelemetry-config.yml"/>

This configures Prometheus to pull metrics from the OpenTelemetry Collector every fifteen seconds.

You can open Prometheus' monitoring interface in a browser at http://localhost:9090. To check that metrics are being pulled correctly, enter `up` on the Prometheus graph page and see whether any values appear after a minute. If you see nothing, check the Docker log files in the terminal for any errors.

![Prometheus metrics](/img/docs/operate/secure-and-monitor/opentelemetry/prometheus.png)

## Send Custom Metrics to the OpenTelemetry Collector

FusionAuth provides only some information on its Prometheus endpoint. If you can't find the information you are looking for in Prometheus, such as user login details, you'll need to extract it yourself. In this section, you'll learn how to use a custom metrics script to extract information from FusionAuth.

First, create a file named `app.sh` in the same directory where the Docker Compose files you downloaded above are located and add this code to it:

```sh
#!/bin/sh

# Exit on error
set -e

# 1 - Calculate the date range for the export
date_format=$(echo -n "yyyy-MM-dd'T'HH:mm:ss.SSS" | jq -sRr @uri)
end=$(date +%s)000
start=$((end - 60000))  # milliseconds

# 2 - Calculate the full FusionAuth API URL
fusionauth_api_key="33052c8a-c283-4e96-9d2a-eb1215c69f8f-not-for-prod"
fusionauth_application_id="3c219e58-ed0e-4b18-ad48-f4f92793ae32"
fusionauth_url="http://fusionauth:9011/api/system/login-record/export?applicationId=${fusionauth_application_id}&dateTimeSecondsFormat=${date_format}&start=${start}&end=${end}"

# 3 - Call the URL
echo "curl -H \"Authorization: ${fusionauth_api_key}\" -o record.zip \"${fusionauth_url}\""
curl -H "Authorization: ${fusionauth_api_key}" -o record.zip "${fusionauth_url}"
unzip -o record.zip
cat login_records.csv

# 4 - Parse the CSV file and for each record extract the user id and unix time in ms
opentelemetry_url="http://opentelemetry:4318/v1/metrics"
tail -n +2 login_records.csv | while IFS=',' read -r user_id time rest; do
  user_id=$(echo "$user_id" | tr -d ' "' )
  time=$(echo "$time" | tr -d ' "')                      # 2024-06-21T05:14:56.123
  time=$(echo "$time" | tr 'T' ' ')                      # 2024-06-21 05:14:56.123
  sec="$(date -d "$(echo $time | cut -d '.' -f 1)" +%s)" # 1718946896
  ms="$(echo $time | cut -d '.' -f 2)"                   # 123

   # 5 - Create a JSON object that contains the OpenTelemetry Protocol object
   json_payload=$(cat <<EOF
{
  "resource_metrics": [{
    "resource": {
      "attributes": [
        {"key": "service.name", "value": {"stringValue": "fusionauth"}},
        {"key": "host", "value": {"stringValue": "fusionauth"}}
      ]
    },
    "scope_metrics": [{
      "metrics": [{
        "name": "login_event",
        "gauge": {
          "dataPoints": [{
            "asInt": 1,
            "timeUnixNano": "${sec}${ms}000000",
            "attributes": [ {"key": "user_id", "value": {"stringValue": "${user_id}"}} ]
          }]
        }
      }]
    }]
  }]
}
EOF
)

  # 6 - Call the OpenTelemetry Collector with the JSON object
  curl -X POST -H "Content-Type: application/json" -d "${json_payload}" ${opentelemetry_url}
done
```

Let's review what this code does in each step.

1. Use a bit of date magic to determine the number of milliseconds since Epoch now as well as a minute ago and also prepares the format that FusionAuth will return timestamps in
2. Calculate the full URL to the FusionAuth API that will export login records from the last minute (this uses the API key configured above using [Kickstart](/docs/get-started/download-and-install/development/kickstart))
3. Call the FusionAuth API and unzip the ZIP file that contains the CSV export of the login records
4. Parse the CSV and for each record, extract the user id and the timestamp
5. Construct an OpenTelemetry Protocol JSON object that will be sent to the OpenTelemetry Collector
6. Send the JSON to OpenTelemetry using the Docker Compose name `opentelemetry` on the Docker network

Next, we need to build this script into a Docker image by creating a file called `Dockerfile` with the content below. The last line of this Dockerfile runs the script every sixty seconds.

```sh
FROM --platform=$BUILDPLATFORM ubuntu:noble AS build
RUN apt-get update
RUN apt-get install -y curl jq unzip
COPY app.sh /app.sh
RUN chmod +x /app.sh
CMD while true; do /app.sh; sleep 60; done
```

Now we can run the Docker build using this command (NOTE: if you are on an Intel based machine, you will need to change the `--platform` option to `--platform=linux/amd64`):

```sh
docker build --platform=linux/arm64 -t opentelemtery-data-extractor .
```

In order for this image to work in our Docker Compose setup, copy this to the definition into the `docker-compose.yml` file right under the `prometheus` definition:

```yml
  opentelemetry-data-extractor:
    image: opentelemtery-data-extractor
    depends_on:
      - fusionauth
      - opentelemetry
```

You will need to stop Docker Compose (usually via a ctrl-c in the terminal) and then restart it using the same command from above.

Once Docker Compose starts up all the services, go ahead and log into and out of FusionAuth a couple of times. To do this, open a browser to http://localhost:9011/admin and use these credentials:

* **Email**: admin@example.com
* **Password**: password

The next time our script runs, you should see some output in the Docker Compose logs for the service as it runs.

If the OpenTelemetry Collector and data extraction script are working properly, you will be able to search in the Prometheus UI for the `login_event` metric and see a graph of it.

Since the metrics are separated by user id, you might find these queries helpful in pulling aggregate metrics:

1. `count_over_time(login_event[5h])`
2. `sum(count_over_time(login_event{exported_job="fusionauth", instance="opentelemetry:8889", job="opentelemetry"}[5h]))`
3. `sum without(user_id) (count_over_time(login_event{exported_job="fusionauth", instance="opentelemetry:8889", job="opentelemetry"}[5h])) /5`

Alternatively, you can remove the `attributes` property in the JSON section of `app.sh`, so that the `login_event` sent to the Collector has no user information.

If you need to debug the script for any reason, you can log into the Docker container for the `opentelemetry-data-extractor` service and run and edit the script from there.

## FusionAuth Metrics to Monitor

You can add any other metrics you want to monitor to the `app.sh` script. Or you can write an entirely separate service (in the language of your choice) that calls the FusionAuth APIs and forwards metrics and data to OpenTelemetry. FusionAuth has [numerous metrics](/docs/operate/secure-and-monitor/monitor#metrics) that you can use for monitoring.

In addition to the metrics available through the various FusionAuth APIs, you can create your own metrics using any events that trigger [webhooks](/docs/extend/events-and-webhooks). A webhook can call another Docker container (created by you) that listens for incoming events and forwards them to the Collector.

A useful metric to start with is login counts. If this number drops from the average, it's a good sign something might be wrong with your system.

## Next Steps

OpenTelemetry is not a standalone tool. Read the FusionAuth guides to [Prometheus](/docs/operate/secure-and-monitor/prometheus) and [Elastic](/docs/operate/secure-and-monitor/elastic) to choose a complete system that provides a dashboard with alerts you can use in conjunction with OpenTelemetry.

## Further Reading

- [FusionAuth monitoring overview](/docs/operate/secure-and-monitor/monitor)
- [FusionAuth metrics](/docs/operate/secure-and-monitor/monitor#metrics)
- [OpenTelemetry Collector configuration documentation](https://opentelemetry.io/docs/collector/configuration)
