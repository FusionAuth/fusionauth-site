---
---

<div class="gap-y-6 grid md:grid-cols-2 gap-5 my-8">
  <div class="row-span-2 flex flex-col">
    <div id="encoded-textarea" class="relative flex-1">
      <span
        class="label absolute bg-white block font-medium leading-none left-2 px-2 text-slate-700 text-xs -top-[.5em] z-20 dark:bg-slate-900 dark:text-white"
        >Token</span
      >
    </div>
    <span class="italic text-xs mt-1"
      >Paste a JSON web token into the text area above</span
    >
  </div>
  <div id="header-textarea" class="relative">
    <span
      class="label absolute bg-white block font-medium leading-none left-2 px-2 text-slate-700 text-xs -top-[.5em] z-20 dark:bg-slate-900 dark:text-white"
      >Header</span
    >
  </div>

  <div id="payload-textarea" class="relative">
    <span
      class="label text-sm absolute top-[-0.8em] left-[1ch] z-10 bg-white px-[2ch]"
      >Payload</span
    >
  </div>
</div>

<script>
  "use strict";
  import { json } from "@codemirror/lang-json";
  import { MatchDecorator, ViewPlugin, Decoration } from "@codemirror/view";
  import { EditorView, basicSetup } from "codemirror";

  const token =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE0ODUxNDA5ODQsImlhdCI6MTQ4NTEzNzM4NCwiaXNzIjoiYWNtZS5jb20iLCJzdWIiOiIyOWFjMGMxOC0wYjRhLTQyY2YtODJmYy0wM2Q1NzAzMThhMWQiLCJhcHBsaWNhdGlvbklkIjoiNzkxMDM3MzQtOTdhYi00ZDFhLWFmMzctZTAwNmQwNWQyOTUyIiwicm9sZXMiOltdfQ.Mp0Pcwsz5VECK11Kf2ZZNF_SMKu5CgBeLN9ZOP04kZo";
  const { headers, payload } = decodeJwt(token);

  function decodeJwt(stringToDecode) {
    const s = stringToDecode.split(".");

    const headers = window.JSON.stringify(
      window.JSON.parse(window.atob(s[0])),
      null,
      2,
    );
    const payload = window.JSON.stringify(
      window.JSON.parse(window.atob(s[1])),
      null,
      2,
    );
    return { payload, headers };
  }

  // Function to check if this change is applied via one of our programmatic shifts
  function isProgrammatic(transactions) {
    if (transactions.length == 0) return false;
    if (
      transactions.length > 0 &&
      typeof transactions[0].annotations[0].value !== "number"
    )
      return false;
    return true;
  }

  // Decorator for color coding the token
  const tokenDec = Decoration.mark({ class: "headerDec" }); // This adds a className to the text that matches the regex.

  const tokenDecorator = new MatchDecorator({
    regexp: /([^.]+)/g,
    decoration: () => tokenDec,
  });
  const tokenColors = ViewPlugin.define(
    (view) => ({
      decorations: tokenDecorator.createDeco(view),
      update(u) {
        this.decorations = tokenDecorator.updateDeco(u, this.decorations);
      },
    }),
    {
      decorations: (v) => v.decorations,
    },
  );

  // Inits CodeMirror for Tokens
  const tokenEditor = new EditorView({
    parent: document.getElementById("encoded-textarea"),
    doc: token,

    extensions: [
      basicSetup,
      tokenColors,

      EditorView.lineWrapping,
      EditorView.updateListener.of((update) => {
        if (update.docChanged) {
          const programUpdated = isProgrammatic(update.transactions);
          if (!programUpdated) {
            const { headers, payload } = decodeJwt(update.state.doc.text[0]);

            headersEditor.dispatch({
              changes: {
                from: 0,
                to: headersEditor.state.doc.length,
                insert: headers,
              },
            });
            payloadEditor.dispatch({
              changes: {
                from: 0,
                to: payloadEditor.state.doc.length,
                insert: payload,
              },
            });
          }
        }
      }),
    ],
  });

  // Inits CodeMirror for Header
  const headersEditor = new EditorView({
    parent: document.getElementById("header-textarea"),
    doc: headers,

    extensions: [
      basicSetup,
      EditorView.lineWrapping,
      json(),
      EditorView.updateListener.of((update) => {
        if (update.docChanged) {
          const programUpdated = isProgrammatic(update.transactions);
          if (!programUpdated) {
            const currentToken = tokenEditor.state.doc.text[0].split(".");
            const docText = update.state.doc.text.join("");
            const updatedHeader = window.btoa(docText);

            tokenEditor.dispatch({
              changes: {
                from: 0,
                to: tokenEditor.state.doc.length,
                insert: `${updatedHeader}.${currentToken[1]}`,
              },
            });
          }
        }
      })
    ],
  });

  // Inits CodeMirror for Payload

  const payloadEditor = new EditorView({
    parent: document.getElementById("payload-textarea"),
    doc: payload,
    extensions: [
      basicSetup,
      EditorView.lineWrapping,
      json(),
      EditorView.updateListener.of((update) => {
        if (update.docChanged) {
          const programUpdated = isProgrammatic(update.transactions);
          if (!programUpdated) {
            const docText = update.state.doc.text.join("");

            const currentToken = tokenEditor.state.doc.text[0].split(".");
            const updatedPayload = window.btoa(docText);

            tokenEditor.dispatch({
              changes: {
                from: 0,
                to: tokenEditor.state.doc.length,
                insert: `${currentToken[0]}.${updatedPayload}`,
              },
            });
          }
        }
      })
    ],
  });

</script>

<style is:global>
  #encoded-textarea {
    display: grid;
  }
  .cm-editor {
    height: 100%;
    padding: 0.5rem;
    border: 1px solid #3e4e50;
    border-radius: 5px;
    background-color: white;
  }
  .cm-editor .cm-activeLine {
    background: transparent;
  }
  .cm-editor .cm-gutters.cm-gutters-before {
    display: none;
  }
  .headerDec:first-of-type {
    color: green;
  }
  .headerDec:nth-of-type(2) {
    color: blue;
  }
  .headerDec:nth-of-type(3) {
    color: red;
  }
</style>
