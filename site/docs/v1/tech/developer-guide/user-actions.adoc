---
layout: doc
title: User Actions
description: Using user actions
navcategory: developer
---

== Overview

User Actions in FusionAuth can be quite powerful. They are often used to temporarily disable access to a user upon some infringement or account review. However, they can be used in positive scenarios as well. We'll model a common type of scenario in this tutorial: A user buys temporary access to a news site. You can apply a FusionAuth User Action to broadcast the purchase to sister news sites so that they can upsell the user a subscription and send automatic emails to the user when they subscribe, modify or cancel their subscription, and when the subscription expires.

== Prerequisites

We'll explain nearly everything that we use, but we expect you to have:

* Docker and Docker Compose set up as we'll set up FusionAuth using these.
* link:https://curl.se[cURL], link:https://www.postman.com[Postman], or a similar tool installed to send test HTTP requests to the FusionAuth API.

=== Creating an application

Click [uielememt]#Setup# under [uielement]#Missing Application# and call your new app "Silicon Valley Chronicle" or another name of your choice. Select a [breadcrumb]#Tenant# if you've set more than one up already.
 
image::blogs/fusionauth-user-actions/user-actions-add-application.png[Add FusionAuth Application,width=1200px]

Click the [uielement]"Save" button at the top right for your changes to take effect.

=== Creating a user
 
Two users are required for a User Action to take effect: an `actioner` and an `actionee`. The `actioner` will be the admin user that you created when you set up FusionAuth for the first time. The `actionee` will be the user who buys temporary access to our news site.
 
To create a user, navigate to [breadcrumb]#Users# and click the [uielement]#Add# button. Then supply an email address. You can untoggle the [uielement]#Send email to set up password# switch to supply a password straight away.

Record the Ids of both users.
 
image::blogs/fusionauth-user-actions/user-actions-create-user.png[Create User,width=1200px]

=== Creating an API key
 
We will create and execute our User Action through API calls, so we need to set up an API Key. Navigate to [breadcrumb]#Settings, then API Keys# and click the [uielement]#Add# button. Make sure `POST` is enabled for both the `/api/user-action` and `/api/user/action` endpoints. We will use the former to create our User Action and the latter to execute it.
 
image::blogs/fusionauth-user-actions/user-actions-create-api-key.png[Create API Key,width=1200px]
 
Record the value of your API Key.

image::blogs/fusionauth-user-actions/user-actions-api-key-created.png[API Key Created,width=1200px]

=== Creating email templates
 
Our User Action will send four different emails to the `actionee` upon four different conditions: when they `sign up`, if they `modify` or `cancel` their subscription, and when that subscription `expires`. Create four email templates for each of these conditions and record their Ids under [breadcrumb]#Customizations, Email Templates#. More information on email templates in FusionAuth can be found link:https://fusionauth.io/docs/v1/tech/email-templates/email-templates#overview[here].
 
image::blogs/fusionauth-user-actions/user-actions-email-templates.png[Email Templates,width=1200px]

=== Creating the User Action
 
We can now create a link:https://fusionauth.io/docs/v1/tech/apis/user-actions[User Action definition] with the email template Ids and `POST` to the `/api/user-action` route. Setting the `temporal` attribute to `true` allows us to set an `expiry` time when we execute the action on a user. This means that the action will automatically be removed from the user after the time set in `expiry`. We can also set `sendEndEvent` to `true` so that we can be notified via webhook when the access period has expired.
 
[source,shell,title="Create user action via API"]
----
curl --location --request POST 'https://<YOUR_FUSIONAUTH_URL>/api/user-action' \
 --header 'Authorization: <YOUR API KEY>' \
 --header 'Content-Type: application/json' \
 --data-raw '{
 "userAction": {
  "name": "Bought Temporary Access",
  "startEmailTemplateId": "5eaf58e7-2e5a-4eea-94b8-74a707724f7b",
  "endEmailTemplateId": "18490dc2-b3d4-462f-9a8e-882b4fb4e76f",
  "modifyEmailTemplateId": "2011460f-bd11-4134-ba8a-9d4c6c4a23ae",
  "cancelEmailTemplateId": "981a1ecf-4a1d-44b8-8211-3215cb80319f",
  "temporal": true,
  "userEmailingEnabled": true,
  "sendEndEvent": true
  }
 }'
----

In this command, replace `<YOUR_FUSIONAUTH_URL>` with the URL of your FusionAuth instance, `<YOUR API KEY>` with the API key noted earlier, and the `startEmailTemplateId`, `endEmailTemplateId`, `modifyEmailTemplateId`, and `cancelEmailTemplateId` with appropriate values.

FusionAuth should return something similar to the following:

[source,json,title="Returned json after creating user action via API"]
----
{
 "userAction": {
  "active": true,
  "cancelEmailTemplateId": "981a1ecf-4a1d-44b8-8211-3215cb80319f",
  "endEmailTemplateId": "18490dc2-b3d4-462f-9a8e-882b4fb4e76f",
  "id": "6f4115c0-3db9-4734-aeda-b9c3f7dc4269",
  "includeEmailInEventJSON": false,
  "insertInstant": 1674937446558,
  "lastUpdateInstant": 1674937446558,
  "modifyEmailTemplateId": "2011460f-bd11-4134-ba8a-9d4c6c4a23ae",
  "name": "Bought Temporary Access",
  "options": [],
  "preventLogin": false,
  "sendEndEvent": true,
  "startEmailTemplateId": "5eaf58e7-2e5a-4eea-94b8-74a707724f7b",
  "temporal": true,
  "transactionType": "None",
  "userEmailingEnabled": true,
  "userNotificationsEnabled": false
 }
}
----

Record the `id` value. Here, it is `6f4115c0-3db9-4734-aeda-b9c3f7dc4269`. You can verify that the User Action was created by going to [breadcrumb]#Settings, then User Actions# in the FusionAuth admin portal.
 
image::blogs/fusionauth-user-actions/user-actions-user-action-created.png[User Action Created,width=1200px]

== Setting up webhooks

To propagate a message when a user action is taken to our sister news sites, we can set up a webhook. To do this, navigate to [breadcrumb]#Settings, then Webhooks# and click the [uielement]#Add# button. To simulate the endpoint of our sister news site that will consume the user action information, we will use link:https://webhook.site[https://webhook.site]. If you visit this page, it will generate a unique URL of the form `https://webhook.site/<YOUR_WEBHOOK_SITE_ID>`. Copy this URL into the [field]#URL# field.
 
image::blogs/fusionauth-user-actions/user-actions-add-webhook.png[Add Webhook",width=1200px]
 
Scroll down and make sure that the [uielement]#user.action# event is enabled.
 
image::blogs/fusionauth-user-actions/user-actions-webhook-switch.png[Webhook event switch,width=1200px]
 
Then, select the [breadcrumb]#Tenants# tab and select your tenant. Alternatively, you can select [uielement]#All tenants#.
 
image::blogs/fusionauth-user-actions/user-actions-webhook-tenant.png[Enable tenant on webhook page,width=1200px]
 
Navigate to [breadcrumb]#Tenants, then Your tenant#, and select the [breadcrumb]#Webhooks# tab. Make sure that the webhook is enabled. If you selected [uielement]#All tenants# on the webhook page, its checkbox will be disabled.
 
image::blogs/fusionauth-user-actions/user-actions-tenants-webhooks.png[Webhook enabled on tenants page,width=1200px]
 
Scroll down and make sure the [uielement]#user.action# event is enabled here too.
 
image::blogs/fusionauth-user-actions/user-actions-tenants-switch.png[Tenant event switch,width=1200px]

== Executing the User Action
 
Now you can link:https://fusionauth.io/docs/v1/tech/apis/actioning-users[apply the action] to a specific user with the `api/user/action` endpoint. The `expiry` time follows the UNIX epoch format in milliseconds. Make sure the `actioneeUserId`, `actionerUserId`, and `userActionId` values match the ones you recorded in the previous steps. Update the `expiry` to a future timestamp.
 
[source,shell,title="Execute the user action"]
----
curl --location --request POST 'https://<YOUR_FUSIONAUTH_URL>/api/user/action' \
 --header 'Authorization: <YOUR API KEY>' \
 --header 'Content-Type: application/json' \
 --data-raw '{
  "broadcast": true,
  "action": {
  "actioneeUserId": "12e22430-162c-4f7e-bf40-58f7a69a26ce",
  "actionerUserId": "5ea819ea-6ff1-4b17-943f-eb2d1c246c3b",
  "comment": "Signed up for 24 hour premium access",
  "emailUser": true,
  "expiry": 1674903995472,
  "userActionId": "fbff792c-2340-4d72-b4fd-534f94d0a94b"
  }
 }'
----

FusionAuth should reply with `200 OK`:

[source,json,title="Response after executing user action"]
----
{
 "action": {
  "actioneeUserId": "12e22430-162c-4f7e-bf40-58f7a69a26ce",
  "actionerUserId": "5ea819ea-6ff1-4b17-943f-eb2d1c246c3b",
  "applicationIds": [],
  "comment": "Signed up for 24 hour premium access",
  "emailUserOnEnd": true,
  "expiry": 1674939392664,
  "id": "8ed1f910-4e62-4dd1-a88e-e45964b56e21",
  "insertInstant": 1674938412450,
  "localizedName": "Bought Temporary Access",
  "name": "Bought Temporary Access",
  "notifyUserOnEnd": false,
  "userActionId": "6f4115c0-3db9-4734-aeda-b9c3f7dc4269"
 }
}
----

When this action is executed, the `actionee` will receive an email thanking them for their subscription.
 
image::blogs/fusionauth-user-actions/user-actions-email.png[Email confirmation,width=1200px]

You can also verify that the request was propagated to the sister news site by checking `https://webhook.site/!#/<YOUR_WEBHOOK_SITE_ID>`. You will see the body of your request in the [field]#Raw Content# field.

image::blogs/fusionauth-user-actions/user-actions-webhook-site.png[Webhook confirmation,width=1200px]

When the action expires, the webhook will be fired again.

== Querying action status on a user

Depending on how you control access to your articles, you might want to check the user to see if they have temporary access actioned. You can do this by link:https://fusionauth.io/docs/v1/tech/apis/actioning-users#retrieve-a-previously-taken-action[querying the actions API] and filtering by user and action:

[source,shell,title="Query user action status"]
----
curl --location --request GET 'https://<YOUR_FUSIONAUTH_URL>/api/user/action?userId=<USER_ID>&active=true' \
--header 'Authorization: <YOUR API KEY>'
----

Replace `<YOUR_FUSIONAUTH_URL>` , `<YOUR API KEY>`, and `<USER_ID>` with the appropriate values. 

FusionAuth will return an object with an array of all actions currently active on the user. You can filter the results to find the `userActionId` of the user action we set up above to test if the user has temporary access:

[source,json,title="Returned value after querying user action status"]
----
{
    "actions": [
        {
            "actioneeUserId": "12e22430-162c-4f7e-bf40-58f7a69a26ce",
            "actionerUserId": "5ea819ea-6ff1-4b17-943f-eb2d1c246c3b",
            "applicationIds": [
                "af4847c4-d183-4e51-ab8a-ce8940909127"
            ],
            "comment": "Signed up for 24 hour premium access",
            "emailUserOnEnd": true,
            "endEventSent": false,
            "expiry": 1675890993000,
            "id": "30e05e8f-fba6-4dd3-852c-abbc2d2e2461",
            "insertInstant": 1675322145449,
            "localizedName": "Bought Temporary Access",
            "name": "Bought Temporary Access",
            "notifyUserOnEnd": false,
            "userActionId": "6f4115c0-3db9-4734-aeda-b9c3f7dc4269"
        }
    ]
}
----

== Conclusion
 
In this tutorial, we used User Actions to flag and email users who buy temporary access to our news site. We also propagate that request to sister news sites so that they can upsell to the user.
 
== Further reading
 
For more information on FusionAuth User Actions, see link::https://fusionauth.io/docs/v1/tech/apis/user-actions#overview[this overview] and link:https://fusionauth.io/docs/v1/tech/apis/actioning-users[this reference on actioning users].
