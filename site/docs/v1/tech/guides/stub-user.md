---
layout: doc
title: Stub users
description: This guide walks you through creating anonymous stub users in FusionAuth.
navcategory: developer
---

## Overview

A "stub" user profile, also known as an anonymous user, is a pattern to allow your users to build up profiles gradually before requiring identifying information such as an email address or username. This is a common pattern with business to consumer or gaming applications, where you want to lower friction as much as possible.

In this guide, you'll be building a Pied Piper video game application. The user can play the game without signing up, and can indicate preferences, such as the character they want to play. They'll also be able to write a mini program within the game. After a certain amount of gameplay, they'll be prompted to sign up with an email address.

## Prerequisites

If you want to follow along with this guide, you need to have the following:

* FusionAuth installed
* ....
* TODO

You can find [the code here TODO](https:...).

Full gameplay is not included in this example.

## Setting Up Stub User Support

Because this workflow isn't supported by the FusionAuth hosted login pages, you'll be building on top of the FusionAuth APIs. This guide uses TODO language, but you can use any of the supported [client libraries](/docs/v1/tech/client-libraries/) or the [REST API](/docs/v1/tech/apis/).

You'll need to

* Set up an API Key with the appropriate permissions
* Set up a stub user profile based on behavior on the site
* Store the stub user id on the device
* Update the stub user profile when the user takes an action, such as writing a mini program or changing a character
* Build a conversion page when the user wants to sign up with an email address to play the game cross device

## Creating The API Key

Navigate to <span>Settings -> API Keys</span>{.breadcrumb} and create a new API Key. This will be used in your custom pages.

It needs to have the following permissions:

* `/api/user`: `POST`, `PATCH`, `GET`
* `/api/jwt/vend`: `POST`
* `/api/jwt/validate`: `POST`
* `/api/user/forgot-password`: `POST`


## Create The Stub User

First, determine when you will create the stub user. The best time to do that is when a user first takes an action worth recording. So, not when they visit the Pied Piper video game site, but when they choose their character (I like Dinesh, myself). 

When that happens, you need to make an API call to create a user. Because FusionAuth requires a login identifier (either an email or a username) and a password, you'll have to provide those. Use long random values for these fields so they are unguessable. You'll be accessing the account via the Id. You also may want to save off the character name.

TODO create user call
- create user with random password and username and a user.data of { stubUser: true, characterName: 'dinesh' }.

## Saving The Id

After the stub profile is created, save the user account Id, which is a UUID. This value should be sent down to the user's device. You can store it as:

* the plaintext Id value
* a JSON Web Token (JWT) containing the Id
* an encrypted value

Which you decide depends on your use case. The security risk with the plaintext value is that anyone with can try different Id values to access information from another user. This may be an acceptable risk in low-value accounts.

An encrypted value ensures that no one can read the Id except the system which created it. This requires more effort and key management.

A JWT is a middle ground. It requires less effort than encrypting the Id, but eliminates the risk of account enumeration attacks. That is the approach this guide will take. 

After the user is created, you'll create a JWT signed with the default HMAC key with a single value, the user Id. 

TODO call to JWT vend with value { userId: ... } . The expiration time is 30 days. This should be tuned based on your user profile behavior. If it takes longer for a user to be willing to convert their account from a stub to a full account, extend the expiration time.

You can then store the JWT. You can do so in a persistent secure, `HTTPOnly` browser cookie, or, if the device is a mobile application, in a shared preferences file.

{% include _callout-note.liquid content="
You can also add more information to the JWT. Depending on how your application is architected, you may want to replicate the format of a JWT which would be generated by a full account login.
" %}

## Presenting The Token

Your client side application should then present the token representing the stub profile every time it interacts with your application to persist or read a preference. For instance, to save a simple hello world program `console.log("hello!");`, the server-side application below:

* reads the JWT from a cookie
* validates it (using the validate API)
* reads the Id
* retrieves the user information from the User API
* updates the user profile data with the simple hellow world program

This process needs to happen every time the stub user profile is updated. If you don't validate the JWT, you might as well use the plaintext option.

## Converting To A Full User

After a period of time, the user may want to convert to a full user profile. You can prompt them to do so based on time of game play or actions they've taken, encourage them to do so if they want to play across devices, or require them to do so to gain access to features or reminder. This logic is based on your application's needs. For the Pied Piper game, you are going to allow the user to convert to a full account by clicking a link any time they want to. TODO is that easiest/

The way to do this is to present them with an 'Upgrade account' page. This page should request their email address.

Then page will then call the User API to update the account's email and remove the randomly generated username. Tell the user they'll get an email to change their password as well.

Then send an email allowing them to reset their password.

TODO put in sample template, switching on `stubUser`.

Finally, update their user data to remove the `stubUser` data. TODO should we do this after they have changed their password? Id on't know if we know that (except in the enterprise events). Can't think of a better way to do this.

At this point, the user has a full fledged user account with a known login identifier and password, but also all of the profile data that they've provided.

## Limitations

This approach has some limitations:

* Stub users count as monthly active users when created. Any updates to a user will not count as an MAU.
* If a user removes the JWT or logs in from a different device, they will not have access to the stub profile.
* You may end up with a large number of stub accounts, depending on when you create them. You can run this search query to find stub accounts that have not been updated for 30 days. You may want to delete these accounts.
* You may want to set a cookie with the expiration time of the JWT in a javascript accessible cookie so that warning the user when their anonymous account expires is easy.

