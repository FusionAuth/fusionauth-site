---
layout: doc
title: WebAuthn
description: Integrating WebAuthn in FusionAuth as a developer.
navcategory: developer
---

include::docs/v1/tech/shared/_advanced-edition-blurb.adoc[]

== Overview

WebAuthn is a W3C https://www.w3.org/TR/webauthn-2/[specification] that defines an API to create and use public-key credentials in web applications that provides the ability for users to authenticate in their browser using the same method they use to unlock their device, like a biometric scan or PIN. WebAuthn has some big security benefits over the traditional username and password. Continue reading to learn how you can integrate WebAuthn with your FusionAuth instance. If you’re an administrator looking for details on configuring WebAuthn in your FusionAuth instance, check out the link:/docs/v1/tech/admin-guide/webauthn[WebAuthn Admin Guide].  If you want more information on the basics of WebAuthn and its security benefits, FusionAuth's link:/blog/2022/09/13/what-is-webauthn-why-do-you-care[WebAuthn blog post] is a good place to start.

[NOTE.note]
====
What about passkeys?

"Passkey" is the user-friendly term for WebAuthn credentials. Use this guide to integrate FusionAuth's WebAuthn systems with your application login to allow your users to log in with passkeys.
====

* <<Setting Up For WebAuthn>>
* <<Using the FusionAuth OAuth Interface>>
* <<Using the API Directly>>
* <<Workflows>>
* <<Client Guide>>

== Setting Up For WebAuthn
If you are planning to use WebAuthn, you have two options. The first option is the FusionAuth OAuth interface. FusionAuth’s OAuth interface is customizable via themes to make each of the web pages look like your application. The other option is using the WebAuthn API. Both approaches are covered in the sections below.

In either case, you should:

* Enable WebAuthn under the "WebAuthn" tab of the tenant configuration:
+
image::guides/webauthn/tenant-enable-webauthn.png[Enable WebAuthn,width=1200,role=shadowed]
* Enable one or more WebAuthn workflows on the tenant configuration:
+
image::guides/webauthn/tenant-enable-workflows.png[Enable Workflows,width=1200,role=shadowed]
* Add a user and register them with an application belonging to the tenant

The link:/docs/v1/tech/admin-guide/webauthn[WebAuthn Admin Guide] has more information on the tenant configuration options and overriding workflow availability per application.

== Using the FusionAuth OAuth Interface

[NOTE]
====
The FusionAuth OAuth Interface is also known as "hosted login pages" because FusionAuth hosts all the login pages.
====

Using the FusionAuth OAuth Interface will handle the client-side portion of WebAuthn ceremonies for you. This includes necessary data conversions between the FusionAuth APIs and the https://developer.mozilla.org/en-US/docs/Web/API/Web_Authentication_API[WebAuthn JavaScript API] as well as the WebAuth API call itself. There is no additional configuration required for this approach.

FusionAuth supports two WebAuthn workflows: re-authentication and bootstrap authentication.

=== Re-authentication

The re-authentication workflow is used to provide a streamlined user experience for repeated logins from the same device. FusionAuth will automatically prompt users to opt in to this workflow when it detects a compatible device. The next time the user is prompted to sign in, they will be redirected to a WebAuthn re-authentication page that lists available passkeys. The user can sign in by clicking a passkey in the list and completing the WebAuthn authentication ceremony.

==== Registration

After a successful login, users will automatically be redirected to prompt them to register or select a WebAuthn passkey for re-authentication if:

. The re-authentication workflow is enable
. FusionAuth detects a device suitable for re-authentication using the https://developer.mozilla.org/en-US/docs/Web/API/PublicKeyCredential/isUserVerifyingPlatformAuthenticatorAvailable[isUserVerifyingPlatformAuthenticatorAvailable()] JavaScript method

image::guides/webauthn/reauth-enable.png[Re-authentication Prompt,width=1200,role=shadowed]

The re-authentication prompt page lists a user's WebAuthn passkeys that meet the attachment and user verification requirements for the tenant configuration. It also has a section to register a new passkey for re-authentication. There are a few important notes about this page:

* The listed passkeys may have been registered with an authenticator that is not currently available (e.g. a removable security key)
* The listed passkeys may have been registered in another browser. Typically passkeys registered with a platform authenticator in one browser will not work in a different browser
* If the user tries to register a new passkey using the same authenticator as another of their passkeys, the registration ceremony will fail

The user is also presented with the option to skip selecting a re-authentication passkey. Checking the box before clicking the "Not now" button will set a browser cookie to skip prompting the user in the future.

The user can select a passkey from the list to complete a WebAuthn authentication ceremony and mark that passkey for re-authentication. Otherwise, they can enter a display name and complete a WebAuthn registration ceremony to generate a new passkey that will be marked for re-authentication. In either case, FusionAuth will set an encrypted browser cookie with the `fusionauth.webauthn-reauth.` prefix. The presence of one or more of these cookies signals to FusionAuth that it should redirect to the WebAuthn re-authentication page the next time a login page would be presented.

==== Authentication

When a user visits any of the hosted login pages, FusionAuth will check for a cookie with the `fusionauth.webauthn-reauth.` prefix. If such a cookie is detected, the user will be redirected to the WebAuthn re-authentication page.

image::guides/webauthn/reauth.png[Re-authentication Login,width=1200,role=bottom-cropped]

WebAuthn passkeys present in the encrypted browser cookies will be listed. A user can select which passkey and, by extension, account they would like to use for re-authentication. Clicking a passkey on the list will start the WebAuthn authentication ceremony. Only the selected passkey will be eligible to complete the re-authentication. Once the WebAuthn authentication ceremony has been completed successfully, the user will be authenticated.

The user also has the option to return to the normal login page by clicking the "Return to the normal login" link.

=== Bootstrap Authentication

The bootstrap workflow requires that the user "bootstrap" the WebAuthn authentication ceremony by providing identifying information such as a username or email address. You could think of this as a "manual" WebAuthn login as opposed to the re-authentication workflow where users are automatically prompted. Users can use any of their passkeys whose authenticator meets the attachment and user verification requirements to complete this authentication process.

==== Registration

If the re-authentication workflow is disabled for the tenant, users need another way to register passkeys for WebAuthn bootstrap authentication. Users can register and manage their own passkeys through link:/docs/v1/tech/account-management/[Self Service Account Management].

image::guides/webauthn/self-service.png[Passkey Self Service,width=1200,role=bottom-cropped]

Users can see a list of passkeys along with a button to delete each one. Below the list of registered passkeys is a button to add a new passkey. Passkey registration on this page will use authenticator attachment and user verification requirements designed to cover the broadest set of use cases. Depending on the tenant configuration, passkeys registered here may not be usable with any of the enabled WebAuthn workflows.

==== Authentication

If the bootstrap workflow is enabled, users will see a button to authenticate with "Fingerprint, device or key" on the main login page at `/oauth2/authorize`.

image::guides/webauthn/bootstrap-button.png[Bootstrap Login Button,width=1200,role=bottom-cropped]

When there is a re-authentication cookie cookie present in the browser, users will see a link just above the alternative login methods sections with the text "Return to passkey authentication." This link will take the user back to the re-authentication page.

Clicking the "Fingerprint, device or key" button will take the user to the WebAuthn bootstrap login page.

image::guides/webauthn/bootstrap-login.png[Bootstrap Login Page,width=1200,role=bottom-cropped]

The user must identify themselves with their username or email address and then click the "Submit" button to begin the WebAuthn authentication ceremony. They can use any of their registered passkeys whose authenticator meets the configured attachment and user verification requirements for the bootstrap workflow. Once the WebAuthn authentication ceremony has been completed successfully, the user will be authenticated.

== Using the API Directly

While using the FusionAuth OAuth interface works for many, you may need more control. You can use the WebAuthn API to register new passkeys and authenticate a user with a passkey. The link:/docs/v1/tech/apis/webauthn[WebAuthn API reference docs] cover each of the API calls, but this guide will walk you through an implementation.

There are a couple of reasons you might choose this method of integration.

* You can customize every part of the user login experience
* You can use a different method to track re-authentication passkey availability

When using this option, you must set up an link:/docs/v1/tech/apis/authentication[API key] with the appropriate permissions. The minimum level of privilege required is the `POST` permission to the `/api/webauthn/start` and `/api/webauthn/register/start` endpoints.

The WebAuthn registration and authentication ceremonies both have a similar set of steps.

. Start the WebAuthn ceremony via an API call to FusionAuth
. Transform the API response containing the options for the ceremony
. Invoke the https://developer.mozilla.org/en-US/docs/Web/API/Web_Authentication_API[WebAuthn JavaScript API] in the browser using the transformed options
. Transform the authenticator response to prevent issues during network transport
. Include the transformed response in an API call to FusionAuth to complete the ceremony

The registration and authentication ceremonies are covered in their own sections below.

=== Registration

Use the WebAuthn registration ceremony to create a new passkey for a user.

==== Starting the registration

You start a WebAuthn registration by calling the link:/docs/v1/tech/apis/webauthn#start-a-webauthn-passkey-registration[`/api/webauthn/register/start`] endpoint.

[source,shell]
.Start WebAuthn Registration API call
----
API_KEY=...
REQUEST_PAYLOAD='{...}'
curl  -H "Content-type: application/json" -H "Authorization: $API_KEY" https://local.fusionauth.io/api/webauthn/register/start -d $REQUEST_PAYLOAD
----

Here's an example request payload:

[source,json]
.Start WebAuthn Registration Request JSON
----
include::docs/src/json/webauthn/register-start-request.json[]
----

The call to link:/docs/v1/tech/apis/webauthn#start-a-webauthn-passkey-registration[`/api/webauthn/register/start`] begins the registration ceremony and returns a response with options for the https://developer.mozilla.org/en-US/docs/Web/API/Web_Authentication_API[WebAuthn JavaScript API], including a one-time challenge specific to this ceremony:

[source,json]
.Start WebAuthn Registration Response JSON
----
include::docs/src/json/webauthn/register-start-response.json[]
----

==== Transform the options response

Certain fields on the link:/docs/v1/tech/apis/webauthn#start-a-webauthn-passkey-registration[`/api/webauthn/register/start`] response are returned as base64url-encoded strings. These have to be translated to JavaScript https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer[``ArrayBuffer``]s before being passed to the https://developer.mozilla.org/en-US/docs/Web/API/Web_Authentication_API[WebAuthn JavaScript API]. The response should be left as-is other than the transformations for these particular fields.

The following response fields need to be converted to ``ArrayBuffer``s if they are present:

* [field]#options.challenge#
* [field]#options.excludeCredentials[x].id#
* [field]#options.user.id#

See the link:/docs/v1/tech/apis/webauthn#start-a-webauthn-passkey-registration[`/api/webauthn/register/start`] response body section for more details.

You can use the following JavaScript function to perform the conversion:

[source,javascript]
.Function to convert a base64url-encoded string to an `ArrayBuffer`
----
include::docs/src/webauthn/base64url-to-buffer.js[]
----

The following is an ES6 JavaScript snippet to convert the API response to the object that is passed to the https://developer.mozilla.org/en-US/docs/Web/API/Web_Authentication_API[WebAuthn JavaScript API]. In the following example `options` is the value of [field]#response.options#, and `creationOptions` is the object that is passed to the WebAuthn JavaScript API's `navigator.credentials.create()` function.

[source,javascript]
.Transform API response for WebAuthn JavaScript API
----
const creationOptions = {
    // publicKey indicates this is for WebAuthn
    publicKey: {
        ...options,
        challenge: base64URLToBuffer(options.challenge),
        excludeCredentials: options.excludeCredentials?.map(c => {
            return {
                ...c,
                id: base64URLToBuffer(c.id)
            }
        }) ?? [],
        user: {
            ...options.user,
            id: base64URLToBuffer(options.user.id)
        }
    }
};
----

==== Invoke the WebAuthn JavaScript API

Invoke https://developer.mozilla.org/en-US/docs/Web/API/CredentialsContainer/create[``navigator.credentials.create()``] on the WebAuthn JavaScript API, passing the transformed FusionAuth API response (`creationOptions` in the snippet above) as a parameter.

The function returns a https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise[Promise] that resolves with a https://developer.mozilla.org/en-US/docs/Web/API/PublicKeyCredential[``PublicKeyCredential``]. Reference MDN documentation or the WebAuth https://www.w3.org/TR/webauthn-2/[specification] for details.

==== Transform the authenticator response

Certain fields on the https://developer.mozilla.org/en-US/docs/Web/API/PublicKeyCredential[``PublicKeyCredential``] response from the https://developer.mozilla.org/en-US/docs/Web/API/CredentialsContainer/create[``navigator.credentials.create()``] WebAuthn JavaScript API call need to be transformed from https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer[``ArrayBuffer``]s to base64url-encoded strings for transport over the network.

The following response fields need to be converted from ``ArrayBuffer``s to base64url-encoded strings if they are present where [field]#credential# refers to the `PublicKeyCredential` returned by the `navigator.credentials.create()` call:

* [field]#credential.response.attestationObject#
* [field]#credential.response.clientDataJSON#

See the link:/docs/v1/tech/apis/webauthn#complete-a-webauthn-passkey-registration[`/api/webauthn/register/complete`] request body section for more details.

You can use the following JavaScript function to perform the conversion:

[source,javascript]
.Function to convert an `ArrayBuffer` to a base64url-encoded string
----
include::docs/src/webauthn/buffer-to-base64url.js[]
----

You should also use convenience methods on the `PublicKeyCredential` and its [field]#response# field to extract information on transports supported by the authenticator and any requested client extension results. The [field]#response# field contains an https://developer.mozilla.org/en-US/docs/Web/API/AuthenticatorAttestationResponse[``AuthenticatorAttestationResponse``] object after a successful call to `navigator.credentials.create()`. The following is an ES6 JavaScript snippet to convert the `PublicKeyCredential` to a suitable format for the FusionAuth link:/docs/v1/tech/apis/webauthn#complete-a-webauthn-passkey-registration[`/api/webauthn/register/complete`] API call. In the following example, `credential` is the `PublicKeyCredential` object returned by the WebAuthn JavaScript API's `navigator.credentials.create()` function, and `transformedCredential` is the object that will be included in the [field]#credential# field on the FusionAuth link:/docs/v1/tech/apis/webauthn#complete-a-webauthn-passkey-registration[`/api/webauthn/register/complete`] API request.

[source,javascript]
.Transform WebAuthn JavaScript API response for FusionAuth API request
----
const transformedCredential = {
    id: credential.id,
    response: {
      attestationObject: bufferToBase64URL(credential.response.attestationObject),
      clientDataJSON: bufferToBase64URL(credential.response.clientDataJSON)
    },
    type: credential.type,
    clientExtensionResults: credential.getClientExtensionResults(),
    transports: typeof credential.response.getTransports === 'undefined' ? [] : credential.response.getTransports()
};
----

==== Completing the registration

You complete a WebAuthn registration by calling the link:/docs/v1/tech/apis/webauthn#complete-a-webauthn-passkey-registration[`/api/webauthn/register/complete`] endpoint.

[source,shell]
.Complete WebAuthn Registration API call
----
REQUEST_PAYLOAD='{...}'
curl  -H "Content-type: application/json" https://local.fusionauth.io/api/webauthn/register/complete -d $REQUEST_PAYLOAD
----

Here's an example request payload where [field]#credential# is the `transformedCredential` from the snippet above:

[source,json]
.Complete WebAuthn Registration Request JSON
----
include::docs/src/json/webauthn/register-complete-request.json[]
----

The call to link:/docs/v1/tech/apis/webauthn#complete-a-webauthn-passkey-registration[`/api/webauthn/register/complete`] completes the registration ceremony by validating the request against the WebAuthn https://www.w3.org/TR/webauthn-2/[specification], extracting the public key, and associating the new passkey with the user. This API returns the new WebAuthn passkey registered for the user.

[source,json]
.Complete WebAuthn Registration Response JSON
----
include::docs/src/json/webauthn/response.json[]
----


== Workflows


== Client Guide

