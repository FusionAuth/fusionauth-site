# This is workflow for checking links
name: linkcheck_website
on: 
  # run two times a weekday 
  schedule:
    - cron: '31 18 * * 1-5'
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  check_links:
    runs-on: ubuntu-latest
    steps:
      # linkcheck
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
      - uses: filiph/linkcheck@f2c15a0be0d9c83def5df3edcc0f2d6582845f2d # 3.0.0
        with:
          arguments: https://fatest.ngrok.dev/test2.html -e --connection-failures-as-warnings -d 2>&1 | tee linkcheckoutput.txt
        name: linkcheck
      # check for webflow links
      - name: Validate linkcheck results
        run: |
          set -e

          echo "Validating linkcheck results..."

          # ---- Extract stats ----
          warnings=$(awk '/warnings/ {print $1}' linkcheckoutput.txt | tail -n 1)
          errors=$(awk '/errors/ {print $1}' linkcheckoutput.txt | tail -n 1)

          warnings=${warnings:-0}
          errors=${errors:-0}

          # ---- Check for forbidden domains ----
          webflow_count=$(grep -c "fusionauth.webflow.io" linkcheckoutput.txt || true)

          # ---- Summary ----
          echo ""
          echo "Linkcheck summary:"
          echo "  warnings: $warnings"
          echo "  errors:   $errors"
          echo "  forbidden webflow links: $webflow_count"
          echo ""

          failed=false

          if [ "$warnings" -gt 0 ]; then
            echo "Warnings detected"
            failed=true
          fi

          if [ "$errors" -gt 0 ]; then
            echo "Errors detected"
            failed=true
          fi

          if [ "$webflow_count" -gt 0 ]; then
            echo "fusionauth.webflow.io references found:"
            grep "fusionauth.webflow.io" linkcheckoutput.txt || true
            failed=true
          fi

          if [ "$failed" = true ]; then
            echo ""
            echo "Linkcheck validation failed"
            exit 1
          fi

          echo "Linkcheck validation passed"
  send_mail_on_failure:
    needs: check_links
    runs-on: ubuntu-latest
    if: ${{ failure() }}
    steps:
      - uses: dawidd6/action-send-mail@4226df7daafa6fc901a43789c49bf7ab309066e7 # v3
        with:
          server_address: ${{secrets.MAIL_HOST}}
          server_port: ${{secrets.MAIL_PORT}}
          username: ${{secrets.MAIL_USERNAME}}
          password: ${{secrets.MAIL_PASSWORD}}
          subject: Failed linkcheck2
          to: ${{secrets.WEBSITE_SLACK_CHANNEL_NOTIFICATION_EMAIL}}
          from: FusionAuth GitHub Actions <noreply@fusionauth.io>
          body: "Linkcheck failed, https://github.com/FusionAuth/fusionauth-site/actions/workflows/linkcheck.yml has more."
